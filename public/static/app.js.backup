// ì• í”Œë¦¬ì¼€ì´ì…˜ ìƒíƒœ ê´€ë¦¬ ê°ì²´
const AppState = {
    currentPage: 'dashboard',
    dashboardData: null,
    processes: [],
    workers: [],
    teamProcessMapping: {},
    charts: {
        testStatus: null,
        avgScore: null,
        assessment: null
    },
    
    // ìƒíƒœ ì´ˆê¸°í™” (í…ŒìŠ¤íŠ¸ìš©)
    reset() {
        this.currentPage = 'dashboard';
        this.dashboardData = null;
        this.processes = [];
        this.workers = [];
        this.teamProcessMapping = {};
        this.charts = {
            testStatus: null,
            avgScore: null,
            assessment: null
        };
    },
    
    // Getter ë©”ì„œë“œ
    getCurrentPage() { return this.currentPage; },
    getDashboardData() { return this.dashboardData; },
    getProcesses() { return this.processes; },
    getWorkers() { return this.workers; },
    getTeamProcessMapping() { return this.teamProcessMapping; },
    getChart(name) { return this.charts[name]; },
    
    // Setter ë©”ì„œë“œ
    setCurrentPage(page) { this.currentPage = page; },
    setDashboardData(data) { this.dashboardData = data; },
    setProcesses(processes) { this.processes = processes; },
    setWorkers(workers) { this.workers = workers; },
    setTeamProcessMapping(mapping) { this.teamProcessMapping = mapping; },
    setChart(name, chart) { this.charts[name] = chart; }
};

// í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ„í•œ ì „ì—­ ë³€ìˆ˜ (ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ìš©)
let currentPage = AppState.currentPage;
let dashboardData = AppState.dashboardData;
let processes = AppState.processes;
let workers = AppState.workers;

// ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜: Excel ë‚ ì§œë¥¼ ISO í˜•ì‹ìœ¼ë¡œ ë³€í™˜
function convertExcelDate(dateValue) {
    if (!dateValue) return '';
    
    if (dateValue instanceof Date) {
        return dateValue.toISOString().split('T')[0];
    }
    
    if (typeof dateValue === 'number') {
        // Excel ë‚ ì§œ ì‹œë¦¬ì–¼ ë²ˆí˜¸ë¥¼ JavaScript Dateë¡œ ë³€í™˜
        const excelEpoch = new Date(1899, 11, 30);
        const jsDate = new Date(excelEpoch.getTime() + dateValue * 86400000);
        return jsDate.toISOString().split('T')[0];
    }
    
    return String(dateValue);
}

// Excel ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜
function convertLevelToResult(level) {
    if (level === null || level === undefined) {
        return 'N/A';
    }
    return level >= ASSESSMENT_LEVEL.SATISFACTORY_THRESHOLD ? 'ë§Œì¡±' : 'ë¶ˆë§Œì¡±';
}

function applyExcelHeaderStyle(worksheet, useYellowBg = false) {
    const range = XLSX.utils.decode_range(worksheet['!ref']);
    const bgColor = useYellowBg ? EXCEL_COLORS.HEADER_BG_YELLOW : EXCEL_COLORS.HEADER_BG;
    const textColor = useYellowBg ? EXCEL_COLORS.HEADER_TEXT_BLACK : EXCEL_COLORS.HEADER_TEXT;
    
    for (let col = range.s.c; col <= range.e.c; col++) {
        const cellAddress = XLSX.utils.encode_cell({ r: 0, c: col });
        if (!worksheet[cellAddress]) continue;
        
        worksheet[cellAddress].s = {
            font: { bold: true, color: { rgb: textColor }, sz: 12 },
            fill: { fgColor: { rgb: bgColor } },
            alignment: { horizontal: "center", vertical: "center" },
            border: {
                top: { style: "thin", color: { rgb: EXCEL_COLORS.BORDER } },
                bottom: { style: "thin", color: { rgb: EXCEL_COLORS.BORDER } },
                left: { style: "thin", color: { rgb: EXCEL_COLORS.BORDER } },
                right: { style: "thin", color: { rgb: EXCEL_COLORS.BORDER } }
            }
        };
    }
}

function applyCellColorByValue(worksheet, rowIndex, colIndex, value, passKeyword, failKeyword) {
    const cellAddress = XLSX.utils.encode_cell({ r: rowIndex, c: colIndex });
    if (!worksheet[cellAddress] || !worksheet[cellAddress].s) return;
    
    if (value === passKeyword) {
        worksheet[cellAddress].s.fill = { fgColor: { rgb: EXCEL_COLORS.PASS_BG } };
        worksheet[cellAddress].s.font = { color: { rgb: EXCEL_COLORS.PASS_TEXT }, bold: true };
    } else if (value === failKeyword) {
        worksheet[cellAddress].s.fill = { fgColor: { rgb: EXCEL_COLORS.FAIL_BG } };
        worksheet[cellAddress].s.font = { color: { rgb: EXCEL_COLORS.FAIL_TEXT }, bold: true };
    }
}

function createExcelWorkbook(data, sheetName, columnWidths) {
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = columnWidths;
    applyExcelHeaderStyle(ws);
    
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, sheetName);
    return { workbook: wb, worksheet: ws };
}

// ì°¨íŠ¸ ê³µí†µ ì„¤ì •
const CHART_DEFAULTS = {
    responsive: true,
    maintainAspectRatio: true
};

const CHART_SCALE_DEFAULTS = {
    y: {
        beginAtZero: true,
        ticks: {
            stepSize: 1
        }
    }
};

// Excel ìŠ¤íƒ€ì¼ ìƒìˆ˜
const EXCEL_COLORS = {
    HEADER_BG: "70AD47",
    HEADER_BG_YELLOW: "FFFF00",
    HEADER_TEXT: "FFFFFF",
    HEADER_TEXT_BLACK: "000000",
    PASS_BG: "C6EFCE",
    PASS_TEXT: "006100",
    FAIL_BG: "FFC7CE",
    FAIL_TEXT: "9C0006",
    BORDER: "000000",
    BORDER_LIGHT: "D3D3D3"
};

const EXCEL_COLUMN_WIDTHS = {
    NO: 6,
    EMPLOYEE_ID: 12,
    NAME: 15,
    ENTITY: 10,
    TEAM: 20,
    POSITION: 15,
    CATEGORY: 20,
    LEVEL_CATEGORY: 15,
    ITEM_NAME: 50,
    ITEM_NAME_SHORT: 25,
    LEVEL: 12,
    RESULT: 12,
    DATE: 15
};

// í‰ê°€ ë ˆë²¨ ì„ê³„ê°’
const ASSESSMENT_LEVEL = {
    SATISFACTORY_THRESHOLD: 3  // level >= 3 ì´ë©´ ë§Œì¡±
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
document.addEventListener('DOMContentLoaded', () => {
    loadProcesses();
    loadWorkers();
    showPage('dashboard');
});

// í˜ì´ì§€ ì „í™˜
function showPage(pageName) {
    currentPage = pageName;
    const app = document.getElementById('app');
    
    switch(pageName) {
        case 'dashboard':
            app.innerHTML = getDashboardHTML();
            loadDashboard();
            break;
        case 'quiz-upload':
            app.innerHTML = getQuizUploadHTML();
            loadQuizUploadPage();
            break;
        case 'assessment-upload':
            app.innerHTML = getAssessmentUploadHTML();
            loadAssessmentUploadPage();
            break;
        case 'worker-upload':
            app.innerHTML = getWorkerUploadHTML();
            loadWorkerUploadPage();
            break;
        case 'supervisor-assessment':
            app.innerHTML = getSupervisorAssessmentHTML();
            loadSupervisorAssessmentPage();
            break;
        case 'test-page':
            app.innerHTML = getTestPageHTML();
            loadTestPage();
            break;
        case 'analysis-page':
            showAnalysisPage();
            break;
        case 'result-management':
            app.innerHTML = getResultManagementHTML();
            loadResultManagementPage();
            break;
    }
}

// í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ë¡œë“œ
async function loadProcesses() {
    try {
        const response = await axios.get('/api/processes');
        processes = response.data;
        
        // ì§€ì •ëœ ìˆœì„œëŒ€ë¡œ ì •ë ¬
        const order = [
            'Material Handling',
            'Cutting',
            'Beveling',
            'Bending',
            'LS Welding',
            'Fit Up',
            'CS Welding',
            'VTMT',
            'Bracket FU',
            'Bracket Weld',
            'UT repair',
            'DF FU',
            'DF Weld',
            'Flatness',
            'Drilling',
            'Blasting',
            'Metalizing',
            'Paint',
            'Mechanical',
            'Electrical',
            'Paint ring',
            'Material Handler_IM',
            'EHS',
            'IM_Mounting Final (QIF)',
            'WH_Kitset',
            'TRANSPORTATION',
            'MAINTENANCE'
        ];
        
        processes.sort((a, b) => {
            const indexA = order.indexOf(a.name);
            const indexB = order.indexOf(b.name);
            
            // ìˆœì„œì— ì—†ëŠ” í•­ëª©ì€ ë§¨ ë’¤ë¡œ
            if (indexA === -1 && indexB === -1) return 0;
            if (indexA === -1) return 1;
            if (indexB === -1) return -1;
            
            return indexA - indexB;
        });
    } catch (error) {
        console.error('í”„ë¡œì„¸ìŠ¤ ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

// ì‘ì—…ì ëª©ë¡ ë¡œë“œ
async function loadWorkers() {
    try {
        const response = await axios.get('/api/workers');
        workers = response.data;
    } catch (error) {
        console.error('ì‘ì—…ì ë¡œë“œ ì‹¤íŒ¨:', error);
    }
}

// ==================== ëŒ€ì‹œë³´ë“œ í˜ì´ì§€ ====================

function getDashboardHTML() {
    return `
        <div class="space-y-6">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-3xl font-bold text-gray-800">
                    <i class="fas fa-chart-bar mr-2"></i>
                    Skill Level í‰ê°€ ìš”ì•½
                </h2>
                
                <div class="w-64">
                    <label class="block text-gray-700 font-semibold mb-2">ë²•ì¸ ì„ íƒ</label>
                    <select id="dashboard-entity-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterDashboardByEntity()">
                        <option value="">ì „ì²´ ë²•ì¸</option>
                        <option value="CSVN">CSVN</option>
                        <option value="CSCN">CSCN</option>
                        <option value="CSTW">CSTW</option>
                    </select>
                </div>
            </div>
            
            <!-- ìš”ì•½ ì¹´ë“œ -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">ì „ì²´ ì‘ì—…ì ìˆ˜</p>
                            <p id="total-workers" class="text-3xl font-bold text-blue-600">-</p>
                        </div>
                        <i class="fas fa-users text-4xl text-blue-200"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Written Test ì‘ì‹œì</p>
                            <p id="test-takers" class="text-3xl font-bold text-green-600">-</p>
                        </div>
                        <i class="fas fa-clipboard-list text-4xl text-green-200"></i>
                    </div>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-gray-500 text-sm">Written Test í•©ê²©ì</p>
                            <p id="test-passed" class="text-3xl font-bold text-purple-600">-</p>
                        </div>
                        <i class="fas fa-check-circle text-4xl text-purple-200"></i>
                    </div>
                </div>
            </div>
            
            <!-- Written Test í˜„í™© ì°¨íŠ¸ -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-chart-bar mr-2"></i>
                        í”„ë¡œì„¸ìŠ¤ë³„ Written Test í˜„í™©
                    </h3>
                    <canvas id="test-status-chart"></canvas>
                </div>
                
                <div class="bg-white rounded-lg shadow-md p-6">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-chart-column mr-2"></i>
                            WRITTEN TEST [í‰ê· ì ìˆ˜]
                        </h3>
                        <div class="flex gap-2">
                            <div class="w-36">
                                <select id="avg-score-team-select" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" onchange="onAvgScoreTeamChange()">
                                    <option value="">ì „ì²´ íŒ€</option>
                                </select>
                            </div>
                            <div class="w-36">
                                <select id="avg-score-process-select" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" onchange="filterAvgScoreChart()">
                                    <option value="">ì „ì²´ í”„ë¡œì„¸ìŠ¤</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    <canvas id="avg-score-chart"></canvas>
                </div>
            </div>
            
            <!-- Supervisor Assessment í˜„í™© -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold text-gray-800">
                        <i class="fas fa-star mr-2"></i>
                        Levelë³„ ë²•ì¸ í˜„í™© (Supervisor Assessment)
                    </h3>
                    <div class="flex gap-2">
                        <div class="w-36">
                            <select id="assessment-team-select" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" onchange="onAssessmentTeamChange()">
                                <option value="">ì „ì²´ íŒ€</option>
                            </select>
                        </div>
                        <div class="w-36">
                            <select id="assessment-process-select" class="w-full px-2 py-1.5 text-xs border border-gray-300 rounded focus:ring-2 focus:ring-blue-500" onchange="filterAssessmentChart()">
                                <option value="">ì „ì²´ í”„ë¡œì„¸ìŠ¤</option>
                            </select>
                        </div>
                    </div>
                </div>
                <canvas id="assessment-chart"></canvas>
            </div>
        </div>
    `;
}

// ë ˆê±°ì‹œ ì „ì—­ ë³€ìˆ˜ (AppStateë¡œ ì ì§„ì  ë§ˆì´ê·¸ë ˆì´ì…˜ ì˜ˆì •)
let allDashboardData = null;
let currentTestStatusChart = null;
let currentAvgScoreChart = null;
let currentAssessmentChart = null;
let teamProcessMapping = {};

async function loadDashboard() {
    try {
        const response = await axios.get('/api/dashboard/stats');
        allDashboardData = response.data;
        dashboardData = response.data;
        
        // í…ŒìŠ¤íŠ¸ ê²°ê³¼ê°€ ìˆëŠ” íŒ€ ëª©ë¡ë§Œ ê°€ì ¸ì˜¤ê¸°
        const teamsResponse = await axios.get('/api/teams');
        const teams = teamsResponse.data;
        
        // íŒ€-í”„ë¡œì„¸ìŠ¤ ë§¤í•‘ì„ ìœ„í•´ ì‘ì—…ì ì •ë³´ ê°€ì ¸ì˜¤ê¸°
        const workersResponse = await axios.get('/api/workers');
        const workers = workersResponse.data;
        
        // íŒ€ë³„ë¡œ ì‚¬ìš©í•˜ëŠ” í”„ë¡œì„¸ìŠ¤(position) ë§¤í•‘ ìƒì„±
        teamProcessMapping = {};
        workers.forEach(worker => {
            if (worker.team && worker.position) {
                if (!teamProcessMapping[worker.team]) {
                    teamProcessMapping[worker.team] = new Set();
                }
                // positionì„ í”„ë¡œì„¸ìŠ¤ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘
                const processName = mapPositionToProcess(worker.position);
                if (processName) {
                    teamProcessMapping[worker.team].add(processName);
                }
            }
        });
        
        // Setì„ ë°°ì—´ë¡œ ë³€í™˜
        Object.keys(teamProcessMapping).forEach(team => {
            teamProcessMapping[team] = Array.from(teamProcessMapping[team]);
        });
        
        // íŒ€ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì±„ìš°ê¸°
        if (teams.length > 0) {
            populateTeamSelect('avg-score-team-select', teams);
            populateTeamSelect('assessment-team-select', teams);
        }
        
        // ì´ˆê¸° í”„ë¡œì„¸ìŠ¤ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì±„ìš°ê¸° (ì „ì²´ í”„ë¡œì„¸ìŠ¤)
        updateProcessSelectForTeam('avg-score', null);
        updateProcessSelectForTeam('assessment', null);
        
        // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
        updateDashboardStats();
        
        // ì°¨íŠ¸ ë Œë”ë§
        renderTestStatusChart();
        renderAvgScoreChart();
        renderAssessmentChart();
    } catch (error) {
        console.error('ëŒ€ì‹œë³´ë“œ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ëŒ€ì‹œë³´ë“œ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Position â†’ Process ë§¤í•‘ í…Œì´ë¸” (í™•ì¥ ìš©ì´)
const POSITION_TO_PROCESS_MAP = [
    { keywords: ['cutting', 'cnc'], process: 'Cutting' },
    { keywords: ['bevel'], process: 'Beveling' },
    { keywords: ['bend'], process: 'Bending' },
    { keywords: ['ls', 'weld'], process: 'LS Welding', requireAll: true },
    { keywords: ['fit', 'up'], process: 'Fit Up', requireAll: true },
    { keywords: ['cs', 'weld'], process: 'CS Welding', requireAll: true },
    { keywords: ['vtmt'], process: 'VTMT' },
    { keywords: ['bracket', 'fu'], process: 'Bracket FU', requireAll: true },
    { keywords: ['bracket', 'weld'], process: 'Bracket Weld', requireAll: true },
    { keywords: ['ut', 'repair'], process: 'UT repair', requireAll: true },
    { keywords: ['df', 'fu'], process: 'DF FU', requireAll: true },
    { keywords: ['df', 'weld'], process: 'DF Weld', requireAll: true },
    { keywords: ['flatness'], process: 'Flatness' }
];

/**
 * Team-Process ë§¤í•‘ í…Œì´ë¸” (ì—‘ì…€ ë°ì´í„° ê¸°ë°˜)
 * ê° íŒ€ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì„¸ìŠ¤ ëª©ë¡
 */
// Assessment ì „ìš© í”„ë¡œì„¸ìŠ¤ ëª©ë¡ (ëŒ€ë¬¸ì í‘œì¤€í™”)
// Quiz ì „ìš© í”„ë¡œì„¸ìŠ¤ ì œì™¸: Blasting, Metalizing, Paint, Mechanical, Electrical
const TEAM_PROCESS_MAP = {
    'BLACK TOWER': [
        'MATERIAL HANDLING',
        'CUTTING',
        'BEVELING',
        'BENDING',
        'LS WELDING',
        'FIT UP',
        'CS WELDING',
        'VTMT',
        'BRACKET FU',
        'BRACKET WELD',
        'UT REPAIR',
        'DOOR FRAME FU',
        'DOOR FRAME WELD',
        'FLATNESS',
        'DRILLING'
    ],
    'WHITE TOWER': [
        'PAINT RING'
    ],
    'INTERNAL MOUNTING': [
        'MATERIAL HANDLER-IM'
    ],
    'LEAN': [
        'EHS'
    ],
    'QM': [
        'QC INSPECTOR-IM FINAL (QIF)'
    ],
    'WAREHOUSE': [
        'WAREHOUSE-KITSET'
    ],
    'TRANSPORTATION': [
        'TRANSPORTATION'
    ],
    'MAINTENANCE': [
        'MAINTENANCE'
    ]
};

/**
 * í‘œì¤€ TEAM ìˆœì„œ
 */
const STANDARD_TEAM_ORDER = [
    'BLACK TOWER',
    'WHITE TOWER',
    'INTERNAL MOUNTING',
    'QM',
    'TRANSPORTATION',
    'MAINTENANCE',
    'WAREHOUSE',
    'LEAN'
];

/**
 * í‘œì¤€ POSITION ìˆœì„œ (íŒ€ë³„)
 */
const STANDARD_POSITION_ORDER = [
    // BLACK TOWER
    'MATERIAL HANDLING',
    'CUTTING',
    'BEVELLING',
    'BENDING',
    'LS WELDING',
    'FIT UP',
    'CS WELDING',
    'VTMT',
    'BRACKET FU',
    'BRACKET WELD',
    'UT REPAIR',
    'DOOR FRAME FU',
    'DOOR FRAME WELD',
    'FLATNESS',
    'DRILLING & TAPPING',
    // WHITE TOWER
    'BLASTING',
    'METALIZING',
    'PAINTING',
    'PAINTING REPAIR',
    'FITTING PAINT RING',
    // INTERNAL MOUNTING
    'ASSEMBLY',
    'IM CABLE',
    'GT CLEANING',
    'MATERIAL HANDLER-IM',
    'PAINT TOUCH UP',
    // QM
    'QC INSPECTOR - BT MT/PT(QBP)',
    'QC INSPECTOR - BT UT/PAUT(QBU)',
    'QC INSPECTOR - BT VT(QBV)',
    'QC INSPECTOR - DELIVERY INSPECTOR(QDI)',
    'QC INSPECTOR-IM FINAL (QIF)',
    'QC INSPECTOR-IM INCOMING(QII)',
    'QC INSPECTOR - WT MATELIZING(QMI)',
    'QC INSPECTOR - WT WASHING&BLASTING(QWM)',
    'QC INSPECTOR - WT PAINTING(QWP)',
    'QC INSPECTOR-BT FITUP&WELDING(QBF)',
    'QC INSPECTOR-BT DIMENSION(QBD)',
    'QC INSPECTOR-BT INCOMING TO BENDING',
    'QC INSPECTOR-BT INCOMING(QBI)',
    'QC INSPECTOR - BT MT/PT(QBLACK TOWER)',
    // TRANSPORTATION
    'TRANSPORTATION',
    'STORAGE FIT INSTALLATION',
    'H-FRAME INSTALLATION',
    'TEQ',
    // MAINTENANCE
    'ELECTRICIAN/MECHANIC',
    // WAREHOUSE
    'WAREHOUSE-KITSET',
    'WAREHOUSE BT/WT',
    'WAREHOUSE-IM',
    // LEAN
    'KAIZEN',
    'EHS'
];

/**
 * Quizìš© POSITION ìˆœì„œ (18ê°œë§Œ)
 */
const QUIZ_POSITION_ORDER = [
    'CUTTING',
    'BEVELLING',
    'BENDING',
    'LS WELDING',
    'FIT UP',
    'CS WELDING',
    'VTMT',
    'BRACKET FU',
    'BRACKET WELD',
    'UT REPAIR',
    'DOOR FRAME FU',
    'DOOR FRAME WELD',
    'FLATNESS',
    'BLASTING',
    'METALIZING',
    'PAINTING',
    'ASSEMBLY',
    'IM CABLE'
];

/**
 * íŒ€ ì´ë¦„ ì •ê·œí™” (ëŒ€ë¬¸ì + ê³µë°± ì²˜ë¦¬)
 * @param {string} team - íŒ€ ì´ë¦„
 * @returns {string} ì •ê·œí™”ëœ íŒ€ ì´ë¦„
 */
function normalizeTeamName(team) {
    if (!team) return '';
    return team.toUpperCase().trim();
}

/**
 * íŒ€ ì´ë¦„ì„ ë³´ê¸° ì¢‹ê²Œ í‘œì‹œ (ê° ë‹¨ì–´ ì²« ê¸€ì ëŒ€ë¬¸ì)
 * @param {string} team - íŒ€ ì´ë¦„
 * @returns {string} í¬ë§·ëœ íŒ€ ì´ë¦„
 */
function formatTeamName(team) {
    if (!team) return '';
    return team.split(' ').map(word => 
        word.charAt(0).toUpperCase() + word.slice(1).toLowerCase()
    ).join(' ');
}

/**
 * íŠ¹ì • íŒ€ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ë°˜í™˜
 * @param {string} team - íŒ€ ì´ë¦„
 * @returns {string[]} í”„ë¡œì„¸ìŠ¤ ëª©ë¡
 */
function getProcessesForTeam(team) {
    const normalizedTeam = normalizeTeamName(team);
    const processes = TEAM_PROCESS_MAP[normalizedTeam] || [];
    console.log(`ğŸ” getProcessesForTeam("${team}") â†’ normalized: "${normalizedTeam}" â†’ processes: ${processes.length}ê°œ`, processes);
    return processes;
}

/**
 * position ë¬¸ìì—´ì„ í”„ë¡œì„¸ìŠ¤ ì´ë¦„ìœ¼ë¡œ ë§¤í•‘ (í•˜ìœ„ í˜¸í™˜ì„± ìœ ì§€)
 * @param {string} position - ì‘ì—…ì ì§ì±…/ìœ„ì¹˜
 * @returns {string|null} ë§¤í•‘ëœ í”„ë¡œì„¸ìŠ¤ ì´ë¦„ ë˜ëŠ” null
 */
function mapPositionToProcess(position) {
    if (!position) return null;
    
    const positionLower = position.toLowerCase().trim();
    
    for (const mapping of POSITION_TO_PROCESS_MAP) {
        const { keywords, process, requireAll = false } = mapping;
        
        const matchFn = requireAll
            ? keywords.every(kw => positionLower.includes(kw))
            : keywords.some(kw => positionLower.includes(kw));
        
        if (matchFn) {
            return process;
        }
    }
    
    return null;
}

/**
 * ì…€ë ‰íŠ¸ ë°•ìŠ¤ì— íŒ€ ì˜µì…˜ ì±„ìš°ê¸° (í—¬í¼ í•¨ìˆ˜)
 * @param {string} selectId - ì…€ë ‰íŠ¸ ì—˜ë¦¬ë¨¼íŠ¸ ID
 * @param {string[]} teams - íŒ€ ëª©ë¡ ë°°ì—´
 */
function populateTeamSelect(selectId, teams) {
    const selectElement = document.getElementById(selectId);
    if (!selectElement) return;
    
    selectElement.innerHTML = '<option value="">ì „ì²´ íŒ€</option>';
    teams.forEach(team => {
        const option = document.createElement('option');
        option.value = team;
        option.textContent = team;
        selectElement.appendChild(option);
    });
}

// íŒ€ ì„ íƒì— ë”°ë¼ í”„ë¡œì„¸ìŠ¤ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
function updateProcessSelectForTeam(chartType, selectedTeam) {
    const processSelectId = chartType === 'avg-score' ? 'avg-score-process-select' : 'assessment-process-select';
    const processSelect = document.getElementById(processSelectId);
    
    if (!processSelect) return;
    
    processSelect.innerHTML = '<option value="">ì „ì²´ í”„ë¡œì„¸ìŠ¤</option>';
    
    if (selectedTeam && teamProcessMapping[selectedTeam]) {
        // ì„ íƒëœ íŒ€ì˜ í”„ë¡œì„¸ìŠ¤ë§Œ í‘œì‹œ
        const teamProcesses = teamProcessMapping[selectedTeam];
        processes.forEach(process => {
            if (teamProcesses.includes(process.name)) {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = process.name;
                processSelect.appendChild(option);
            }
        });
    } else {
        // ì „ì²´ í”„ë¡œì„¸ìŠ¤ í‘œì‹œ
        processes.forEach(process => {
            const option = document.createElement('option');
            option.value = process.id;
            option.textContent = process.name;
            processSelect.appendChild(option);
        });
    }
}

// í‰ê·  ì ìˆ˜ ì°¨íŠ¸ íŒ€ ë³€ê²½ í•¸ë“¤ëŸ¬
function onAvgScoreTeamChange() {
    const teamSelect = document.getElementById('avg-score-team-select');
    const selectedTeam = teamSelect.value;
    
    // í”„ë¡œì„¸ìŠ¤ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
    updateProcessSelectForTeam('avg-score', selectedTeam);
    
    // ì°¨íŠ¸ í•„í„°ë§
    filterAvgScoreChart();
}

// Assessment ì°¨íŠ¸ íŒ€ ë³€ê²½ í•¸ë“¤ëŸ¬
function onAssessmentTeamChange() {
    const teamSelect = document.getElementById('assessment-team-select');
    const selectedTeam = teamSelect.value;
    
    // í”„ë¡œì„¸ìŠ¤ ì…€ë ‰íŠ¸ ì—…ë°ì´íŠ¸
    updateProcessSelectForTeam('assessment', selectedTeam);
    
    // ì°¨íŠ¸ í•„í„°ë§
    filterAssessmentChart();
}

function updateDashboardStats() {
    const totalWorkersEl = document.getElementById('total-workers');
    const testTakersEl = document.getElementById('test-takers');
    const testPassedEl = document.getElementById('test-passed');
    
    if (totalWorkersEl) totalWorkersEl.textContent = dashboardData.total_workers;
    if (testTakersEl) testTakersEl.textContent = dashboardData.written_test_takers;
    if (testPassedEl) testPassedEl.textContent = dashboardData.written_test_passed;
}

// ë²•ì¸ í•„í„° (ì „ì²´ ëŒ€ì‹œë³´ë“œì— ì˜í–¥)
async function filterDashboardByEntity() {
    const entitySelect = document.getElementById('dashboard-entity-select');
    const selectedEntity = entitySelect.value;
    
    try {
        // ë²•ì¸ í•„í„°ë§Œ ì ìš©
        let url = '/api/dashboard/stats';
        if (selectedEntity) {
            url += `?entity=${selectedEntity}`;
        }
        
        const response = await axios.get(url);
        dashboardData = response.data;
        
        // ë²•ì¸ì— ë”°ë¥¸ íŒ€ ëª©ë¡ ì—…ë°ì´íŠ¸
        let teamsUrl = '/api/teams';
        if (selectedEntity) {
            teamsUrl += `?entity=${selectedEntity}`;
        }
        const teamsResponse = await axios.get(teamsUrl);
        const teams = teamsResponse.data;
        
        // íŒ€ ì…€ë ‰íŠ¸ ë°•ìŠ¤ ì—…ë°ì´íŠ¸
        populateTeamSelect('avg-score-team-select', teams);
        populateTeamSelect('assessment-team-select', teams);
        
        // ì°¨íŠ¸ê°€ ì´ë¯¸ ìˆìœ¼ë©´ ì‚­ì œ
        if (currentTestStatusChart) {
            currentTestStatusChart.destroy();
        }
        if (currentAvgScoreChart) {
            currentAvgScoreChart.destroy();
        }
        if (currentAssessmentChart) {
            currentAssessmentChart.destroy();
        }
        
        // ìš”ì•½ ì¹´ë“œ ì—…ë°ì´íŠ¸
        updateDashboardStats();
        
        // ì°¨íŠ¸ ë‹¤ì‹œ ë Œë”ë§
        renderTestStatusChart();
        renderAvgScoreChart();
        renderAssessmentChart();
    } catch (error) {
        console.error('í•„í„°ë§ ì‹¤íŒ¨:', error);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// í‰ê·  ì ìˆ˜ ì°¨íŠ¸ íŒ€/í”„ë¡œì„¸ìŠ¤ í•„í„°
async function filterAvgScoreChart() {
    const entitySelect = document.getElementById('dashboard-entity-select');
    const teamSelect = document.getElementById('avg-score-team-select');
    const processSelect = document.getElementById('avg-score-process-select');
    const selectedEntity = entitySelect.value;
    const selectedTeam = teamSelect.value;
    const selectedProcess = processSelect.value;
    
    try {
        let url = '/api/dashboard/stats?';
        const params = [];
        
        if (selectedEntity) {
            params.push(`entity=${selectedEntity}`);
        }
        if (selectedTeam) {
            params.push(`team=${encodeURIComponent(selectedTeam)}`);
        }
        if (selectedProcess) {
            params.push(`processId=${selectedProcess}`);
        }
        
        url += params.join('&');
        
        const response = await axios.get(url);
        const filteredData = response.data;
        
        // í‰ê·  ì ìˆ˜ ì°¨íŠ¸ë§Œ ì—…ë°ì´íŠ¸
        if (currentAvgScoreChart) {
            currentAvgScoreChart.destroy();
        }
        
        // ì„ì‹œë¡œ ë°ì´í„° êµì²´
        const originalData = dashboardData;
        dashboardData = filteredData;
        renderAvgScoreChart();
        dashboardData = originalData;
    } catch (error) {
        console.error('í‰ê·  ì ìˆ˜ ì°¨íŠ¸ í•„í„°ë§ ì‹¤íŒ¨:', error);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Assessment ì°¨íŠ¸ í”„ë¡œì„¸ìŠ¤/íŒ€ í•„í„°
async function filterAssessmentChart() {
    const entitySelect = document.getElementById('dashboard-entity-select');
    const processSelect = document.getElementById('assessment-process-select');
    const teamSelect = document.getElementById('assessment-team-select');
    const selectedEntity = entitySelect.value;
    const selectedProcess = processSelect.value;
    const selectedTeam = teamSelect.value;
    
    try {
        let url = '/api/dashboard/stats?';
        const params = [];
        
        if (selectedEntity) {
            params.push(`entity=${selectedEntity}`);
        }
        if (selectedProcess) {
            params.push(`processId=${selectedProcess}`);
        }
        if (selectedTeam) {
            params.push(`team=${encodeURIComponent(selectedTeam)}`);
        }
        
        url += params.join('&');
        
        const response = await axios.get(url);
        const filteredData = response.data;
        
        // Assessment ì°¨íŠ¸ë§Œ ì—…ë°ì´íŠ¸
        if (currentAssessmentChart) {
            currentAssessmentChart.destroy();
        }
        
        // ì„ì‹œë¡œ ë°ì´í„° êµì²´
        const originalData = dashboardData;
        dashboardData = filteredData;
        renderAssessmentChart();
        dashboardData = originalData;
    } catch (error) {
        console.error('Assessment ì°¨íŠ¸ í•„í„°ë§ ì‹¤íŒ¨:', error);
        alert('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function renderTestStatusChart() {
    const ctx = document.getElementById('test-status-chart');
    const data = dashboardData.written_test_by_process;
    
    currentTestStatusChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: data.map(d => d.process_name),
            datasets: [
                {
                    label: 'ì‘ì‹œì',
                    data: data.map(d => d.takers),
                    backgroundColor: 'rgba(59, 130, 246, 0.6)',
                    borderColor: 'rgba(59, 130, 246, 1)',
                    borderWidth: 1
                },
                {
                    label: 'í•©ê²©ì',
                    data: data.map(d => d.passed),
                    backgroundColor: 'rgba(34, 197, 94, 0.6)',
                    borderColor: 'rgba(34, 197, 94, 1)',
                    borderWidth: 1
                }
            ]
        },
        options: {
            ...CHART_DEFAULTS,
            scales: CHART_SCALE_DEFAULTS,
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    formatter: (value) => value,
                    font: {
                        weight: 'bold'
                    }
                }
            }
        }
    });
}

function renderAvgScoreChart() {
    const ctx = document.getElementById('avg-score-chart');
    const data = dashboardData.avg_score_by_process;
    
    // ë²•ì¸ë³„ë¡œ ë°ì´í„° ê·¸ë£¹í™”
    const entityColors = {
        'CSVN': { bg: 'rgba(59, 130, 246, 0.6)', border: 'rgba(59, 130, 246, 1)' },
        'CSCN': { bg: 'rgba(34, 197, 94, 0.6)', border: 'rgba(34, 197, 94, 1)' },
        'CSTW': { bg: 'rgba(168, 85, 247, 0.6)', border: 'rgba(168, 85, 247, 1)' }
    };
    
    // í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ì¶”ì¶œ (ì¤‘ë³µ ì œê±°)
    const processNames = [...new Set(data.map(d => d.process_name))];
    
    // ë²•ì¸ë³„ ë°ì´í„°ì…‹ ìƒì„±
    const entities = [...new Set(data.map(d => d.entity).filter(e => e))];
    const datasets = entities.map(entity => {
        const entityData = processNames.map(processName => {
            const item = data.find(d => d.process_name === processName && d.entity === entity);
            return item ? parseFloat(item.avg_score) : 0;
        });
        
        return {
            label: entity,
            data: entityData,
            backgroundColor: entityColors[entity]?.bg || 'rgba(156, 163, 175, 0.6)',
            borderColor: entityColors[entity]?.border || 'rgba(156, 163, 175, 1)',
            borderWidth: 1
        };
    });
    
    currentAvgScoreChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: processNames,
            datasets: datasets
        },
        options: {
            ...CHART_DEFAULTS,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100
                }
            },
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    formatter: (value) => parseFloat(value).toFixed(1),
                    font: {
                        weight: 'bold'
                    }
                }
            }
        }
    });
}

function renderAssessmentChart() {
    const ctx = document.getElementById('assessment-chart');
    const data = dashboardData.supervisor_assessment_by_level;
    
    // ë²•ì¸ë³„ë¡œ ê·¸ë£¹í™”
    const entities = [...new Set(data.map(d => d.entity))];
    const levels = [...new Set(data.map(d => d.level))].sort();
    
    const datasets = entities.map((entity, index) => {
        const colors = [
            'rgba(239, 68, 68, 0.6)',
            'rgba(59, 130, 246, 0.6)',
            'rgba(34, 197, 94, 0.6)',
            'rgba(234, 179, 8, 0.6)',
            'rgba(168, 85, 247, 0.6)'
        ];
        
        return {
            label: entity,
            data: levels.map(level => {
                const item = data.find(d => d.entity === entity && d.level === level);
                return item ? item.count : 0;
            }),
            backgroundColor: colors[index % colors.length],
            borderColor: colors[index % colors.length].replace('0.6', '1'),
            borderWidth: 1
        };
    });
    
    currentAssessmentChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: levels.map(l => `Level ${l}`),
            datasets: datasets
        },
        options: {
            ...CHART_DEFAULTS,
            scales: CHART_SCALE_DEFAULTS,
            plugins: {
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    formatter: (value) => value,
                    font: {
                        weight: 'bold'
                    }
                }
            }
        }
    });
}

// ==================== Quiz ë“±ë¡ í˜ì´ì§€ ====================

async function loadQuizUploadPage() {
    // Load process list for quiz (only 18 positions in specified order)
    const processSelect = document.getElementById('quiz-process-select');
    if (processSelect) {
        processSelect.innerHTML = '<option value="">Select Process</option>';
        
        // Filter and sort processes according to QUIZ_POSITION_ORDER
        QUIZ_POSITION_ORDER.forEach(positionName => {
            const process = processes.find(p => p.name === positionName);
            if (process) {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = process.name;
                processSelect.appendChild(option);
            }
        });
    }
    
    // Load Registered Quiz Status
    await loadQuizStatus();
}

async function loadQuizStatus() {
    try {
        const statusDiv = document.getElementById('quiz-status-table');
        
        // íŒ€ë³„ í”„ë¡œì„¸ìŠ¤ ë¶„ë¥˜
        const teamProcesses = {
            'Black Tower': ['Material Handling', 'Cutting', 'Beveling', 'Bending', 'LS Welding', 'Fit Up', 'CS Welding', 'VTMT', 'Bracket FU', 'Bracket Weld', 'UT repair', 'DF FU', 'DF Weld', 'Flatness'],
            'White Tower': ['Blasting', 'Metalizing', 'Paint'],
            'Internal Mounting': ['Mechanical', 'Electrical']
        };
        
        // í”„ë¡œì„¸ìŠ¤ë³„ Quiz ê°œìˆ˜ ì¡°íšŒ
        const quizCounts = {};
        const latestDates = {};
        
        for (const process of processes) {
            const response = await axios.get(`/api/quizzes/${process.id}`);
            const quizzes = response.data;
            quizCounts[process.id] = quizzes.length;
            
            if (quizzes.length > 0) {
                // ê°€ì¥ ìµœê·¼ ë“±ë¡ì¼ ì°¾ê¸°
                const dates = quizzes.map(q => new Date(q.created_at));
                latestDates[process.id] = new Date(Math.max(...dates));
            }
        }
        
        // íŒ€ë³„ ì„¹ì…˜ ìƒì„±
        let html = '<div class="space-y-4">';
        
        Object.entries(teamProcesses).forEach(([teamName, processNames]) => {
            const teamId = teamName.replace(/\s+/g, '-').toLowerCase();
            
            // íŒ€ë³„ í†µê³„
            const teamProcessList = processes.filter(p => processNames.includes(p.name));
            const totalProcesses = teamProcessList.length;
            const registeredCount = teamProcessList.filter(p => quizCounts[p.id] > 0).length;
            
            html += `
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <!-- íŒ€ í—¤ë” (í† ê¸€ ë²„íŠ¼) -->
                    <button onclick="toggleTeamSection('${teamId}')" 
                            class="w-full px-6 py-4 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 flex items-center justify-between transition-colors">
                        <div class="flex items-center gap-3">
                            <i class="fas fa-users text-blue-600"></i>
                            <h4 class="text-lg font-bold text-gray-800">${teamName}</h4>
                            <span class="text-sm text-gray-600">
                                (${registeredCount}/${totalProcesses} Processes Registered)
                            </span>
                        </div>
                        <i id="${teamId}-icon" class="fas fa-chevron-down text-blue-600 transition-transform"></i>
                    </button>
                    
                    <!-- Team Process List (Toggleable) -->
                    <div id="${teamId}-content" class="overflow-hidden transition-all duration-300">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">PROCESS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">QUIZ COUNT</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">LAST REGISTERED</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">STATUS</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            teamProcessList.forEach(process => {
                // Drillingì€ Quizì—ì„œ ì œì™¸
                if (process.name === 'Drilling') return;
                
                const count = quizCounts[process.id] || 0;
                const latestDate = latestDates[process.id];
                const dateStr = latestDate ? latestDate.toLocaleDateString('en-US') : '-';
                const statusBadge = count > 0 
                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Registered</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">Not Registered</span>';
                
                const manageButtons = count > 0 
                    ? `
                        <div class="flex gap-2">
                            <button onclick="showQuizManagement(${process.id}, '${process.name}')" 
                                    class="bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded">
                                <i class="fas fa-cog mr-1"></i>Manage
                            </button>
                            <button onclick="deleteAllQuizzesByProcess(${process.id}, '${process.name}', ${count})" 
                                    class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded">
                                <i class="fas fa-trash-alt mr-1"></i>Delete All
                            </button>
                        </div>
                      `
                    : '-';
                
                html += `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${process.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${count}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateStr}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm">${manageButtons}</td>
                    </tr>
                `;
            });
            
            html += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        html += '</div>';
        
        statusDiv.innerHTML = html;
    } catch (error) {
        console.error('Failed to load quiz status:', error);
        document.getElementById('quiz-status-table').innerHTML = 
            '<p class="text-red-500">Failed to load quiz status.</p>';
    }
}

// íŒ€ ì„¹ì…˜ í† ê¸€ í•¨ìˆ˜
function toggleTeamSection(teamId) {
    const content = document.getElementById(`${teamId}-content`);
    const icon = document.getElementById(`${teamId}-icon`);
    
    if (content.style.maxHeight && content.style.maxHeight !== '0px') {
        // ë‹«ê¸°
        content.style.maxHeight = '0px';
        icon.style.transform = 'rotate(0deg)';
    } else {
        // ì—´ê¸°
        content.style.maxHeight = content.scrollHeight + 'px';
        icon.style.transform = 'rotate(180deg)';
    }
}

function getQuizUploadHTML() {
    return `
        <div class="space-y-6">
            <!-- Registered Quiz Status -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-list-check mr-2"></i>
                    Registered Quiz Status
                </h3>
                <div id="quiz-status-table" class="overflow-x-auto">
                    <p class="text-gray-500">Loading...</p>
                </div>
            </div>
            
            <!-- Upload Section -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-question-circle mr-2"></i>
                    Written Test Quiz Registration
                </h2>
                
                <div class="mb-6">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-sm text-blue-700 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Supported Format 1:</strong> Process ID, Question, Option A, Option B, Option C, Option D, Correct Answer
                        </p>
                        <p class="text-sm text-blue-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>Supported Format 2:</strong> No., Question, 1), 2), 3), 4), Answer (auto-converted)
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Select Process (Required for Format 2)
                        </label>
                        <select id="quiz-process-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">Select Process</option>
                        </select>
                    </div>
                    
                    <label class="block text-gray-700 font-semibold mb-2">
                        Select Excel File
                    </label>
                    <input type="file" id="quiz-file" accept=".xlsx,.xls" 
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-lg file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-blue-50 file:text-blue-700
                                  hover:file:bg-blue-100
                                  cursor-pointer">
                </div>
                
                <div class="mb-6">
                    <button onclick="downloadQuizTemplate()" 
                            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition">
                        <i class="fas fa-download mr-2"></i>
                        í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                
                <button onclick="uploadQuizzes()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition">
                    <i class="fas fa-upload mr-2"></i>
                    í€´ì¦ˆ ì—…ë¡œë“œ
                </button>
            </div>
        </div>
    `;
}

function downloadQuizTemplate() {
    const wb = XLSX.utils.book_new();
    const ws_data = [
        ['Process ID', 'Question', 'Option A', 'Option B', 'Option C', 'Option D', 'Correct Answer'],
        [1, 'ìƒ˜í”Œ ì§ˆë¬¸ì…ë‹ˆë‹¤?', 'ì˜µì…˜ A', 'ì˜µì…˜ B', 'ì˜µì…˜ C', 'ì˜µì…˜ D', 'A']
    ];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'Quizzes');
    XLSX.writeFile(wb, 'quiz_template.xlsx');
}

async function uploadQuizzes() {
    const fileInput = document.getElementById('quiz-file');
    if (!fileInput.files.length) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet);
            
            if (rows.length === 0) {
                alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì²« ë²ˆì§¸ í–‰ì˜ ì»¬ëŸ¼ í™•ì¸í•˜ì—¬ í˜•ì‹ ê°ì§€
            const firstRow = rows[0];
            let quizzes = [];
            
            // í˜•ì‹ 1: Process ID, Question, Option A, Option B, Option C, Option D, Correct Answer
            if (firstRow.hasOwnProperty('Process ID') && firstRow.hasOwnProperty('Question')) {
                quizzes = rows.map(row => ({
                    process_id: row['Process ID'],
                    question: (row['Question'] || '').toString().trim(),
                    option_a: (row['Option A'] || '').toString().trim(),
                    option_b: (row['Option B'] || '').toString().trim(),
                    option_c: (row['Option C'] || '').toString().trim(),
                    option_d: (row['Option D'] || '').toString().trim(),
                    correct_answer: (row['Correct Answer'] || '').toString().trim().toUpperCase()
                }));
            }
            // í˜•ì‹ 2: í”„ë¡œì„¸ìŠ¤, ë²ˆí˜¸, ì§ˆë¬¸, 1), 2), 3), 4), ì •ë‹µ
            else if (firstRow.hasOwnProperty('í”„ë¡œì„¸ìŠ¤') && firstRow.hasOwnProperty('ì§ˆë¬¸')) {
                // í”„ë¡œì„¸ìŠ¤ ì´ë¦„ ë§¤í•‘ (ì¶•ì•½í˜• -> ì „ì²´ ì´ë¦„)
                const processNameMap = {
                    'MATERIAL HANDLING': 'Material Handling',
                    'CUTTING': 'Cutting',
                    'BEVELING': 'Beveling',
                    'BENDING': 'Bending',
                    'LS WELDING': 'LS Welding',
                    'FIT UP': 'Fit Up',
                    'CS WELDING': 'CS Welding',
                    'VTMT': 'VTMT',
                    'BRACKET FU': 'Bracket FU',
                    'BRK FU': 'Bracket FU',  // ì¶•ì•½í˜• ì§€ì›
                    'BRACKET WELD': 'Bracket Weld',
                    'BRK WELD': 'Bracket Weld',  // ì¶•ì•½í˜• ì§€ì›
                    'UT REPAIR': 'UT repair',
                    'DF FU': 'DF FU',
                    'DF WELD': 'DF Weld',
                    'FLATNESS': 'Flatness',
                    'DRILLING': 'Drilling'
                };
                
                // í”„ë¡œì„¸ìŠ¤ ID ë§¤í•‘ ìƒì„±
                const processIdMap = {};
                processes.forEach(p => {
                    const upperName = p.name.toUpperCase();
                    processIdMap[upperName] = p.id;
                });
                
                quizzes = rows.map(row => {
                    // í”„ë¡œì„¸ìŠ¤ ì´ë¦„ ê°€ì ¸ì˜¤ê¸° ë° ì •ê·œí™”
                    let processName = (row['í”„ë¡œì„¸ìŠ¤'] || '').toString().trim().toUpperCase();
                    
                    // ë§¤í•‘ í…Œì´ë¸”ì—ì„œ ì „ì²´ ì´ë¦„ ì°¾ê¸°
                    if (processNameMap[processName]) {
                        processName = processNameMap[processName].toUpperCase();
                    }
                    
                    const processId = processIdMap[processName];
                    
                    if (!processId) {
                        console.warn(`í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${row['í”„ë¡œì„¸ìŠ¤']}`);
                    }
                    
                    // ì •ë‹µ ë§¤í•‘: A/B/C/D í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    let correctAnswer = row['ì •ë‹µ'];
                    if (correctAnswer && typeof correctAnswer === 'string') {
                        correctAnswer = correctAnswer.trim().toUpperCase();
                        // ë§Œì•½ ì •ë‹µì´ ìˆ«ìë©´ ë³€í™˜ (1->A, 2->B, 3->C, 4->D)
                        if (['1', '2', '3', '4'].includes(correctAnswer)) {
                            const mapping = {'1': 'A', '2': 'B', '3': 'C', '4': 'D'};
                            correctAnswer = mapping[correctAnswer];
                        }
                    }
                    
                    return {
                        process_id: processId,
                        question: (row['ì§ˆë¬¸'] || '').toString().trim(),
                        option_a: (row['1)'] || '').toString().trim(),
                        option_b: (row['2)'] || '').toString().trim(),
                        option_c: (row['3)'] || '').toString().trim(),
                        option_d: (row['4)'] || '').toString().trim(),
                        correct_answer: correctAnswer
                    };
                }).filter(q => q.process_id); // process_idê°€ ì—†ëŠ” ê²ƒì€ ì œì™¸
            }
            // í˜•ì‹ 3: ë²ˆí˜¸, ì§ˆë¬¸, 1), 2), 3), 4), ì •ë‹µ (í”„ë¡œì„¸ìŠ¤ ì„ íƒ í•„ìš”)
            else if (firstRow.hasOwnProperty('ë²ˆí˜¸') && firstRow.hasOwnProperty('ì§ˆë¬¸')) {
                const processSelect = document.getElementById('quiz-process-select');
                const processId = processSelect.value;
                
                if (!processId) {
                    alert('í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (í˜•ì‹ 3 ì‚¬ìš© ì‹œ í•„ìˆ˜)');
                    return;
                }
                
                quizzes = rows.map(row => {
                    // ì •ë‹µ ë§¤í•‘: A/B/C/D í˜•ì‹ìœ¼ë¡œ ë³€í™˜
                    let correctAnswer = row['ì •ë‹µ'];
                    if (correctAnswer && typeof correctAnswer === 'string') {
                        correctAnswer = correctAnswer.trim().toUpperCase();
                        // ë§Œì•½ ì •ë‹µì´ ìˆ«ìë©´ ë³€í™˜ (1->A, 2->B, 3->C, 4->D)
                        if (['1', '2', '3', '4'].includes(correctAnswer)) {
                            const mapping = {'1': 'A', '2': 'B', '3': 'C', '4': 'D'};
                            correctAnswer = mapping[correctAnswer];
                        }
                    }
                    
                    return {
                        process_id: parseInt(processId),
                        question: (row['ì§ˆë¬¸'] || '').toString().trim(),
                        option_a: (row['1)'] || '').toString().trim(),
                        option_b: (row['2)'] || '').toString().trim(),
                        option_c: (row['3)'] || '').toString().trim(),
                        option_d: (row['4)'] || '').toString().trim(),
                        correct_answer: correctAnswer
                    };
                });
            } else {
                alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—‘ì…€ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n\nì§€ì› í˜•ì‹:\n1. Process ID, Question, Option A, Option B, Option C, Option D, Correct Answer\n2. í”„ë¡œì„¸ìŠ¤, ë²ˆí˜¸, ì§ˆë¬¸, 1), 2), 3), 4), ì •ë‹µ\n3. ë²ˆí˜¸, ì§ˆë¬¸, 1), 2), 3), 4), ì •ë‹µ (í”„ë¡œì„¸ìŠ¤ ì„ íƒ í•„ìš”)');
                return;
            }
            
            // ë°ì´í„° ê²€ì¦
            for (let i = 0; i < quizzes.length; i++) {
                const quiz = quizzes[i];
                if (!quiz.process_id || !quiz.question || !quiz.option_a || !quiz.option_b || !quiz.correct_answer) {
                    alert(`${i + 1}ë²ˆì§¸ í–‰ì— í•„ìˆ˜ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                    return;
                }
                if (!['A', 'B', 'C', 'D'].includes(quiz.correct_answer)) {
                    alert(`${i + 1}ë²ˆì§¸ í–‰ì˜ ì •ë‹µì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. (A, B, C, D ì¤‘ í•˜ë‚˜ì—¬ì•¼ í•©ë‹ˆë‹¤)`);
                    return;
                }
            }
            
            const response = await axios.post('/api/quizzes/bulk', quizzes);
            alert(`${response.data.count}ê°œì˜ í€´ì¦ˆê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            fileInput.value = '';
            if (document.getElementById('quiz-process-select')) {
                document.getElementById('quiz-process-select').value = '';
            }
            // í˜„í™© ìƒˆë¡œê³ ì¹¨
            await loadQuizStatus();
        } catch (error) {
            console.error('í€´ì¦ˆ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('í€´ì¦ˆ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (error.response?.data?.error || error.message));
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// Quiz ê´€ë¦¬ ëª¨ë‹¬ í‘œì‹œ
async function showQuizManagement(processId, processName) {
    try {
        const response = await axios.get(`/api/quizzes/${processId}`);
        const quizzes = response.data;
        
        const modalHTML = `
            <div id="quiz-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeQuizModal(event)">
                <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-edit mr-2"></i>
                            ${processName} - Quiz ê´€ë¦¬ (${quizzes.length}ê°œ)
                        </h3>
                        <button onclick="closeQuizModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        ${quizzes.map((quiz, index) => `
                            <div class="border rounded-lg p-4 bg-gray-50" id="quiz-item-${quiz.id}">
                                <div class="flex justify-between items-start mb-3">
                                    <h4 class="font-bold text-lg">ë¬¸ì œ ${index + 1}</h4>
                                    <div class="space-x-2">
                                        <button onclick="editQuiz(${quiz.id})" class="bg-blue-500 hover:bg-blue-600 text-white text-sm py-1 px-3 rounded">
                                            <i class="fas fa-edit mr-1"></i>ìˆ˜ì •
                                        </button>
                                        <button onclick="deleteQuiz(${quiz.id}, ${processId})" class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded">
                                            <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                                        </button>
                                    </div>
                                </div>
                                <div class="space-y-2">
                                    <div class="font-semibold">ì§ˆë¬¸: ${quiz.question}</div>
                                    ${quiz.question_image_url ? `<img src="${quiz.question_image_url}" class="max-w-md rounded border" />` : ''}
                                    <div class="ml-4 space-y-1">
                                        <div class="${quiz.correct_answer === 'A' ? 'text-green-600 font-bold' : ''}">
                                            A. ${quiz.option_a}
                                            ${quiz.option_a_image_url ? `<img src="${quiz.option_a_image_url}" class="max-w-sm rounded border mt-1" />` : ''}
                                        </div>
                                        <div class="${quiz.correct_answer === 'B' ? 'text-green-600 font-bold' : ''}">
                                            B. ${quiz.option_b}
                                            ${quiz.option_b_image_url ? `<img src="${quiz.option_b_image_url}" class="max-w-sm rounded border mt-1" />` : ''}
                                        </div>
                                        ${quiz.option_c ? `<div class="${quiz.correct_answer === 'C' ? 'text-green-600 font-bold' : ''}">
                                            C. ${quiz.option_c}
                                            ${quiz.option_c_image_url ? `<img src="${quiz.option_c_image_url}" class="max-w-sm rounded border mt-1" />` : ''}
                                        </div>` : ''}
                                        ${quiz.option_d ? `<div class="${quiz.correct_answer === 'D' ? 'text-green-600 font-bold' : ''}">
                                            D. ${quiz.option_d}
                                            ${quiz.option_d_image_url ? `<img src="${quiz.option_d_image_url}" class="max-w-sm rounded border mt-1" />` : ''}
                                        </div>` : ''}
                                    </div>
                                    <div class="text-sm text-gray-600">ì •ë‹µ: <span class="font-bold text-green-600">${quiz.correct_answer}</span></div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    } catch (error) {
        console.error('Quiz ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('Quizë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function closeQuizModal(event) {
    if (!event || event.target.id === 'quiz-modal') {
        const modal = document.getElementById('quiz-modal');
        if (modal) modal.remove();
        
        const editModal = document.getElementById('quiz-edit-modal');
        if (editModal) editModal.remove();
    }
}

async function deleteQuiz(quizId, processId) {
    if (!confirm('ì´ ë¬¸ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
    
    try {
        await axios.delete(`/api/quizzes/${quizId}`);
        alert('ë¬¸ì œê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeQuizModal();
        await loadQuizStatus();
    } catch (error) {
        console.error('Quiz ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ë¬¸ì œ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

async function deleteAllQuizzesByProcess(processId, processName, count) {
    const confirmMessage = `âš ï¸ ê²½ê³ : ${processName}ì˜ ëª¨ë“  Quizë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œë  ë¬¸ì œ ìˆ˜: ${count}ê°œ\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`;
    
    if (!confirm(confirmMessage)) return;
    
    // í•œ ë²ˆ ë” í™•ì¸
    if (!confirm(`ì •ë§ë¡œ ${processName}ì˜ ${count}ê°œ Quizë¥¼ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    try {
        const response = await axios.delete(`/api/quizzes/process/${processId}`);
        alert(`${processName}ì˜ ${response.data.deletedCount}ê°œ Quizê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        await loadQuizStatus();
    } catch (error) {
        console.error('Quiz ì¼ê´„ ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('Quiz ì¼ê´„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (error.response?.data?.error || error.message));
    }
}

async function editQuiz(quizId) {
    try {
        // í˜„ì¬ ë¬¸ì œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        const quizItem = document.querySelector(`#quiz-item-${quizId}`);
        const modalContent = document.querySelector('#quiz-modal .bg-white');
        
        // ìˆ˜ì • í¼ ëª¨ë‹¬ ìƒì„±
        const editModalHTML = `
            <div id="quiz-edit-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeEditModal(event)">
                <div class="bg-white rounded-lg max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                        <h3 class="text-xl font-bold text-gray-800">
                            <i class="fas fa-edit mr-2"></i>
                            ë¬¸ì œ ìˆ˜ì •
                        </h3>
                        <button onclick="closeEditModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="p-6">
                        <form id="quiz-edit-form" class="space-y-4" onsubmit="saveQuizEdit(event, ${quizId})">
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ì§ˆë¬¸</label>
                                <textarea id="edit-question" class="w-full px-4 py-2 border border-gray-300 rounded-lg" rows="3" required></textarea>
                            </div>
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ì§ˆë¬¸ ì´ë¯¸ì§€ URL (ì„ íƒ)</label>
                                <input type="url" id="edit-question-image" class="w-full px-4 py-2 border border-gray-300 rounded-lg" placeholder="https://example.com/image.jpg">
                                <p class="text-sm text-gray-500 mt-1">ì´ë¯¸ì§€ URLì„ ì…ë ¥í•˜ê±°ë‚˜ ë¹„ì›Œë‘ì„¸ìš”</p>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">ì„ íƒì§€ A</label>
                                    <input type="text" id="edit-option-a" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <input type="url" id="edit-option-a-image" class="w-full px-4 py-2 border border-gray-300 rounded-lg mt-2" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">ì„ íƒì§€ B</label>
                                    <input type="text" id="edit-option-b" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <input type="url" id="edit-option-b-image" class="w-full px-4 py-2 border border-gray-300 rounded-lg mt-2" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">ì„ íƒì§€ C (ì„ íƒ)</label>
                                    <input type="text" id="edit-option-c" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <input type="url" id="edit-option-c-image" class="w-full px-4 py-2 border border-gray-300 rounded-lg mt-2" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)">
                                </div>
                                <div>
                                    <label class="block text-gray-700 font-semibold mb-2">ì„ íƒì§€ D (ì„ íƒ)</label>
                                    <input type="text" id="edit-option-d" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                                    <input type="url" id="edit-option-d-image" class="w-full px-4 py-2 border border-gray-300 rounded-lg mt-2" placeholder="ì´ë¯¸ì§€ URL (ì„ íƒ)">
                                </div>
                            </div>
                            
                            <div>
                                <label class="block text-gray-700 font-semibold mb-2">ì •ë‹µ</label>
                                <select id="edit-correct-answer" class="w-full px-4 py-2 border border-gray-300 rounded-lg" required>
                                    <option value="A">A</option>
                                    <option value="B">B</option>
                                    <option value="C">C</option>
                                    <option value="D">D</option>
                                </select>
                            </div>
                            
                            <input type="hidden" id="edit-process-id">
                            
                            <div class="flex space-x-3">
                                <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg">
                                    <i class="fas fa-save mr-2"></i>ì €ì¥
                                </button>
                                <button type="button" onclick="closeEditModal()" class="bg-gray-500 hover:bg-gray-600 text-white font-semibold py-2 px-6 rounded-lg">
                                    ì·¨ì†Œ
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', editModalHTML);
        
        // í˜„ì¬ ë°ì´í„°ë¡œ í¼ ì±„ìš°ê¸°
        const response = await axios.get(`/api/quizzes/${quizId.toString().split('-')[0]}`);
        const allQuizzes = response.data;
        const currentQuiz = allQuizzes.find(q => q.id === quizId);
        
        if (currentQuiz) {
            document.getElementById('edit-question').value = currentQuiz.question;
            document.getElementById('edit-question-image').value = currentQuiz.question_image_url || '';
            document.getElementById('edit-option-a').value = currentQuiz.option_a;
            document.getElementById('edit-option-a-image').value = currentQuiz.option_a_image_url || '';
            document.getElementById('edit-option-b').value = currentQuiz.option_b;
            document.getElementById('edit-option-b-image').value = currentQuiz.option_b_image_url || '';
            document.getElementById('edit-option-c').value = currentQuiz.option_c || '';
            document.getElementById('edit-option-c-image').value = currentQuiz.option_c_image_url || '';
            document.getElementById('edit-option-d').value = currentQuiz.option_d || '';
            document.getElementById('edit-option-d-image').value = currentQuiz.option_d_image_url || '';
            document.getElementById('edit-correct-answer').value = currentQuiz.correct_answer;
            document.getElementById('edit-process-id').value = currentQuiz.process_id;
        }
    } catch (error) {
        console.error('Quiz ìˆ˜ì • í¼ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ë¬¸ì œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function closeEditModal(event) {
    if (!event || event.target.id === 'quiz-edit-modal') {
        const modal = document.getElementById('quiz-edit-modal');
        if (modal) modal.remove();
    }
}

async function saveQuizEdit(event, quizId) {
    event.preventDefault();
    
    try {
        const updatedQuiz = {
            process_id: parseInt(document.getElementById('edit-process-id').value),
            question: document.getElementById('edit-question').value,
            question_image_url: document.getElementById('edit-question-image').value || null,
            option_a: document.getElementById('edit-option-a').value,
            option_a_image_url: document.getElementById('edit-option-a-image').value || null,
            option_b: document.getElementById('edit-option-b').value,
            option_b_image_url: document.getElementById('edit-option-b-image').value || null,
            option_c: document.getElementById('edit-option-c').value || null,
            option_c_image_url: document.getElementById('edit-option-c-image').value || null,
            option_d: document.getElementById('edit-option-d').value || null,
            option_d_image_url: document.getElementById('edit-option-d-image').value || null,
            correct_answer: document.getElementById('edit-correct-answer').value
        };
        
        await axios.put(`/api/quizzes/${quizId}`, updatedQuiz);
        alert('ë¬¸ì œê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeEditModal();
        closeQuizModal();
        await loadQuizStatus();
    } catch (error) {
        console.error('Quiz ìˆ˜ì • ì‹¤íŒ¨:', error);
        alert('ë¬¸ì œ ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ==================== Assessment ë“±ë¡ í˜ì´ì§€ ====================

async function loadAssessmentUploadPage() {
    // í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ë¡œë“œ
    const processSelect = document.getElementById('assessment-process-select');
    if (processSelect) {
        processSelect.innerHTML = '<option value="">í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
        
        // Assessment ì „ìš© í”„ë¡œì„¸ìŠ¤ 22ê°œë§Œ í‘œì‹œ (Quiz ì „ìš© ì œì™¸)
        const quizOnlyProcesses = ['Blasting', 'Metalizing', 'Paint', 'Mechanical', 'Electrical'];
        
        processes.forEach(process => {
            // Quiz ì „ìš© í”„ë¡œì„¸ìŠ¤ëŠ” ì œì™¸
            if (!quizOnlyProcesses.includes(process.name)) {
                const option = document.createElement('option');
                option.value = process.id;
                option.textContent = process.name;
                processSelect.appendChild(option);
            }
        });
    }
    
    // ë“±ë¡ëœ Assessment í•­ëª© í˜„í™© ë¡œë“œ
    await loadAssessmentStatus();
}

async function loadAssessmentStatus() {
    try {
        const statusDiv = document.getElementById('assessment-status-table');
        
        // ëª¨ë“  Assessment í•­ëª© ì¡°íšŒ
        const response = await axios.get('/api/assessment-items');
        const allItems = response.data;
        
        // í”„ë¡œì„¸ìŠ¤ë³„ í•­ëª© ê°œìˆ˜ ê³„ì‚°
        const itemCounts = {};
        const latestDates = {};
        const categoryBreakdown = {};
        
        // í”„ë¡œì„¸ìŠ¤ë³„ë¡œ ê·¸ë£¹í™”
        allItems.forEach(item => {
            const processId = item.process_id || 'general';
            
            if (!itemCounts[processId]) {
                itemCounts[processId] = 0;
                categoryBreakdown[processId] = {};
            }
            
            itemCounts[processId]++;
            
            // ì¹´í…Œê³ ë¦¬ë³„ ì§‘ê³„
            const category = item.category;
            if (!categoryBreakdown[processId][category]) {
                categoryBreakdown[processId][category] = 0;
            }
            categoryBreakdown[processId][category]++;
            
            // ìµœê·¼ ë“±ë¡ì¼
            const itemDate = new Date(item.created_at);
            if (!latestDates[processId] || itemDate > latestDates[processId]) {
                latestDates[processId] = itemDate;
            }
        });
        
        // í…Œì´ë¸” ìƒì„±
        let tableHTML = `
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">í”„ë¡œì„¸ìŠ¤</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ë“±ë¡ëœ í•­ëª© ìˆ˜</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ì¹´í…Œê³ ë¦¬ ë¶„í¬</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìµœê·¼ ë“±ë¡ì¼</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ìƒíƒœ</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">ê´€ë¦¬</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
        `;
        
        // ì¼ë°˜ í•­ëª© (í”„ë¡œì„¸ìŠ¤ ë¯¸ì—°ê²°)
        if (itemCounts['general']) {
            const count = itemCounts['general'];
            const latestDate = latestDates['general'];
            const dateStr = latestDate ? latestDate.toLocaleDateString('ko-KR') : '-';
            const categories = Object.entries(categoryBreakdown['general'])
                .map(([cat, cnt]) => `${cat}(${cnt})`)
                .join(', ');
            
            tableHTML += `
                <tr class="bg-blue-50">
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">ì¼ë°˜ í•­ëª© (ê³µí†µ)</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${count}ê°œ</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${categories}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateStr}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">ê³µí†µ</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <div class="flex gap-2">
                            <button onclick="showAssessmentManagement(null, 'ì¼ë°˜ í•­ëª© (ê³µí†µ)')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded">
                                <i class="fas fa-cog mr-1"></i>ê´€ë¦¬
                            </button>
                            <button onclick="deleteAllAssessmentsByProcess(null, 'ì¼ë°˜ í•­ëª© (ê³µí†µ)', ${count})" class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded">
                                <i class="fas fa-trash-alt mr-1"></i>ì „ì²´ ì‚­ì œ
                            </button>
                        </div>
                    </td>
                </tr>
            `;
        }
        
        // í”„ë¡œì„¸ìŠ¤ë³„ í•­ëª© (Quiz ì „ìš© í”„ë¡œì„¸ìŠ¤ ì œì™¸)
        const quizOnlyProcesses = ['Blasting', 'Metalizing', 'Paint', 'Mechanical', 'Electrical'];
        
        processes.forEach(process => {
            // Quiz ì „ìš© í”„ë¡œì„¸ìŠ¤ëŠ” ì œì™¸
            if (quizOnlyProcesses.includes(process.name)) {
                return;
            }
            
            const count = itemCounts[process.id] || 0;
            const latestDate = latestDates[process.id];
            const dateStr = latestDate ? latestDate.toLocaleDateString('ko-KR') : '-';
            const categories = categoryBreakdown[process.id] 
                ? Object.entries(categoryBreakdown[process.id])
                    .map(([cat, cnt]) => `${cat}(${cnt})`)
                    .join(', ')
                : '-';
            const statusBadge = count > 0 
                ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">ë“±ë¡ë¨</span>'
                : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">ë¯¸ë“±ë¡</span>';
            
            const manageButtons = count > 0 
                ? `
                    <div class="flex gap-2">
                        <button onclick="showAssessmentManagement(${process.id}, '${process.name}')" class="bg-blue-500 hover:bg-blue-600 text-white text-xs py-1 px-3 rounded">
                            <i class="fas fa-cog mr-1"></i>ê´€ë¦¬
                        </button>
                        <button onclick="deleteAllAssessmentsByProcess(${process.id}, '${process.name}', ${count})" class="bg-red-500 hover:bg-red-600 text-white text-xs py-1 px-3 rounded">
                            <i class="fas fa-trash-alt mr-1"></i>ì „ì²´ ì‚­ì œ
                        </button>
                    </div>
                  `
                : '-';
            
            tableHTML += `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${process.name}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${count}ê°œ</td>
                    <td class="px-6 py-4 text-sm text-gray-500">${categories}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${dateStr}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${statusBadge}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">${manageButtons}</td>
                </tr>
            `;
        });
        
        tableHTML += `
                </tbody>
            </table>
        `;
        
        statusDiv.innerHTML = tableHTML;
    } catch (error) {
        console.error('Assessment í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('assessment-status-table').innerHTML = 
            '<p class="text-red-500">í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

// Assessment ê´€ë¦¬ ëª¨ë‹¬ í‘œì‹œ
async function showAssessmentManagement(processId, processName) {
    try {
        const response = await axios.get('/api/assessment-items');
        const allItems = response.data;
        
        // processIdê°€ nullì´ë©´ ì¼ë°˜ í•­ëª©(ê³µí†µ), ì•„ë‹ˆë©´ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ í•­ëª©ë§Œ í•„í„°ë§
        const items = allItems.filter(item => {
            if (processId === null) {
                return item.process_id === null;
            } else {
                return item.process_id === processId;
            }
        });
        
        const modalHTML = `
            <div id="assessment-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeAssessmentModal(event)">
                <div class="bg-white rounded-lg max-w-6xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                    <div class="sticky top-0 bg-white border-b px-6 py-4 flex justify-between items-center">
                        <h3 class="text-2xl font-bold text-gray-800">
                            <i class="fas fa-clipboard-check mr-2"></i>
                            ${processName} - Assessment í•­ëª© ê´€ë¦¬ (${items.length}ê°œ)
                        </h3>
                        <button onclick="closeAssessmentModal()" class="text-gray-500 hover:text-gray-700">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    <div class="p-6 space-y-4">
                        ${items.length === 0 ? '<p class="text-gray-500 text-center py-8">ë“±ë¡ëœ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</p>' : ''}
                        ${items.map((item, index) => `
                            <div class="border rounded-lg p-4 bg-gray-50" id="assessment-item-${item.id}">
                                <div class="flex justify-between items-start mb-3">
                                    <div class="flex-1">
                                        <h4 class="font-bold text-lg">${index + 1}. ${item.item_name}</h4>
                                        <span class="inline-block px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800 mt-1">
                                            ${item.category}
                                        </span>
                                    </div>
                                    <button onclick="deleteAssessmentItem(${item.id}, ${processId}, '${processName}')" 
                                            class="bg-red-500 hover:bg-red-600 text-white text-sm py-1 px-3 rounded">
                                        <i class="fas fa-trash mr-1"></i>ì‚­ì œ
                                    </button>
                                </div>
                                <div class="space-y-2">
                                    <div class="text-sm text-gray-700">
                                        <span class="font-semibold">ì„¤ëª…:</span> ${item.description || 'ì„¤ëª… ì—†ìŒ'}
                                    </div>
                                    <div class="text-sm text-gray-500">
                                        ë“±ë¡ì¼: ${new Date(item.created_at).toLocaleDateString('ko-KR')}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', modalHTML);
    } catch (error) {
        console.error('Assessment í•­ëª© ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('Assessment í•­ëª©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function closeAssessmentModal(event) {
    if (!event || event.target.id === 'assessment-modal') {
        const modal = document.getElementById('assessment-modal');
        if (modal) modal.remove();
    }
}

async function deleteAssessmentItem(itemId, processId, processName) {
    if (!confirm('ì´ í‰ê°€ í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nâ€» ì´ í•­ëª©ê³¼ ì—°ê²°ëœ ëª¨ë“  í‰ê°€ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.')) return;
    
    try {
        await axios.delete(`/api/assessment-items/${itemId}`);
        alert('í‰ê°€ í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
        closeAssessmentModal();
        await loadAssessmentStatus();
    } catch (error) {
        console.error('Assessment í•­ëª© ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('í‰ê°€ í•­ëª© ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Assessment í”„ë¡œì„¸ìŠ¤ë³„ ì¼ê´„ ì‚­ì œ
async function deleteAllAssessmentsByProcess(processId, processName, count) {
    const confirmMessage = `âš ï¸ ê²½ê³ : ${processName}ì˜ ëª¨ë“  Assessment í•­ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì‚­ì œë  í•­ëª© ìˆ˜: ${count}ê°œ\n\nâ€» ì´ í•­ëª©ë“¤ê³¼ ì—°ê²°ëœ ëª¨ë“  í‰ê°€ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!`;
    
    if (!confirm(confirmMessage)) return;
    if (!confirm(`ì •ë§ë¡œ ${processName}ì˜ ${count}ê°œ Assessment í•­ëª©ì„ ëª¨ë‘ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
    
    try {
        // processIdê°€ nullì´ë©´ 'null' ë¬¸ìì—´ë¡œ ì „ì†¡
        const processParam = processId === null ? 'null' : processId;
        const response = await axios.delete(`/api/assessment-items/process/${processParam}`);
        alert(`${processName}ì˜ ${response.data.deletedCount}ê°œ Assessment í•­ëª©ì´ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
        await loadAssessmentStatus();
    } catch (error) {
        console.error('Assessment ì¼ê´„ ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('Assessment ì¼ê´„ ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (error.response?.data?.error || error.message));
    }
}

function getAssessmentUploadHTML() {
    return `
        <div class="space-y-6">
            <!-- ë“±ë¡ëœ í”„ë¡œì„¸ìŠ¤ í˜„í™© -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-list-check mr-2"></i>
                    ë“±ë¡ëœ Assessment í•­ëª© í˜„í™©
                </h3>
                <div id="assessment-status-table" class="overflow-x-auto">
                    <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
            <div class="bg-white rounded-lg shadow-md p-8">
                <h2 class="text-3xl font-bold text-gray-800 mb-6">
                    <i class="fas fa-clipboard-check mr-2"></i>
                    Supervisor Assessment í•­ëª© ë“±ë¡
                </h2>
                
                <div class="mb-6">
                    <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                        <p class="text-sm text-blue-700 mb-2">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>ì§€ì› í˜•ì‹ 1:</strong> Category, Item Name, Description
                        </p>
                        <p class="text-sm text-blue-700">
                            <i class="fas fa-info-circle mr-2"></i>
                            <strong>ì§€ì› í˜•ì‹ 2:</strong> Level2, Level3, Level4 ì»¬ëŸ¼ (Cutting.xlsx í˜•ì‹, ìë™ ë³€í™˜ë¨)
                        </p>
                    </div>
                    
                    <div class="mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            í”„ë¡œì„¸ìŠ¤ ì„ íƒ (í˜•ì‹ 2 ì‚¬ìš© ì‹œ í•„ìˆ˜)
                        </label>
                        <select id="assessment-process-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                            <option value="">í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                        </select>
                    </div>
                    
                    <label class="block text-gray-700 font-semibold mb-2">
                        ì—‘ì…€ íŒŒì¼ ì„ íƒ
                    </label>
                    <input type="file" id="assessment-file" accept=".xlsx,.xls" 
                           class="block w-full text-sm text-gray-500
                                  file:mr-4 file:py-2 file:px-4
                                  file:rounded-lg file:border-0
                                  file:text-sm file:font-semibold
                                  file:bg-blue-50 file:text-blue-700
                                  hover:file:bg-blue-100
                                  cursor-pointer">
                </div>
                
                <div class="mb-6">
                    <button onclick="downloadAssessmentTemplate()" 
                            class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition">
                        <i class="fas fa-download mr-2"></i>
                        í…œí”Œë¦¿ ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
                
                <button onclick="uploadAssessmentItems()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition">
                    <i class="fas fa-upload mr-2"></i>
                    í‰ê°€ í•­ëª© ì—…ë¡œë“œ
                </button>
            </div>
        </div>
    `;
}

function downloadAssessmentTemplate() {
    const wb = XLSX.utils.book_new();
    const ws_data = [
        ['Category', 'Item Name', 'Description'],
        ['ê¸°ìˆ  ëŠ¥ë ¥', 'ì‘ì—… ìˆ™ë ¨ë„', 'ì‘ì—… ê³¼ì •ì˜ ìˆ™ë ¨ ì •ë„']
    ];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'Assessment Items');
    XLSX.writeFile(wb, 'assessment_template.xlsx');
}

async function uploadAssessmentItems() {
    const fileInput = document.getElementById('assessment-file');
    if (!fileInput.files.length) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const file = fileInput.files[0];
    console.log(`ğŸ“ ì„ íƒëœ íŒŒì¼: ${file.name}, í¬ê¸°: ${file.size} bytes`);
    
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            
            // í—¤ë” ì—†ì´ ì „ì²´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜´ (range ì‚¬ìš©)
            const sheetData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
            
            console.log('ğŸ“‹ ì—‘ì…€ í—¤ë”:', sheetData[0]);
            console.log('ğŸ“‹ ì²« ë²ˆì§¸ ë°ì´í„° í–‰:', sheetData[1]);
            
            let items = [];
            
            // í˜•ì‹ 1: No., íŒ€, í”„ë¡œì„¸ìŠ¤, Lv ì¹´í…Œê³ ë¦¬, í‰ê°€í•­ëª© (ì‹ ê·œ í˜•ì‹)
            const hasNoOrProcess = sheetData[0] && (sheetData[0].includes('No.') || sheetData[0].includes('í”„ë¡œì„¸ìŠ¤'));
            const hasLvCategory = sheetData[0] && sheetData[0].includes('Lv ì¹´í…Œê³ ë¦¬');
            console.log('ğŸ” í˜•ì‹ 1 ì¡°ê±´:', { hasNoOrProcess, hasLvCategory });
            
            if (hasNoOrProcess && hasLvCategory) {
                console.log('âœ… í˜•ì‹ 1 ê°ì§€: í”„ë¡œì„¸ìŠ¤ í¬í•¨ í˜•ì‹');
                // ë¨¼ì € í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
                const processesResponse = await axios.get('/api/processes');
                const processes = processesResponse.data;
                
                // í”„ë¡œì„¸ìŠ¤ ì´ë¦„ ë§¤í•‘ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
                const processMap = {};
                processes.forEach(p => {
                    const normalizedName = p.name.toUpperCase().trim();
                    processMap[normalizedName] = p.id;
                    // ê³µë°±/ì–¸ë”ìŠ¤ì½”ì–´ ë³€í˜•ë„ ì¶”ê°€
                    processMap[normalizedName.replace(/\s+/g, '_')] = p.id;
                    processMap[normalizedName.replace(/_/g, ' ')] = p.id;
                    // ê´„í˜¸ ì œê±° ë³€í˜•ë„ ì¶”ê°€
                    processMap[normalizedName.replace(/\([^)]*\)/g, '').trim()] = p.id;
                });
                
                console.log('ğŸ“‹ í”„ë¡œì„¸ìŠ¤ ë§¤í•‘ í…Œì´ë¸”:', processMap);
                
                const rows = XLSX.utils.sheet_to_json(firstSheet);
                
                console.log(`ğŸ“Š ì´ ${rows.length}ê°œ í–‰ ë°œê²¬`);
                
                // ì²« ë²ˆì§¸ í–‰ì˜ ëª¨ë“  í•„ë“œ í™•ì¸
                if (rows.length > 0) {
                    console.log('ğŸ” ì²« ë²ˆì§¸ í–‰ ì „ì²´ ë°ì´í„°:', rows[0]);
                    console.log('   - No.:', rows[0]['No.']);
                    console.log('   - íŒ€:', rows[0]['íŒ€']);
                    console.log('   - í”„ë¡œì„¸ìŠ¤:', rows[0]['í”„ë¡œì„¸ìŠ¤']);
                    console.log('   - Lv ì¹´í…Œê³ ë¦¬:', rows[0]['Lv ì¹´í…Œê³ ë¦¬']);
                    console.log('   - í‰ê°€í•­ëª©:', rows[0]['í‰ê°€í•­ëª©']);
                }
                
                let successCount = 0;
                let skipCount = 0;
                
                for (const row of rows) {
                    const rawProcessName = (row['í”„ë¡œì„¸ìŠ¤'] || '').toString().trim();
                    const processName = rawProcessName.toUpperCase();
                    let processId = processMap[processName];
                    
                    // ê³µë°±/ì–¸ë”ìŠ¤ì½”ì–´ ë³€í˜• ì‹œë„
                    if (!processId) {
                        processId = processMap[processName.replace(/\s+/g, '_')] || processMap[processName.replace(/_/g, ' ')];
                    }
                    
                    // ê´„í˜¸ ì œê±° ì‹œë„
                    if (!processId) {
                        processId = processMap[processName.replace(/\([^)]*\)/g, '').trim()];
                    }
                    
                    if (!processId) {
                        console.warn(`âš ï¸ í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: "${rawProcessName}" (ì •ê·œí™”: "${processName}")`);
                        console.warn('   ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì„¸ìŠ¤:', Object.keys(processMap));
                        skipCount++;
                        continue;
                    }
                    
                    const category = row['Lv ì¹´í…Œê³ ë¦¬'] || row['Category'] || '';
                    const itemName = row['í‰ê°€í•­ëª©'] || row['Item Name'] || '';
                    
                    if (!category || !itemName) {
                        console.warn(`âš ï¸ í•„ìˆ˜ í•„ë“œ ëˆ„ë½ - Category: "${category}", Item: "${itemName}"`);
                        skipCount++;
                        continue;
                    }
                    
                    items.push({
                        process_id: processId,
                        category: category,
                        item_name: itemName,
                        description: row['ì„¤ëª…'] || row['Description'] || ''
                    });
                    successCount++;
                }
                
                console.log(`âœ… ì„±ê³µ: ${successCount}ê°œ, âš ï¸ ê±´ë„ˆëœ€: ${skipCount}ê°œ`);
            }
            // í˜•ì‹ 2: Category, Item Name, Description (ì¼ë°˜ì ì¸ í˜•ì‹)
            else if (sheetData[0] && sheetData[0].includes('Category')) {
                console.log('âœ… í˜•ì‹ 2 ê°ì§€: Category í˜•ì‹');
                const rows = XLSX.utils.sheet_to_json(firstSheet);
                items = rows.map(row => ({
                    process_id: null,
                    category: row['Category'],
                    item_name: row['Item Name'],
                    description: row['Description'] || ''
                }));
            }
            // í˜•ì‹ 3: Level2, Level3, Level4 í˜•ì‹ (Cutting.xlsx)
            else if (sheetData[1] && (sheetData[1].includes('Level2') || sheetData[1].includes('Level3') || sheetData[1].includes('Level4'))) {
                console.log('âœ… í˜•ì‹ 3 ê°ì§€: Level ì»¬ëŸ¼ í˜•ì‹');
                const processSelect = document.getElementById('assessment-process-select');
                const processId = processSelect.value;
                
                if (!processId) {
                    alert('í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”. (í˜•ì‹ 3 ì‚¬ìš© ì‹œ í•„ìˆ˜)');
                    return;
                }
                
                // í–‰ 2: ë ˆë²¨ ì •ë³´ (Level2, Level3, Level4)
                // í–‰ 3: ì§ˆë¬¸ ë‚´ìš©
                const levelRow = sheetData[1]; // í–‰ 2
                const questionRow = sheetData[2]; // í–‰ 3
                
                // ì»¬ëŸ¼ 7ë¶€í„° ì§ˆë¬¸ ì‹œì‘ (0-based index: 7 = Hì—´)
                for (let i = 7; i < questionRow.length; i++) {
                    const question = questionRow[i];
                    const level = levelRow[i];
                    
                    if (question && level) {
                        items.push({
                            process_id: parseInt(processId),
                            category: level, // Level2, Level3, Level4
                            item_name: question,
                            description: ''
                        });
                    }
                }
            } else {
                alert('ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—‘ì…€ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n\nì§€ì› í˜•ì‹:\n1. No., íŒ€, í”„ë¡œì„¸ìŠ¤, Lv ì¹´í…Œê³ ë¦¬, í‰ê°€í•­ëª©\n2. Category, Item Name, Description\n3. Level2, Level3, Level4 ì»¬ëŸ¼ í˜•ì‹');
                return;
            }
            
            if (items.length === 0) {
                alert('í‰ê°€ í•­ëª©ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            const response = await axios.post('/api/assessment-items/bulk', items);
            alert(`${response.data.count}ê°œì˜ í‰ê°€ í•­ëª©ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            // íŒŒì¼ input ê°•ì œ ì´ˆê¸°í™”
            fileInput.value = '';
            fileInput.type = '';
            fileInput.type = 'file';
            
            if (document.getElementById('assessment-process-select')) {
                document.getElementById('assessment-process-select').value = '';
            }
            // í˜„í™© ìƒˆë¡œê³ ì¹¨
            await loadAssessmentStatus();
        } catch (error) {
            console.error('í‰ê°€ í•­ëª© ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('í‰ê°€ í•­ëª© ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (error.response?.data?.error || error.message));
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// ==================== ì‘ì—…ì ë“±ë¡ í˜ì´ì§€ ====================

async function loadWorkerUploadPage() {
    // DBì—ì„œ ìµœì‹  ì‘ì—…ì ëª©ë¡ ì¡°íšŒ
    try {
        const response = await axios.get('/api/workers');
        workers = response.data; // ì „ì—­ workers ë³€ìˆ˜ ê°±ì‹ 
        console.log(`âœ… ì‘ì—…ì ëª©ë¡ ë¡œë“œ ì™„ë£Œ: ${workers.length}ëª…`);
    } catch (error) {
        console.error('âŒ ì‘ì—…ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        workers = []; // ì˜¤ë¥˜ ì‹œ ë¹ˆ ë°°ì—´ë¡œ ì´ˆê¸°í™”
    }
    
    // ë“±ë¡ëœ ì‘ì—…ì í˜„í™© í‘œì‹œ
    await loadWorkerStatus();
}

async function loadWorkerStatus() {
    try {
        const statusDiv = document.getElementById('worker-status-table');
        
        if (!workers.length) {
            statusDiv.innerHTML = '<p class="text-gray-500">ë“±ë¡ëœ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        // ë²•ì¸ë³„ë¡œ ê·¸ë£¹í™”
        const byEntity = {};
        workers.forEach(worker => {
            if (!byEntity[worker.entity]) {
                byEntity[worker.entity] = [];
            }
            byEntity[worker.entity].push(worker);
        });
        
        // í…Œì´ë¸” ìƒì„±
        let tableHTML = `
            <div class="space-y-4">
        `;
        
        // ë²•ì¸ë³„ë¡œ í…Œì´ë¸” ìƒì„±
        Object.keys(byEntity).sort().forEach(entity => {
            const entityWorkers = byEntity[entity];
            const entityId = entity.replace(/\s+/g, '-'); // ê³µë°±ì„ í•˜ì´í”ˆìœ¼ë¡œ ë³€ê²½í•˜ì—¬ ID ìƒì„±
            
            // í•´ë‹¹ ë²•ì¸ì˜ ê³ ìœ í•œ íŒ€/ì§ì±… ëª©ë¡ ì¶”ì¶œ
            const workerTeams = [...new Set(entityWorkers.map(w => w.team))];
            const workerPositions = [...new Set(entityWorkers.map(w => w.position))];
            
            // í‘œì¤€ ìˆœì„œì— ë”°ë¼ ì •ë ¬ (ì¡´ì¬í•˜ëŠ” ê²ƒë§Œ)
            const uniqueTeams = STANDARD_TEAM_ORDER.filter(team => workerTeams.includes(team));
            const uniquePositions = STANDARD_POSITION_ORDER.filter(pos => workerPositions.includes(pos));
            
            tableHTML += `
                <div class="border border-gray-200 rounded-lg overflow-hidden">
                    <!-- í´ë¦­ ê°€ëŠ¥í•œ í—¤ë” -->
                    <div class="bg-blue-50 px-6 py-3 border-b border-gray-200 cursor-pointer hover:bg-blue-100 transition" 
                         onclick="toggleEntityList('${entityId}')">
                        <div class="flex items-center justify-between">
                            <h4 class="text-lg font-bold text-gray-800">
                                <i class="fas fa-building mr-2"></i>
                                ${entity} (${entityWorkers.length}ëª…)
                            </h4>
                            <i id="chevron-${entityId}" class="fas fa-chevron-down text-gray-600 transition-transform"></i>
                        </div>
                    </div>
                    
                    <!-- ì ‘ì„ ìˆ˜ ìˆëŠ” í…Œì´ë¸” ì»¨í…ì¸  -->
                    <div id="entity-${entityId}" class="entity-content">
                        <!-- í•„í„° ì˜ì—­ -->
                        <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-3">
                                <!-- Team Filter -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">TEAM</label>
                                    <select id="filter-team-${entityId}" onchange="applyWorkerFilter('${entityId}')"
                                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">All</option>
                                        ${uniqueTeams.map(team => `<option value="${team}">${team}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- Position Filter -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">POSITION</label>
                                    <select id="filter-position-${entityId}" onchange="applyWorkerFilter('${entityId}')"
                                            class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                        <option value="">All</option>
                                        ${uniquePositions.map(pos => `<option value="${pos}">${pos}</option>`).join('')}
                                    </select>
                                </div>
                                
                                <!-- Start Date -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">START DATE (From)</label>
                                    <input type="date" id="filter-date-start-${entityId}" onchange="applyWorkerFilter('${entityId}')"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <!-- End Date -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">START DATE (To)</label>
                                    <input type="date" id="filter-date-end-${entityId}" onchange="applyWorkerFilter('${entityId}')"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                                
                                <!-- Search -->
                                <div>
                                    <label class="block text-xs font-medium text-gray-700 mb-1">NAME/EMPLOYEE ID</label>
                                    <input type="text" id="filter-search-${entityId}" oninput="applyWorkerFilter('${entityId}')"
                                           placeholder="Search"
                                           class="w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                </div>
                            </div>
                            
                            <!-- Reset Filter Button -->
                            <div class="mt-3 text-right">
                                <button onclick="resetWorkerFilter('${entityId}')" 
                                        class="px-4 py-2 text-xs text-gray-700 bg-white border border-gray-300 rounded-lg hover:bg-gray-50">
                                    <i class="fas fa-redo mr-1"></i>Reset Filters
                                </button>
                            </div>
                        </div>
                        
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">NAME</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">EMPLOYEE ID</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">TEAM</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">POSITION</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">START DATE</th>
                                    <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">ACTIONS</th>
                                </tr>
                            </thead>
                            <tbody class="bg-white divide-y divide-gray-200">
            `;
            
            // ì…ì‚¬ì¼ ê¸°ì¤€ ì •ë ¬ (ìµœì‹ ìˆœ)
            entityWorkers.sort((a, b) => {
                const dateA = new Date(a.start_to_work_date);
                const dateB = new Date(b.start_to_work_date);
                return dateB - dateA;
            });
            
            entityWorkers.forEach(worker => {
                const startDate = new Date(worker.start_to_work_date).toLocaleDateString('ko-KR');
                tableHTML += `
                    <tr class="worker-row" 
                        data-entity-id="${entityId}"
                        data-team="${worker.team}" 
                        data-position="${worker.position}" 
                        data-date="${worker.start_to_work_date}"
                        data-name="${worker.name.toLowerCase()}"
                        data-employee-id="${worker.employee_id.toLowerCase()}">
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${worker.name}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${worker.employee_id}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${worker.team}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${worker.position}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${startDate}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm font-medium">
                            <button onclick="editWorker(${worker.id})" class="text-blue-600 hover:text-blue-900 mr-3">
                                <i class="fas fa-edit"></i> ìˆ˜ì •
                            </button>
                            <button onclick="deleteWorker(${worker.id}, '${worker.name}')" class="text-red-600 hover:text-red-900">
                                <i class="fas fa-trash"></i> ì‚­ì œ
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            tableHTML += `
                            </tbody>
                        </table>
                    </div>
                </div>
            `;
        });
        
        tableHTML += `
            </div>
        `;
        
        statusDiv.innerHTML = tableHTML;
    } catch (error) {
        console.error('ì‘ì—…ì í˜„í™© ë¡œë“œ ì‹¤íŒ¨:', error);
        document.getElementById('worker-status-table').innerHTML = 
            '<p class="text-red-500">í˜„í™©ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

// ë²•ì¸ë³„ ë¦¬ìŠ¤íŠ¸ ì—´ê¸°/ë‹«ê¸° í† ê¸€ í•¨ìˆ˜
function toggleEntityList(entityId) {
    const contentDiv = document.getElementById(`entity-${entityId}`);
    const chevron = document.getElementById(`chevron-${entityId}`);
    
    if (contentDiv.style.display === 'none') {
        contentDiv.style.display = 'block';
        chevron.classList.remove('fa-chevron-right');
        chevron.classList.add('fa-chevron-down');
    } else {
        contentDiv.style.display = 'none';
        chevron.classList.remove('fa-chevron-down');
        chevron.classList.add('fa-chevron-right');
    }
}

// ì‘ì—…ì í•„í„° ì ìš© í•¨ìˆ˜
function applyWorkerFilter(entityId) {
    // í•„í„° ê°’ ê°€ì ¸ì˜¤ê¸°
    const teamFilter = document.getElementById(`filter-team-${entityId}`).value.toLowerCase();
    const positionFilter = document.getElementById(`filter-position-${entityId}`).value.toLowerCase();
    const dateStartFilter = document.getElementById(`filter-date-start-${entityId}`).value;
    const dateEndFilter = document.getElementById(`filter-date-end-${entityId}`).value;
    const searchFilter = document.getElementById(`filter-search-${entityId}`).value.toLowerCase();
    
    // í•´ë‹¹ ë²•ì¸ì˜ ëª¨ë“  ì‘ì—…ì í–‰ ê°€ì ¸ì˜¤ê¸°
    const rows = document.querySelectorAll(`tr.worker-row[data-entity-id="${entityId}"]`);
    
    let visibleCount = 0;
    
    rows.forEach(row => {
        const team = row.dataset.team.toLowerCase();
        const position = row.dataset.position.toLowerCase();
        const date = row.dataset.date;
        const name = row.dataset.name;
        const employeeId = row.dataset.employeeId;
        
        // ê° í•„í„° ì¡°ê±´ í™•ì¸
        const teamMatch = !teamFilter || team === teamFilter;
        const positionMatch = !positionFilter || position === positionFilter;
        const searchMatch = !searchFilter || name.includes(searchFilter) || employeeId.includes(searchFilter);
        
        // ë‚ ì§œ ë²”ìœ„ í™•ì¸
        let dateMatch = true;
        if (dateStartFilter || dateEndFilter) {
            const workerDate = new Date(date);
            if (dateStartFilter) {
                const startDate = new Date(dateStartFilter);
                if (workerDate < startDate) dateMatch = false;
            }
            if (dateEndFilter) {
                const endDate = new Date(dateEndFilter);
                if (workerDate > endDate) dateMatch = false;
            }
        }
        
        // ëª¨ë“  ì¡°ê±´ì„ ë§Œì¡±í•˜ë©´ í‘œì‹œ, ì•„ë‹ˆë©´ ìˆ¨ê¹€
        if (teamMatch && positionMatch && dateMatch && searchMatch) {
            row.style.display = '';
            visibleCount++;
        } else {
            row.style.display = 'none';
        }
    });
    
    console.log(`í•„í„° ì ìš© ì™„ë£Œ: ${visibleCount}ëª… í‘œì‹œ (ë²•ì¸: ${entityId})`);
}

// ì‘ì—…ì í•„í„° ì´ˆê¸°í™” í•¨ìˆ˜
function resetWorkerFilter(entityId) {
    // í•„í„° ê°’ ì´ˆê¸°í™”
    document.getElementById(`filter-team-${entityId}`).value = '';
    document.getElementById(`filter-position-${entityId}`).value = '';
    document.getElementById(`filter-date-start-${entityId}`).value = '';
    document.getElementById(`filter-date-end-${entityId}`).value = '';
    document.getElementById(`filter-search-${entityId}`).value = '';
    
    // í•„í„° ì ìš© (ëª¨ë“  í–‰ í‘œì‹œ)
    applyWorkerFilter(entityId);
}

// ì‘ì—…ì ìˆ˜ì • í•¨ìˆ˜
async function editWorker(workerId) {
    try {
        // í•´ë‹¹ ì‘ì—…ì ì •ë³´ ì°¾ê¸°
        const worker = workers.find(w => w.id === workerId);
        if (!worker) {
            alert('ì‘ì—…ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // ëª¨ë‹¬ HTML ìƒì„±
        const modalHTML = `
            <div id="edit-worker-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50" onclick="closeEditWorkerModal(event)">
                <div class="relative top-20 mx-auto p-8 border w-11/12 md:w-2/3 lg:w-1/2 shadow-lg rounded-lg bg-white" onclick="event.stopPropagation()">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-2xl font-bold text-gray-900">
                            <i class="fas fa-user-edit mr-2"></i>
                            ì‘ì—…ì ì •ë³´ ìˆ˜ì •
                        </h3>
                        <button onclick="closeEditWorkerModal()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times text-2xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì‚¬ë²ˆ</label>
                            <input type="text" id="edit-employee-id" value="${worker.employee_id}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì´ë¦„</label>
                            <input type="text" id="edit-name" value="${worker.name}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ë²•ì¸</label>
                            <select id="edit-entity" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="CSVN" ${worker.entity === 'CSVN' ? 'selected' : ''}>CSVN</option>
                                <option value="CSCN" ${worker.entity === 'CSCN' ? 'selected' : ''}>CSCN</option>
                                <option value="CSTW" ${worker.entity === 'CSTW' ? 'selected' : ''}>CSTW</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">íŒ€</label>
                            <input type="text" id="edit-team" value="${worker.team}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì§ì±… (Position)</label>
                            <select id="edit-position" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                                <option value="Cutting" ${worker.position === 'Cutting' ? 'selected' : ''}>Cutting</option>
                                <option value="Beveling" ${worker.position === 'Beveling' ? 'selected' : ''}>Beveling</option>
                                <option value="Bending" ${worker.position === 'Bending' ? 'selected' : ''}>Bending</option>
                                <option value="LS Welding" ${worker.position === 'LS Welding' ? 'selected' : ''}>LS Welding</option>
                                <option value="Fit Up" ${worker.position === 'Fit Up' || worker.position === 'Fit-up' ? 'selected' : ''}>Fit Up</option>
                                <option value="CS Welding" ${worker.position === 'CS Welding' ? 'selected' : ''}>CS Welding</option>
                                <option value="VTMT" ${worker.position === 'VTMT' ? 'selected' : ''}>VTMT</option>
                                <option value="Bracket FU" ${worker.position === 'Bracket FU' ? 'selected' : ''}>Bracket FU</option>
                                <option value="Bracket Weld" ${worker.position === 'Bracket Weld' ? 'selected' : ''}>Bracket Weld</option>
                                <option value="UT repair" ${worker.position === 'UT repair' ? 'selected' : ''}>UT repair</option>
                                <option value="DF FU" ${worker.position === 'DF FU' ? 'selected' : ''}>DF FU</option>
                                <option value="DF Weld" ${worker.position === 'DF Weld' ? 'selected' : ''}>DF Weld</option>
                                <option value="Flatness" ${worker.position === 'Flatness' ? 'selected' : ''}>Flatness</option>
                            </select>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">ì…ì‚¬ì¼</label>
                            <input type="date" id="edit-start-date" value="${worker.start_to_work_date}" 
                                   class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        </div>
                    </div>
                    
                    <div class="flex justify-end space-x-3 mt-6">
                        <button onclick="closeEditWorkerModal()" 
                                class="px-6 py-2 bg-gray-300 hover:bg-gray-400 text-gray-800 font-semibold rounded-lg transition">
                            ì·¨ì†Œ
                        </button>
                        <button onclick="saveWorkerEdit(${workerId})" 
                                class="px-6 py-2 bg-blue-500 hover:bg-blue-600 text-white font-semibold rounded-lg transition">
                            <i class="fas fa-save mr-2"></i>ì €ì¥
                        </button>
                    </div>
                </div>
            </div>
        `;
        
        // ëª¨ë‹¬ ì¶”ê°€
        document.body.insertAdjacentHTML('beforeend', modalHTML);
        
    } catch (error) {
        console.error('ì‘ì—…ì ìˆ˜ì • ëª¨ë‹¬ ì—´ê¸° ì‹¤íŒ¨:', error);
        alert('ì‘ì—…ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// ìˆ˜ì • ëª¨ë‹¬ ë‹«ê¸°
function closeEditWorkerModal(event) {
    if (event && event.target.id !== 'edit-worker-modal') return;
    const modal = document.getElementById('edit-worker-modal');
    if (modal) {
        modal.remove();
    }
}

// ì‘ì—…ì ìˆ˜ì • ì €ì¥
async function saveWorkerEdit(workerId) {
    try {
        const updatedWorker = {
            employee_id: document.getElementById('edit-employee-id').value.trim(),
            name: document.getElementById('edit-name').value.trim(),
            entity: document.getElementById('edit-entity').value,
            team: document.getElementById('edit-team').value.trim().toLowerCase(),
            position: document.getElementById('edit-position').value,
            start_to_work_date: document.getElementById('edit-start-date').value
        };
        
        // í•„ìˆ˜ í•­ëª© ê²€ì¦
        if (!updatedWorker.employee_id || !updatedWorker.name || !updatedWorker.team || !updatedWorker.start_to_work_date) {
            alert('ëª¨ë“  í•„ìˆ˜ í•­ëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            return;
        }
        
        const response = await axios.put(`/api/workers/${workerId}`, updatedWorker);
        
        if (response.data.success) {
            alert('âœ… ì‘ì—…ì ì •ë³´ê°€ ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤.');
            closeEditWorkerModal();
            await loadWorkers();
            await loadWorkerStatus();
        }
    } catch (error) {
        console.error('ì‘ì—…ì ìˆ˜ì • ì‹¤íŒ¨:', error);
        alert('ì‘ì—…ì ìˆ˜ì •ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (error.response?.data?.error || error.message));
    }
}

// ì‘ì—…ì ì‚­ì œ
async function deleteWorker(workerId, workerName) {
    if (!confirm(`âš ï¸ "${workerName}" ì‘ì—…ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nì´ ì‘ì—…ìì™€ ê´€ë ¨ëœ ëª¨ë“  ì‹œí—˜ ê²°ê³¼ ë° í‰ê°€ ê¸°ë¡ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤.\n\nì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.`)) {
        return;
    }
    
    // 2ì°¨ í™•ì¸
    if (!confirm(`ì •ë§ë¡œ "${workerName}" ì‘ì—…ìë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
        return;
    }
    
    try {
        const response = await axios.delete(`/api/workers/${workerId}`);
        
        if (response.data.success) {
            alert(`âœ… "${workerName}" ì‘ì—…ìê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.`);
            await loadWorkers();
            await loadWorkerStatus();
        }
    } catch (error) {
        console.error('ì‘ì—…ì ì‚­ì œ ì‹¤íŒ¨:', error);
        alert('ì‘ì—…ì ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ' + (error.response?.data?.error || error.message));
    }
}

function getWorkerUploadHTML() {
    return `
        <div class="space-y-6">
            <!-- ë“±ë¡ëœ ì‘ì—…ì í˜„í™© -->
            <div class="bg-white rounded-lg shadow-md p-6">
                <h3 class="text-xl font-bold text-gray-800 mb-4">
                    <i class="fas fa-list-check mr-2"></i>
                    ë“±ë¡ëœ ì‘ì—…ì í˜„í™©
                </h3>
                <div id="worker-status-table" class="overflow-x-auto">
                    <p class="text-gray-500">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            
            <!-- Upload Section -->
            <div class="bg-white rounded-lg shadow-md p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-users mr-2"></i>
                Worker Registration
            </h2>
            
            <div class="mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                    <p class="text-sm text-blue-700 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Supported Format 1:</strong> No, Entity, Name, Employee ID, Team, Position, Start to work date
                    </p>
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Supported Format 2:</strong> Name, Employee ID, Company, Department, Position, start to work (auto-converted)
                    </p>
                </div>
                
                <label class="block text-gray-700 font-semibold mb-2">
                    Select Excel File
                </label>
                <input type="file" id="worker-file" accept=".xlsx,.xls" 
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-lg file:border-0
                              file:text-sm file:font-semibold
                              file:bg-blue-50 file:text-blue-700
                              hover:file:bg-blue-100
                              cursor-pointer">
            </div>
            
            <div class="mb-6">
                <button onclick="downloadWorkerTemplate()" 
                        class="bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md transition">
                    <i class="fas fa-download mr-2"></i>
                    Download Template
                </button>
            </div>
            
            <button onclick="uploadWorkers()" 
                    class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition">
                <i class="fas fa-upload mr-2"></i>
                Upload Workers
            </button>
        </div>
    `;
}

function downloadWorkerTemplate() {
    const wb = XLSX.utils.book_new();
    const ws_data = [
        ['No', 'Entity', 'Name', 'Employee ID', 'Team', 'Position', 'Start to work date'],
        [1, 'Seoul HQ', 'ê¹€ì² ìˆ˜', 'EMP001', 'Assembly Team', 'Operator', '2023-01-15']
    ];
    const ws = XLSX.utils.aoa_to_sheet(ws_data);
    XLSX.utils.book_append_sheet(wb, ws, 'Workers');
    XLSX.writeFile(wb, 'worker_template.xlsx');
}

async function uploadWorkers() {
    const fileInput = document.getElementById('worker-file');
    if (!fileInput.files.length) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            console.log('ğŸ“‚ íŒŒì¼ ì½ê¸° ì‹œì‘...');
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet);
            
            console.log(`ğŸ“Š ì½ì€ í–‰ ìˆ˜: ${rows.length}ê°œ`);
            
            if (rows.length === 0) {
                alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // ì²« ë²ˆì§¸ í–‰ì˜ ì»¬ëŸ¼ í™•ì¸í•˜ì—¬ í˜•ì‹ ê°ì§€
            const firstRow = rows[0];
            console.log('ğŸ” ì²« ë²ˆì§¸ í–‰ ì»¬ëŸ¼:', Object.keys(firstRow));
            console.log('ğŸ” ì²« ë²ˆì§¸ ë°ì´í„° ìƒ˜í”Œ:', firstRow);
            
            // ì»¬ëŸ¼ëª…ì„ ëŒ€ì†Œë¬¸ì ë¬´ì‹œí•˜ê³  ì°¾ëŠ” í—¬í¼ í•¨ìˆ˜
            const findColumn = (row, ...possibleNames) => {
                for (const name of possibleNames) {
                    const key = Object.keys(row).find(k => k.toUpperCase() === name.toUpperCase());
                    if (key) return row[key];
                }
                return null;
            };
            
            let workers = [];
            
            // í˜•ì‹ 1: No, Entity, Name, Employee ID, Team, Position, Start to work date
            const hasEntity = findColumn(firstRow, 'Entity') !== null;
            const hasTeam = findColumn(firstRow, 'Team') !== null;
            
            if (hasEntity && hasTeam) {
                console.log('âœ… í˜•ì‹ 1 ê°ì§€ (Entity, Team ì»¬ëŸ¼ ì¡´ì¬)');
                workers = rows.map((row, idx) => {
                    const worker = {
                        employee_id: String(findColumn(row, 'Employee ID') || '').trim(),
                        name: String(findColumn(row, 'Name') || '').trim(),
                        entity: String(findColumn(row, 'Entity') || '').trim(),
                        team: String(findColumn(row, 'Team') || '').trim(),
                        position: String(findColumn(row, 'Position') || '').trim(),
                        start_to_work_date: convertExcelDate(findColumn(row, 'Start to work date', 'Start to work', 'Start Date'))
                    };
                    
                    // ì²˜ìŒ 3ê°œ ë°ì´í„° ë””ë²„ê¹…
                    if (idx < 3) {
                        console.log(`ğŸ“‹ í–‰ ${idx + 2} ë³€í™˜ ê²°ê³¼:`, worker);
                    }
                    
                    return worker;
                });
            }
            // í˜•ì‹ 2: Name, Employee ID, Company, Department, Position, start to work
            else if (findColumn(firstRow, 'Company') !== null && findColumn(firstRow, 'Department') !== null) {
                console.log('âœ… í˜•ì‹ 2 ê°ì§€ (Company, Department ì»¬ëŸ¼ ì¡´ì¬)');
                workers = rows.map((row, idx) => {
                    const worker = {
                        employee_id: String(findColumn(row, 'Employee ID') || '').trim(),
                        name: String(findColumn(row, 'Name') || '').trim(),
                        entity: String(findColumn(row, 'Company') || '').trim(),
                        team: String(findColumn(row, 'Department') || '').trim(),
                        position: String(findColumn(row, 'Position') || '').trim(),
                        start_to_work_date: convertExcelDate(findColumn(row, 'start to work', 'Start Date'))
                    };
                    
                    if (idx < 3) {
                        console.log(`ğŸ“‹ í–‰ ${idx + 2} ë³€í™˜ ê²°ê³¼:`, worker);
                    }
                    
                    return worker;
                });
            } else {
                const availableColumns = Object.keys(firstRow).join(', ');
                console.error('âŒ ì§€ì›í•˜ì§€ ì•ŠëŠ” í˜•ì‹. ë°œê²¬ëœ ì»¬ëŸ¼:', availableColumns);
                alert(`ì§€ì›í•˜ì§€ ì•ŠëŠ” ì—‘ì…€ íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤.\n\në°œê²¬ëœ ì»¬ëŸ¼: ${availableColumns}\n\nì§€ì› í˜•ì‹:\n1. No, Entity, Name, Employee ID, Team, Position, Start to work date\n2. Name, Employee ID, Company, Department, Position, start to work`);
                return;
            }
            
            console.log(`âœ… ì´ ${workers.length}ê°œ ë°ì´í„° ë³€í™˜ ì™„ë£Œ`);
            
            // í•„ìˆ˜ í•­ëª© ê²€ì¦
            for (let i = 0; i < workers.length; i++) {
                const worker = workers[i];
                const missingFields = [];
                
                if (!worker.employee_id) missingFields.push('ì‚¬ë²ˆ');
                if (!worker.name) missingFields.push('ì´ë¦„');
                if (!worker.entity) missingFields.push('ë²•ì¸');
                if (!worker.team) missingFields.push('íŒ€');
                if (!worker.position) missingFields.push('ì§ì±…');
                if (!worker.start_to_work_date) missingFields.push('ì…ì‚¬ì¼');
                
                if (missingFields.length > 0) {
                    console.error(`âŒ í–‰ ${i + 2} ê²€ì¦ ì‹¤íŒ¨:`, worker);
                    alert(`${i + 2}ë²ˆì§¸ í–‰ì— í•„ìˆ˜ í•­ëª©ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤.\n\nëˆ„ë½ëœ í•­ëª©: ${missingFields.join(', ')}\n\ní•´ë‹¹ í–‰ ë°ì´í„°:\nì‚¬ë²ˆ: ${worker.employee_id}\nì´ë¦„: ${worker.name}\në²•ì¸: ${worker.entity}\níŒ€: ${worker.team}\nì§ì±…: ${worker.position}\nì…ì‚¬ì¼: ${worker.start_to_work_date}`);
                    return;
                }
            }
            
            console.log('âœ… í•„ìˆ˜ í•­ëª© ê²€ì¦ í†µê³¼');
            console.log('ğŸ“¤ API ì „ì†¡ ì‹œì‘...', workers.slice(0, 2)); // ì²˜ìŒ 2ê°œë§Œ ë¡œê·¸
            
            const response = await axios.post('/api/workers/bulk', workers);
            
            console.log('ğŸ‰ ì—…ë¡œë“œ ì„±ê³µ:', response.data);
            alert(`âœ… ${response.data.count}ëª…ì˜ ì‘ì—…ìê°€ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            
            fileInput.value = '';
            await loadWorkers();
            await loadWorkerStatus();
        } catch (error) {
            console.error('âŒ ì‘ì—…ì ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            console.error('ì—ëŸ¬ ìƒì„¸:', {
                message: error.message,
                response: error.response?.data,
                status: error.response?.status
            });
            
            let errorMessage = 'ì‘ì—…ì ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
            
            if (error.response?.status === 500) {
                errorMessage += 'ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.\n';
                errorMessage += `ìƒì„¸: ${error.response.data?.error || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜'}`;
            } else if (error.response?.status === 400) {
                errorMessage += 'ì˜ëª»ëœ ë°ì´í„° í˜•ì‹ì…ë‹ˆë‹¤.\n';
                errorMessage += `ìƒì„¸: ${error.response.data?.error || 'ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”'}`;
            } else {
                errorMessage += `ì˜¤ë¥˜: ${error.message}`;
            }
            
            alert(errorMessage);
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// ==================== Supervisor Assessment ì‹œí–‰ í˜ì´ì§€ ====================

let assessmentItems = [];
let currentAssessmentIndex = 0;
let assessmentResults = [];

function getSupervisorAssessmentHTML() {
    return `
        <div class="bg-white rounded-lg shadow-md p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-user-check mr-2"></i>
                Supervisor Assessment ì‹œí–‰
            </h2>
            
            <div id="assessment-selection" class="space-y-6">
                <!-- 1ë‹¨ê³„: ë²•ì¸ ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="bg-blue-500 text-white rounded-full px-2 py-0.5 text-xs mr-2">1</span>
                        ë²•ì¸ ì„ íƒ
                    </label>
                    <select id="sa-entity-select" onchange="onSAEntityChange()" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ë²•ì¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="CSVN">CSVN</option>
                        <option value="CSCN">CSCN</option>
                        <option value="CSTW">CSTW</option>
                    </select>
                </div>
                
                <!-- 2ë‹¨ê³„: íŒ€ ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="bg-blue-500 text-white rounded-full px-2 py-0.5 text-xs mr-2">2</span>
                        íŒ€ ì„ íƒ
                    </label>
                    <select id="sa-team-select" onchange="onSATeamChange()" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">ë¨¼ì € ë²•ì¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <!-- 3ë‹¨ê³„: í”„ë¡œì„¸ìŠ¤ ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="bg-blue-500 text-white rounded-full px-2 py-0.5 text-xs mr-2">3</span>
                        í”„ë¡œì„¸ìŠ¤ ì„ íƒ
                    </label>
                    <select id="sa-process-select" onchange="onSAProcessChange()" 
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">ë¨¼ì € íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <!-- 4ë‹¨ê³„: ì‘ì—…ì ì„ íƒ -->
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <span class="bg-blue-500 text-white rounded-full px-2 py-0.5 text-xs mr-2">4</span>
                        ì‘ì—…ì ì„ íƒ
                    </label>
                    <select id="sa-worker-select" onchange="onSAWorkerChange()"
                            class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" disabled>
                        <option value="">ë¨¼ì € í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <!-- ì´ì „ í‰ê°€ ì´ë ¥ í‘œì‹œ -->
                <div id="sa-history-container" class="hidden">
                    <div class="bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded">
                        <div class="flex items-start">
                            <i class="fas fa-history text-yellow-600 mt-1 mr-3"></i>
                            <div class="flex-1">
                                <h4 class="text-sm font-semibold text-yellow-800 mb-2">
                                    ì´ì „ í‰ê°€ ì´ë ¥
                                </h4>
                                <div id="sa-history-content" class="text-sm text-yellow-700">
                                    <!-- í‰ê°€ ì´ë ¥ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- í‰ê°€ ì‹œì‘ ë²„íŠ¼ -->
                <button onclick="startAssessment()" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">
                    <i class="fas fa-play mr-2"></i>í‰ê°€ ì‹œì‘
                </button>
            </div>
            
            <!-- í‰ê°€ ì§„í–‰ ì˜ì—­ -->
            <div id="assessment-progress" class="hidden">
                <div class="mb-6">
                    <div class="flex justify-between items-center mb-2">
                        <span class="text-sm font-medium text-gray-700">ì§„í–‰ë¥ </span>
                        <span id="progress-text" class="text-sm font-medium text-blue-600">0 / 0</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-3">
                        <div id="progress-bar" class="bg-blue-600 h-3 rounded-full transition-all" style="width: 0%"></div>
                    </div>
                </div>
                
                <div id="assessment-item-container" class="bg-gray-50 rounded-lg p-6 mb-6">
                    <!-- í‰ê°€ í•­ëª©ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
                
                <div class="flex gap-4">
                    <button onclick="markAsSatisfied()" 
                            class="flex-1 bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-check mr-2"></i>ë§Œì¡±
                    </button>
                    <button onclick="markAsUnsatisfied()" 
                            class="flex-1 bg-red-600 hover:bg-red-700 text-white font-bold py-3 px-6 rounded-lg transition">
                        <i class="fas fa-times mr-2"></i>ë¶ˆë§Œì¡±
                    </button>
                </div>
            </div>
            
            <!-- í‰ê°€ ì™„ë£Œ ì˜ì—­ -->
            <div id="assessment-complete" class="hidden">
                <div class="bg-green-50 border-2 border-green-500 rounded-lg p-6 mb-6">
                    <h3 class="text-2xl font-bold text-green-800 mb-4">
                        <i class="fas fa-check-circle mr-2"></i>í‰ê°€ ì™„ë£Œ!
                    </h3>
                    <div id="assessment-summary" class="space-y-3">
                        <!-- í‰ê°€ ê²°ê³¼ ìš”ì•½ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                    </div>
                </div>
                
                <button onclick="showPage('supervisor-assessment')" 
                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg transition">
                    <i class="fas fa-redo mr-2"></i>ìƒˆë¡œìš´ í‰ê°€ ì‹œì‘
                </button>
            </div>
        </div>
        
        <!-- Supervisor Assessment ê²°ê³¼ ë“±ë¡ ì„¹ì…˜ -->
        <div class="bg-white rounded-lg shadow-md p-8 mt-6">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-file-excel mr-2"></i>
                Supervisor Assessment ê²°ê³¼ ë“±ë¡
            </h2>
            
            <div class="mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                    <p class="text-sm text-blue-700 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>ì—‘ì…€ íŒŒì¼ í˜•ì‹:</strong> No., ì‚¬ë²ˆ, ì´ë¦„, ë²•ì¸, íŒ€, í”„ë¡œì„¸ìŠ¤, Lv ì¹´í…Œê³ ë¦¬, í‰ê°€í•­ëª©, í‰ê°€ ê²°ê³¼, í‰ê°€ì¼ì
                    </p>
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-lightbulb mr-2"></i>
                        ê¸°ì¡´ì— ì§„í–‰í•œ Supervisor Assessment ê²°ê³¼ë¥¼ ì¼ê´„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
                
                <label class="block text-gray-700 font-semibold mb-2">
                    ì—‘ì…€ íŒŒì¼ ì„ íƒ
                </label>
                <input type="file" id="assessment-result-file" accept=".xlsx,.xls" 
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-lg file:border-0
                              file:text-sm file:font-semibold
                              file:bg-green-50 file:text-green-700
                              hover:file:bg-green-100
                              cursor-pointer">
            </div>
            
            <button onclick="uploadAssessmentResults()" 
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition">
                <i class="fas fa-upload mr-2"></i>
                ê²°ê³¼ ì—…ë¡œë“œ
            </button>
        </div>
    `;
}

async function loadSupervisorAssessmentPage() {
    // ì‘ì—…ì ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ë¡œë“œ
    if (!workers || workers.length === 0) {
        try {
            const response = await axios.get('/api/workers');
            workers = response.data;
        } catch (error) {
            console.error('ì‘ì—…ì ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ì‘ì—…ì ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            return;
        }
    }
    
    console.log(`ì‘ì—…ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ: ${workers.length}ëª…`);
}

// 1ë‹¨ê³„: ë²•ì¸ ì„ íƒ ì‹œ - íŒ€ í•„í„°ë§
function onSAEntityChange() {
    const entitySelect = document.getElementById('sa-entity-select');
    const teamSelect = document.getElementById('sa-team-select');
    const processSelect = document.getElementById('sa-process-select');
    const workerSelect = document.getElementById('sa-worker-select');
    const selectedEntity = entitySelect.value;
    
    // íŒ€, í”„ë¡œì„¸ìŠ¤, ì‘ì—…ì ì„ íƒ ì´ˆê¸°í™”
    teamSelect.innerHTML = '<option value="">íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    processSelect.innerHTML = '<option value="">ë¨¼ì € íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    workerSelect.innerHTML = '<option value="">ë¨¼ì € í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    processSelect.disabled = true;
    workerSelect.disabled = true;
    
    if (!selectedEntity) {
        teamSelect.disabled = true;
        teamSelect.innerHTML = '<option value="">ë¨¼ì € ë²•ì¸ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    // ì„ íƒëœ ë²•ì¸ì˜ íŒ€ ëª©ë¡ ì¶”ì¶œ
    const entityWorkers = workers.filter(w => w.entity === selectedEntity);
    const availableTeams = new Set();
    
    entityWorkers.forEach(worker => {
        if (worker.team) {
            availableTeams.add(worker.team);
        }
    });
    
    // íŒ€ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° (ì•ŒíŒŒë²³ ìˆœ ì •ë ¬)
    const sortedTeams = Array.from(availableTeams).sort();
    sortedTeams.forEach(team => {
        const option = document.createElement('option');
        option.value = team; // DB ê°’ (ì†Œë¬¸ì)
        option.textContent = formatTeamName(team); // í‘œì‹œ ê°’ (ë³´ê¸° ì¢‹ê²Œ)
        teamSelect.appendChild(option);
    });
    
    // íŒ€ ì„ íƒ í™œì„±í™”
    teamSelect.disabled = false;
    
    console.log(`ë²•ì¸ "${selectedEntity}" ì„ íƒ ì™„ë£Œ. ì‚¬ìš© ê°€ëŠ¥í•œ íŒ€: ${sortedTeams.length}ê°œ`);
}

// 2ë‹¨ê³„: íŒ€ ì„ íƒ ì‹œ - í”„ë¡œì„¸ìŠ¤ í•„í„°ë§ (Team-Process ë§¤í•‘ í…Œì´ë¸” ì‚¬ìš©)
function onSATeamChange() {
    const entitySelect = document.getElementById('sa-entity-select');
    const teamSelect = document.getElementById('sa-team-select');
    const processSelect = document.getElementById('sa-process-select');
    const workerSelect = document.getElementById('sa-worker-select');
    const selectedEntity = entitySelect.value;
    const selectedTeam = teamSelect.value;
    
    // í”„ë¡œì„¸ìŠ¤ì™€ ì‘ì—…ì ì„ íƒ ì´ˆê¸°í™”
    processSelect.innerHTML = '<option value="">í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    workerSelect.innerHTML = '<option value="">ë¨¼ì € í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    workerSelect.disabled = true;
    
    if (!selectedTeam) {
        processSelect.disabled = true;
        processSelect.innerHTML = '<option value="">ë¨¼ì € íŒ€ì„ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    // Team-Process ë§¤í•‘ í…Œì´ë¸”ì—ì„œ í•´ë‹¹ íŒ€ì˜ í”„ë¡œì„¸ìŠ¤ ê°€ì ¸ì˜¤ê¸°
    const availableProcesses = getProcessesForTeam(selectedTeam);
    
    if (availableProcesses.length === 0) {
        processSelect.innerHTML = '<option value="">í•´ë‹¹ íŒ€ì— ë“±ë¡ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤</option>';
        processSelect.disabled = true;
        console.warn(`íŒ€ "${selectedTeam}"ì— ë“±ë¡ëœ í”„ë¡œì„¸ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤.`);
        return;
    }
    
    // í”„ë¡œì„¸ìŠ¤ ë“œë¡­ë‹¤ìš´ ì±„ìš°ê¸° (ì •ì˜ëœ ìˆœì„œëŒ€ë¡œ)
    availableProcesses.forEach(processName => {
        const option = document.createElement('option');
        option.value = processName;
        option.textContent = processName;
        processSelect.appendChild(option);
    });
    
    // í”„ë¡œì„¸ìŠ¤ ì„ íƒ í™œì„±í™”
    processSelect.disabled = false;
    
    console.log(`íŒ€ "${selectedTeam}" ì„ íƒ ì™„ë£Œ. ì‚¬ìš© ê°€ëŠ¥í•œ í”„ë¡œì„¸ìŠ¤: ${availableProcesses.length}ê°œ`);
}

// 3ë‹¨ê³„: í”„ë¡œì„¸ìŠ¤ ì„ íƒ ì‹œ - ì‘ì—…ì í•„í„°ë§
function onSAProcessChange() {
    const entitySelect = document.getElementById('sa-entity-select');
    const teamSelect = document.getElementById('sa-team-select');
    const processSelect = document.getElementById('sa-process-select');
    const workerSelect = document.getElementById('sa-worker-select');
    const selectedEntity = entitySelect.value;
    const selectedTeam = teamSelect.value;
    const selectedProcess = processSelect.value;
    
    // ì‘ì—…ì ì„ íƒ ì´ˆê¸°í™”
    workerSelect.innerHTML = '<option value="">ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (!selectedProcess) {
        workerSelect.disabled = true;
        workerSelect.innerHTML = '<option value="">ë¨¼ì € í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
        return;
    }
    
    // ì„ íƒëœ ë²•ì¸ + íŒ€ì— ì†í•œ ëª¨ë“  ì‘ì—…ì í‘œì‹œ
    // (í”„ë¡œì„¸ìŠ¤ëŠ” íŒ€ì—ì„œ ì •ì˜ë˜ë¯€ë¡œ, íŒ€ì˜ ì‘ì—…ìëŠ” ëª¨ë‘ í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ë¥¼ ìˆ˜í–‰í•  ìˆ˜ ìˆìŒ)
    const filteredWorkers = workers.filter(worker => {
        if (worker.entity !== selectedEntity) return false;
        if (worker.team !== selectedTeam) return false;
        // ì„ íƒëœ íŒ€ì— ì†í•œ ëª¨ë“  ì‘ì—…ìë¥¼ í‘œì‹œ
        // position í•„ë“œì™€ í”„ë¡œì„¸ìŠ¤ ë§¤ì¹­ì€ ì„ íƒ ì‚¬í•­ìœ¼ë¡œ ì²˜ë¦¬
        return true;
    });
    
    // ì‘ì—…ì ì´ë¦„ìˆœ ì •ë ¬
    filteredWorkers.sort((a, b) => a.name.localeCompare(b.name));
    
    filteredWorkers.forEach(worker => {
        const option = document.createElement('option');
        option.value = worker.id;
        option.textContent = `${worker.name} (${worker.employee_id})`;
        workerSelect.appendChild(option);
    });
    
    // ì‘ì—…ì ì„ íƒ í™œì„±í™”
    workerSelect.disabled = false;
    
    if (filteredWorkers.length === 0) {
        workerSelect.innerHTML += '<option value="" disabled>í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì— ë“±ë¡ëœ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤</option>';
    }
    
    console.log(`í”„ë¡œì„¸ìŠ¤ "${selectedProcess}" ì„ íƒ ì™„ë£Œ. í•„í„°ë§ëœ ì‘ì—…ì: ${filteredWorkers.length}ëª…`);
}

// 4ë‹¨ê³„: ì‘ì—…ì ì„ íƒ ì‹œ - ì´ì „ í‰ê°€ ì´ë ¥ í‘œì‹œ
async function onSAWorkerChange() {
    const workerSelect = document.getElementById('sa-worker-select');
    const processSelect = document.getElementById('sa-process-select');
    const historyContainer = document.getElementById('sa-history-container');
    const historyContent = document.getElementById('sa-history-content');
    
    const workerId = workerSelect.value;
    const processName = processSelect.value;
    
    if (!workerId || !processName) {
        historyContainer.classList.add('hidden');
        return;
    }
    
    // í”„ë¡œì„¸ìŠ¤ ì´ë¦„ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ID ì°¾ê¸°
    const process = processes.find(p => p.name === processName);
    if (!process) {
        historyContainer.classList.add('hidden');
        return;
    }
    
    try {
        // ì´ì „ í‰ê°€ ì´ë ¥ ì¡°íšŒ
        const response = await axios.get(`/api/supervisor-assessment-history/${workerId}/${process.id}`);
        const history = response.data;
        
        if (history.length === 0) {
            historyContent.innerHTML = '<p>ì´ì „ í‰ê°€ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ë²ˆì§¸ í‰ê°€ë¥¼ ì§„í–‰í•˜ì„¸ìš”.</p>';
            historyContainer.classList.remove('hidden');
        } else {
            // ìµœì‹  í‰ê°€ ì •ë³´ í‘œì‹œ
            const latest = history[0];
            const assessmentDate = new Date(latest.assessment_date).toLocaleDateString('ko-KR', {
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
            
            historyContent.innerHTML = `
                <div class="space-y-2">
                    <p><strong>ì´ í‰ê°€ íšŸìˆ˜:</strong> ${history.length}íšŒ</p>
                    <p><strong>ìµœê·¼ í‰ê°€ì¼:</strong> ${assessmentDate}</p>
                    <p><strong>ìµœê·¼ í‰ê°€ í•­ëª© ìˆ˜:</strong> ${latest.total_items}ê°œ</p>
                    <p><strong>ìµœê·¼ í‰ê·  ë ˆë²¨:</strong> ${parseFloat(latest.average_level).toFixed(2)}</p>
                    <p class="mt-3 text-xs text-yellow-600">
                        <i class="fas fa-info-circle mr-1"></i>
                        ìƒˆë¡œìš´ í‰ê°€ë¥¼ ì§„í–‰í•˜ë©´ ì´ì „ ì´ë ¥ì€ ë³´ì¡´ë˜ê³  ìƒˆ í‰ê°€ê°€ ì¶”ê°€ë©ë‹ˆë‹¤.
                    </p>
                </div>
            `;
            historyContainer.classList.remove('hidden');
        }
    } catch (error) {
        console.error('í‰ê°€ ì´ë ¥ ì¡°íšŒ ì‹¤íŒ¨:', error);
        historyContainer.classList.add('hidden');
    }
}

async function startAssessment() {
    const workerId = document.getElementById('sa-worker-select').value;
    const processName = document.getElementById('sa-process-select').value;
    
    if (!workerId || !processName) {
        alert('ì‘ì—…ìì™€ í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // í”„ë¡œì„¸ìŠ¤ ì´ë¦„ìœ¼ë¡œ í”„ë¡œì„¸ìŠ¤ ID ì°¾ê¸°
    const process = processes.find(p => p.name === processName);
    if (!process) {
        alert('ì„ íƒí•œ í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    const processId = process.id;
    
    try {
        // í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ ëª¨ë“  assessment í•­ëª© ë¡œë“œ
        const response = await axios.get('/api/assessment-items');
        const allItems = response.data;
        
        // ì„ íƒí•œ í”„ë¡œì„¸ìŠ¤ì˜ í•­ëª©ë§Œ í•„í„°ë§ (ì¼ë°˜ í•­ëª© í¬í•¨)
        assessmentItems = allItems.filter(item => 
            item.process_id === parseInt(processId) || item.process_id === null
        );
        
        if (assessmentItems.length === 0) {
            alert('í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì— ë“±ë¡ëœ í‰ê°€ í•­ëª©ì´ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        // í•­ëª©ì„ ëœë¤í•˜ê²Œ ì„ê¸°
        assessmentItems = shuffleArray(assessmentItems);
        
        // í‰ê°€ ì´ˆê¸°í™”
        currentAssessmentIndex = 0;
        assessmentResults = [];
        
        // UI ì „í™˜
        document.getElementById('assessment-selection').classList.add('hidden');
        document.getElementById('assessment-progress').classList.remove('hidden');
        
        // ì²« ë²ˆì§¸ í•­ëª© í‘œì‹œ
        showAssessmentItem();
        
    } catch (error) {
        console.error('Assessment ì‹œì‘ ì‹¤íŒ¨:', error);
        alert('í‰ê°€ë¥¼ ì‹œì‘í•˜ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function showAssessmentItem() {
    const item = assessmentItems[currentAssessmentIndex];
    const container = document.getElementById('assessment-item-container');
    
    // ì§„í–‰ë¥  ì—…ë°ì´íŠ¸
    const progressText = document.getElementById('progress-text');
    const progressBar = document.getElementById('progress-bar');
    const progress = ((currentAssessmentIndex) / assessmentItems.length) * 100;
    
    progressText.textContent = `${currentAssessmentIndex} / ${assessmentItems.length}`;
    progressBar.style.width = `${progress}%`;
    
    // í‰ê°€ í•­ëª© í‘œì‹œ
    container.innerHTML = `
        <div class="space-y-4">
            <div class="flex items-start gap-3">
                <span class="bg-blue-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                    ${currentAssessmentIndex + 1}/${assessmentItems.length}
                </span>
                ${item.category ? `
                    <span class="bg-purple-100 text-purple-800 px-3 py-1 rounded-full text-sm font-medium">
                        ${item.category}
                    </span>
                ` : ''}
            </div>
            <h3 class="text-2xl font-bold text-gray-800">${item.item_name}</h3>
            ${item.description ? `
                <p class="text-gray-600 text-lg leading-relaxed">${item.description}</p>
            ` : ''}
        </div>
    `;
}

function markAsSatisfied() {
    recordAssessment(true);
}

function markAsUnsatisfied() {
    recordAssessment(false);
}

function recordAssessment(satisfied) {
    const item = assessmentItems[currentAssessmentIndex];
    
    assessmentResults.push({
        item_id: item.id,
        item_name: item.item_name,
        category: item.category,
        satisfied: satisfied
    });
    
    currentAssessmentIndex++;
    
    if (currentAssessmentIndex < assessmentItems.length) {
        showAssessmentItem();
    } else {
        completeAssessment();
    }
}

async function completeAssessment() {
    const workerId = document.getElementById('sa-worker-select').value;
    const processId = document.getElementById('sa-process-select').value;
    
    // Levelë³„ë¡œ ê²°ê³¼ ì§‘ê³„
    const levelResults = {};
    
    assessmentResults.forEach(result => {
        const category = result.category || 'ê¸°íƒ€';
        
        // ì¹´í…Œê³ ë¦¬ì—ì„œ Level ì¶”ì¶œ (ì˜ˆ: "Level 2", "Level2", "L2" ë“±)
        let level = 'general';
        const levelMatch = category.match(/level\s*(\d+)/i) || category.match(/l(\d+)/i);
        if (levelMatch) {
            level = parseInt(levelMatch[1]);
        }
        
        if (!levelResults[level]) {
            levelResults[level] = {
                total: 0,
                satisfied: 0,
                items: []
            };
        }
        
        levelResults[level].total++;
        if (result.satisfied) {
            levelResults[level].satisfied++;
        }
        levelResults[level].items.push(result);
    });
    
    // ìµœì¢… ë ˆë²¨ ê²°ì •
    let finalLevel = 1;
    
    // Level 2ì˜ ëª¨ë“  í•­ëª©ì„ ë§Œì¡±í•˜ë©´ Level 2
    if (levelResults[2]) {
        if (levelResults[2].satisfied === levelResults[2].total) {
            finalLevel = 2;
            
            // Level 3 ì²´í¬
            if (levelResults[3] && levelResults[3].satisfied === levelResults[3].total) {
                finalLevel = 3;
                
                // Level 4 ì²´í¬
                if (levelResults[4] && levelResults[4].satisfied === levelResults[4].total) {
                    finalLevel = 4;
                }
            }
        }
    }
    
    // ì„œë²„ì— ê²°ê³¼ ì €ì¥
    try {
        const assessmentData = assessmentResults.map(result => ({
            item_id: result.item_id,
            level: finalLevel
        }));
        
        await axios.post('/api/supervisor-assessment-results', {
            worker_id: workerId,
            process_id: processId,
            assessments: assessmentData,
            final_level: finalLevel
        });
        
        // ê²°ê³¼ í‘œì‹œ
        showAssessmentComplete(levelResults, finalLevel);
        
    } catch (error) {
        console.error('Assessment ê²°ê³¼ ì €ì¥ ì‹¤íŒ¨:', error);
        alert('í‰ê°€ ê²°ê³¼ ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function showAssessmentComplete(levelResults, finalLevel) {
    document.getElementById('assessment-progress').classList.add('hidden');
    document.getElementById('assessment-complete').classList.remove('hidden');
    
    const summaryDiv = document.getElementById('assessment-summary');
    
    let summaryHTML = `
        <div class="text-center mb-6">
            <div class="text-5xl font-bold text-green-600 mb-2">Level ${finalLevel}</div>
            <p class="text-gray-600">ìµœì¢… í‰ê°€ ë ˆë²¨</p>
        </div>
        <div class="border-t-2 border-gray-200 pt-4">
            <h4 class="font-bold text-gray-800 mb-3">Levelë³„ í‰ê°€ ê²°ê³¼:</h4>
    `;
    
    Object.keys(levelResults).sort().forEach(level => {
        const result = levelResults[level];
        const percentage = ((result.satisfied / result.total) * 100).toFixed(1);
        const isAllSatisfied = result.satisfied === result.total;
        
        summaryHTML += `
            <div class="bg-white rounded-lg p-4 mb-3 border ${isAllSatisfied ? 'border-green-300' : 'border-gray-200'}">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-semibold ${isAllSatisfied ? 'text-green-700' : 'text-gray-700'}">
                        ${level === 'general' ? 'ì¼ë°˜ í•­ëª©' : 'Level ' + level}
                    </span>
                    <span class="text-sm ${isAllSatisfied ? 'text-green-600' : 'text-gray-600'}">
                        ${result.satisfied} / ${result.total} (${percentage}%)
                    </span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-${isAllSatisfied ? 'green' : 'blue'}-600 h-2 rounded-full" 
                         style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    });
    
    summaryHTML += `</div>`;
    
    summaryDiv.innerHTML = summaryHTML;
}

// ==================== ê²°ê³¼ ê´€ë¦¬ í˜ì´ì§€ ====================

function getResultManagementHTML() {
    return `
        <div class="bg-white rounded-lg shadow-md p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-file-excel mr-2"></i>
                í‰ê°€ ê²°ê³¼ ê´€ë¦¬
            </h2>
            
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Written Test ê²°ê³¼ ê´€ë¦¬ -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-pencil-alt mr-2"></i>
                        Written Test ê²°ê³¼
                    </h3>
                    
                    <div class="space-y-4">
                        <!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
                        <div class="bg-blue-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">
                                <i class="fas fa-download mr-2"></i>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
                            </h4>
                            
                            <div class="space-y-2">
                                <select id="test-entity-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">ì „ì²´ ë²•ì¸</option>
                                    <option value="CSVN">CSVN</option>
                                    <option value="CSCN">CSCN</option>
                                    <option value="CSTW">CSTW</option>
                                </select>
                                
                                <select id="test-process-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">ì „ì²´ í”„ë¡œì„¸ìŠ¤</option>
                                </select>
                                
                                <select id="test-download-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="summary">ìš”ì•½ (ì¹´í…Œê³ ë¦¬/í‰ê°€í•­ëª©/ë§Œì¡±ì—¬ë¶€)</option>
                                    <option value="detailed">ìƒì„¸ (ê°œë³„ ë¬¸ì œë³„ ë‹µë³€)</option>
                                </select>
                                
                                <button onclick="downloadWrittenTestResults()" 
                                        class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-file-download mr-2"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                        
                        <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">
                                <i class="fas fa-upload mr-2"></i>ê²°ê³¼ ì—…ë¡œë“œ
                            </h4>
                            
                            <div class="space-y-2">
                                <input type="file" 
                                       id="test-result-file" 
                                       accept=".xlsx, .xls"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                
                                <button onclick="uploadWrittenTestResults()" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-file-upload mr-2"></i>ì—‘ì…€ ì—…ë¡œë“œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Assessment ê²°ê³¼ ê´€ë¦¬ -->
                <div class="border border-gray-200 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-4">
                        <i class="fas fa-clipboard-check mr-2"></i>
                        Supervisor Assessment ê²°ê³¼
                    </h3>
                    
                    <div class="space-y-4">
                        <!-- ë‹¤ìš´ë¡œë“œ ì„¹ì…˜ -->
                        <div class="bg-purple-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">
                                <i class="fas fa-download mr-2"></i>ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
                            </h4>
                            
                            <div class="space-y-2">
                                <select id="assessment-entity-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">ì „ì²´ ë²•ì¸</option>
                                    <option value="CSVN">CSVN</option>
                                    <option value="CSCN">CSCN</option>
                                    <option value="CSTW">CSTW</option>
                                </select>
                                
                                <select id="assessment-process-filter" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="">ì „ì²´ í”„ë¡œì„¸ìŠ¤</option>
                                </select>
                                
                                <select id="assessment-download-type" class="w-full px-3 py-2 border border-gray-300 rounded-lg">
                                    <option value="summary">ìš”ì•½ (ì¹´í…Œê³ ë¦¬ë³„ í‰ê· )</option>
                                    <option value="detailed">ìƒì„¸ (ê°œë³„ í‰ê°€ í•­ëª©ë³„)</option>
                                </select>
                                
                                <button onclick="downloadAssessmentResults()" 
                                        class="w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-file-download mr-2"></i>ì—‘ì…€ ë‹¤ìš´ë¡œë“œ
                                </button>
                            </div>
                        </div>
                        
                        <!-- ì—…ë¡œë“œ ì„¹ì…˜ -->
                        <div class="bg-green-50 p-4 rounded-lg">
                            <h4 class="font-semibold text-gray-700 mb-3">
                                <i class="fas fa-upload mr-2"></i>ê²°ê³¼ ì—…ë¡œë“œ
                            </h4>
                            
                            <div class="space-y-2">
                                <input type="file" 
                                       id="assessment-result-file" 
                                       accept=".xlsx, .xls"
                                       class="w-full px-3 py-2 border border-gray-300 rounded-lg text-sm">
                                
                                <button onclick="uploadAssessmentResults()" 
                                        class="w-full bg-green-600 hover:bg-green-700 text-white font-bold py-2 px-4 rounded-lg transition">
                                    <i class="fas fa-file-upload mr-2"></i>ì—‘ì…€ ì—…ë¡œë“œ
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ì•ˆë‚´ ë©”ì‹œì§€ -->
            <div class="mt-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h4 class="font-semibold text-yellow-800 mb-2">
                    <i class="fas fa-info-circle mr-2"></i>ì‚¬ìš© ì•ˆë‚´
                </h4>
                <ul class="text-sm text-yellow-700 space-y-1">
                    <li>â€¢ ë‹¤ìš´ë¡œë“œ: ë²•ì¸ê³¼ í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì—¬ í•„í„°ë§ëœ ê²°ê³¼ë¥¼ ì—‘ì…€ë¡œ ë‹¤ìš´ë¡œë“œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</li>
                    <li>â€¢ ì—…ë¡œë“œ: ë‹¤ìš´ë¡œë“œí•œ ì—‘ì…€ íŒŒì¼ê³¼ ë™ì¼í•œ ì–‘ì‹ìœ¼ë¡œ ì‘ì„±í•˜ì—¬ ì—…ë¡œë“œí•˜ë©´ ê²°ê³¼ê°€ ì¼ê´„ ë“±ë¡ë©ë‹ˆë‹¤.</li>
                    <li>â€¢ Written Test: ì‚¬ë²ˆ, ì´ë¦„, ë²•ì¸, íŒ€, ì§ê¸‰, í”„ë¡œì„¸ìŠ¤ëª…, ì ìˆ˜, í•©ê²©ì—¬ë¶€, ì‹œí—˜ì¼ì</li>
                    <li>â€¢ Assessment: ì‚¬ë²ˆ, ì´ë¦„, ë²•ì¸, íŒ€, ì§ê¸‰, ì¹´í…Œê³ ë¦¬, í‰ê°€í•­ëª©, ë ˆë²¨, í‰ê°€ì¼ì</li>
                </ul>
            </div>
        </div>
    `;
}

async function loadResultManagementPage() {
    // í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ë¡œë“œ
    const testProcessFilter = document.getElementById('test-process-filter');
    const assessmentProcessFilter = document.getElementById('assessment-process-filter');
    
    if (testProcessFilter && assessmentProcessFilter) {
        processes.forEach(process => {
            const option1 = document.createElement('option');
            option1.value = process.id;
            option1.textContent = process.name;
            testProcessFilter.appendChild(option1);
            
            const option2 = document.createElement('option');
            option2.value = process.id;
            option2.textContent = process.name;
            assessmentProcessFilter.appendChild(option2);
        });
    }
}

// Written Test ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
async function downloadWrittenTestResults() {
    try {
        const entity = document.getElementById('test-entity-filter').value;
        const processId = document.getElementById('test-process-filter').value;
        const downloadType = document.getElementById('test-download-type').value;
        
        let url = downloadType === 'detailed' 
            ? '/api/results/written-test/detailed?' 
            : '/api/results/written-test?';
        
        if (entity) url += `entity=${entity}&`;
        if (processId) url += `processId=${processId}`;
        
        const response = await axios.get(url);
        const results = response.data;
        
        if (results.length === 0) {
            alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        let excelData;
        let fileName;
        
        if (downloadType === 'detailed') {
            // ìƒì„¸ ì–‘ì‹ (ê°œë³„ ë¬¸ì œë³„)
            excelData = results.map((r, index) => ({
                'No.': index + 1,
                'ì‚¬ë²ˆ': r.employee_id,
                'ì´ë¦„': r.name,
                'ë²•ì¸': r.entity,
                'íŒ€': r.team,
                'ì§ê¸‰': r.position,
                'í”„ë¡œì„¸ìŠ¤': r.process_name,
                'ë¬¸ì œ': r.question,
                'ì„ íƒë‹µì•ˆ': r.selected_answer,
                'ì •ë‹µ': r.correct_answer,
                'ì •ë‹µì—¬ë¶€': r.is_correct ? 'O' : 'X',
                'ì‹œí—˜ì¼ì': new Date(r.test_date).toLocaleDateString('ko-KR')
            }));
            fileName = `Written_Test_Detailed_${entity || 'All'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        } else {
            // ìš”ì•½ ì–‘ì‹ (ê°„ë‹¨)
            excelData = results.map((r, index) => ({
                'ì¹´í…Œê³ ë¦¬': r.process_name,
                'í‰ê°€ í•­ëª©': 'Written Test',
                'ë§Œì¡± ì—¬ë¶€': r.passed ? 'í•©ê²©' : 'ë¶ˆí•©ê²©'
            }));
            fileName = `Written_Test_Summary_${entity || 'All'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        }
        
        // ì›Œí¬ì‹œíŠ¸ ìƒì„±
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // ì—´ ë„ˆë¹„ ì„¤ì •
        if (downloadType === 'detailed') {
            ws['!cols'] = [
                { wch: 6 },   // No.
                { wch: 12 },  // ì‚¬ë²ˆ
                { wch: 15 },  // ì´ë¦„
                { wch: 10 },  // ë²•ì¸
                { wch: 20 },  // íŒ€
                { wch: 15 },  // ì§ê¸‰
                { wch: 15 },  // í”„ë¡œì„¸ìŠ¤
                { wch: 50 },  // ë¬¸ì œ
                { wch: 10 },  // ì„ íƒë‹µì•ˆ
                { wch: 10 },  // ì •ë‹µ
                { wch: 10 },  // ì •ë‹µì—¬ë¶€
                { wch: 15 }   // ì‹œí—˜ì¼ì
            ];
        } else {
            ws['!cols'] = [
                { wch: 25 },  // ì¹´í…Œê³ ë¦¬
                { wch: 25 },  // í‰ê°€ í•­ëª©
                { wch: 15 }   // ë§Œì¡± ì—¬ë¶€
            ];
        }
        
        // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš© (ë…¸ë€ìƒ‰ ë°°ê²½)
        applyExcelHeaderStyle(ws, true);
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        // ë°ì´í„° ì…€ ìŠ¤íƒ€ì¼ ì ìš©
        for (let row = range.s.r + 1; row <= range.e.r; row++) {
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                if (!ws[cellAddress]) continue;
                
                ws[cellAddress].s = {
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "D3D3D3" } },
                        bottom: { style: "thin", color: { rgb: "D3D3D3" } },
                        left: { style: "thin", color: { rgb: "D3D3D3" } },
                        right: { style: "thin", color: { rgb: "D3D3D3" } }
                    }
                };
                
                // ì¡°ê±´ë¶€ ìƒ‰ìƒ ì ìš©
                if (downloadType === 'detailed') {
                    // ì •ë‹µì—¬ë¶€ ì»¬ëŸ¼ (col 10)
                    if (col === 10) {
                        applyCellColorByValue(ws, row, col, ws[cellAddress].v, 'O', 'X');
                    }
                } else {
                    // ë§Œì¡± ì—¬ë¶€ ì»¬ëŸ¼ (col 2)
                    if (col === 2) {
                        applyCellColorByValue(ws, row, col, ws[cellAddress].v, 'í•©ê²©', 'ë¶ˆí•©ê²©');
                    }
                }
            }
        }
        
        // ì›Œí¬ë¶ ìƒì„± ë° ì‹œíŠ¸ ì¶”ê°€
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Written Test Results');
        
        // ë‹¤ìš´ë¡œë“œ
        XLSX.writeFile(wb, fileName);
        
        alert(`${results.length}ê±´ì˜ ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ê²°ê³¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Assessment ê²°ê³¼ ë‹¤ìš´ë¡œë“œ
async function downloadAssessmentResults() {
    try {
        const entity = document.getElementById('assessment-entity-filter').value;
        const processId = document.getElementById('assessment-process-filter').value;
        const downloadType = document.getElementById('assessment-download-type').value;
        
        let url = '/api/results/assessment?';
        if (entity) url += `entity=${entity}&`;
        if (processId) url += `processId=${processId}`;
        
        const response = await axios.get(url);
        const results = response.data;
        
        if (results.length === 0) {
            alert('ë‹¤ìš´ë¡œë“œí•  ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        let excelData;
        let fileName;
        
        if (downloadType === 'summary') {
            // ìš”ì•½ ì–‘ì‹ (ì¹´í…Œê³ ë¦¬ë³„ í‰ê· )
            const categoryMap = new Map();
            
            results.forEach(r => {
                const key = `${r.employee_id}_${r.category}`;
                if (!categoryMap.has(key)) {
                    categoryMap.set(key, {
                        employee_id: r.employee_id,
                        name: r.name,
                        entity: r.entity,
                        team: r.team,
                        position: r.position,
                        category: r.category,
                        levels: [],
                        assessment_date: r.assessment_date
                    });
                }
                categoryMap.get(key).levels.push(r.level);
            });
            
            excelData = Array.from(categoryMap.values()).map((item, index) => ({
                'No.': index + 1,
                'ì‚¬ë²ˆ': item.employee_id,
                'ì´ë¦„': item.name,
                'ë²•ì¸': item.entity,
                'íŒ€': item.team,
                'ì§ê¸‰': item.position,
                'ì¹´í…Œê³ ë¦¬': item.category,
                'í‰ê·  ë ˆë²¨': (item.levels.reduce((a, b) => a + b, 0) / item.levels.length).toFixed(1),
                'í‰ê°€ì¼ì': new Date(item.assessment_date).toLocaleDateString('ko-KR')
            }));
            
            fileName = `Assessment_Summary_${entity || 'All'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        } else {
            // ìƒì„¸ ì–‘ì‹ (ê°œë³„ í•­ëª©ë³„) - í”„ë¡œì„¸ìŠ¤ ì •ë³´ ì¶”ê°€
            excelData = results.map((r, index) => {
                // ë°ì´í„° ê²€ì¦
                const evaluationResult = convertLevelToResult(r.level);
                
                // ë””ë²„ê¹…: levelì´ null/undefinedì¸ ê²½ìš° ì½˜ì†”ì— ê²½ê³ 
                if (!evaluationResult || evaluationResult === 'N/A') {
                    console.warn(`Row ${index + 1}: Missing or invalid level`, {
                        employee_id: r.employee_id,
                        name: r.name,
                        item: r.item_name,
                        level: r.level
                    });
                }
                
                return {
                    'No.': index + 1,
                    'ì‚¬ë²ˆ': r.employee_id || '',
                    'ì´ë¦„': r.name || '',
                    'ë²•ì¸': r.entity || '',
                    'íŒ€': r.team || '',
                    'í”„ë¡œì„¸ìŠ¤': r.position || '',
                    'Lv ì¹´í…Œê³ ë¦¬': r.category || '',
                    'í‰ê°€í•­ëª©': r.item_name || '',
                    'í‰ê°€ ê²°ê³¼': evaluationResult,
                    'í‰ê°€ì¼ì': r.assessment_date ? new Date(r.assessment_date).toLocaleDateString('ko-KR') : ''
                };
            });
            
            fileName = `Assessment_Detailed_${entity || 'All'}_${new Date().toISOString().split('T')[0]}.xlsx`;
        }
        
        // ì›Œí¬ì‹œíŠ¸ ìƒì„±
        const ws = XLSX.utils.json_to_sheet(excelData);
        
        // ì—´ ë„ˆë¹„ ì„¤ì •
        const columnWidths = downloadType === 'summary' 
            ? [
                { wch: EXCEL_COLUMN_WIDTHS.NO },
                { wch: EXCEL_COLUMN_WIDTHS.EMPLOYEE_ID },
                { wch: EXCEL_COLUMN_WIDTHS.NAME },
                { wch: EXCEL_COLUMN_WIDTHS.ENTITY },
                { wch: EXCEL_COLUMN_WIDTHS.TEAM },
                { wch: EXCEL_COLUMN_WIDTHS.POSITION },
                { wch: EXCEL_COLUMN_WIDTHS.CATEGORY },
                { wch: EXCEL_COLUMN_WIDTHS.LEVEL },
                { wch: EXCEL_COLUMN_WIDTHS.DATE }
            ]
            : [
                { wch: EXCEL_COLUMN_WIDTHS.NO },
                { wch: EXCEL_COLUMN_WIDTHS.EMPLOYEE_ID },
                { wch: EXCEL_COLUMN_WIDTHS.NAME },
                { wch: EXCEL_COLUMN_WIDTHS.ENTITY },
                { wch: EXCEL_COLUMN_WIDTHS.TEAM },
                { wch: EXCEL_COLUMN_WIDTHS.POSITION },
                { wch: EXCEL_COLUMN_WIDTHS.LEVEL_CATEGORY },
                { wch: EXCEL_COLUMN_WIDTHS.ITEM_NAME },
                { wch: EXCEL_COLUMN_WIDTHS.RESULT },
                { wch: EXCEL_COLUMN_WIDTHS.DATE }
            ];
        
        ws['!cols'] = columnWidths;
        
        // í—¤ë” ìŠ¤íƒ€ì¼ ì ìš©
        applyExcelHeaderStyle(ws);
        const range = XLSX.utils.decode_range(ws['!ref']);
        
        // ë°ì´í„° ì…€ ìŠ¤íƒ€ì¼ ì ìš©
        for (let row = range.s.r + 1; row <= range.e.r; row++) {
            for (let col = range.s.c; col <= range.e.c; col++) {
                const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                if (!ws[cellAddress]) continue;
                
                ws[cellAddress].s = {
                    alignment: { horizontal: "center", vertical: "center" },
                    border: {
                        top: { style: "thin", color: { rgb: "D3D3D3" } },
                        bottom: { style: "thin", color: { rgb: "D3D3D3" } },
                        left: { style: "thin", color: { rgb: "D3D3D3" } },
                        right: { style: "thin", color: { rgb: "D3D3D3" } }
                    }
                };
                
                // ê²°ê³¼ë³„ ìƒ‰ìƒ ì ìš©
                if (downloadType === 'summary') {
                    // ìš”ì•½: í‰ê·  ë ˆë²¨ ì»¬ëŸ¼ (col 7)
                    if (col === 7) {
                        const value = parseFloat(ws[cellAddress].v);
                        if (value >= 4.5) {
                            ws[cellAddress].s.fill = { fgColor: { rgb: "C6EFCE" } };
                            ws[cellAddress].s.font = { color: { rgb: "006100" }, bold: true };
                        } else if (value >= 3.5) {
                            ws[cellAddress].s.fill = { fgColor: { rgb: "C6E0B4" } };
                        } else if (value >= 2.5) {
                            ws[cellAddress].s.fill = { fgColor: { rgb: "FFE699" } };
                        } else if (value >= 1.5) {
                            ws[cellAddress].s.fill = { fgColor: { rgb: "FFC7CE" } };
                        } else {
                            ws[cellAddress].s.fill = { fgColor: { rgb: "FFC7CE" } };
                            ws[cellAddress].s.font = { color: { rgb: "9C0006" }, bold: true };
                        }
                    }
                } else {
                    // ìƒì„¸: í‰ê°€ ê²°ê³¼ ì»¬ëŸ¼ (col 8)
                    if (col === 8) {
                        applyCellColorByValue(ws, row, col, ws[cellAddress].v, 'ë§Œì¡±', 'ë¶ˆë§Œì¡±');
                    }
                }
            }
        }
        
        // ì›Œí¬ë¶ ìƒì„± ë° ì‹œíŠ¸ ì¶”ê°€
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, 'Assessment Results');
        
        // ë‹¤ìš´ë¡œë“œ
        XLSX.writeFile(wb, fileName);
        
        alert(`${results.length}ê±´ì˜ ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
    } catch (error) {
        console.error('ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ê²°ê³¼ ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Written Test ê²°ê³¼ ì—…ë¡œë“œ
async function uploadWrittenTestResults() {
    const fileInput = document.getElementById('test-result-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            // ë°ì´í„° ë³€í™˜ (ìƒˆ ì–‘ì‹)
            const results = jsonData.map(row => ({
                process_name: row['ì¹´í…Œê³ ë¦¬'],
                passed: row['ë§Œì¡± ì—¬ë¶€'] === 'í•©ê²©'
            }));
            
            // ì—…ë¡œë“œ ë¶ˆê°€ ì•ˆë‚´
            alert('ê°„ë‹¨ ì–‘ì‹ì€ ì¡°íšŒ ì „ìš©ì…ë‹ˆë‹¤.\n\nì—…ë¡œë“œë¥¼ ì›í•˜ì‹œë©´ ë‹¤ìŒ ì»¬ëŸ¼ì„ í¬í•¨í•œ ì—‘ì…€ íŒŒì¼ì„ ì¤€ë¹„í•´ì£¼ì„¸ìš”:\n- ì‚¬ë²ˆ\n- í”„ë¡œì„¸ìŠ¤ëª…\n- ì ìˆ˜\n- í•©ê²©ì—¬ë¶€\n- ì‹œí—˜ì¼ì');
            fileInput.value = '';
        } catch (error) {
            console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            alert('ê²°ê³¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\níŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// Assessment ê²°ê³¼ ì—…ë¡œë“œ
async function uploadAssessmentResults() {
    const fileInput = document.getElementById('assessment-result-file');
    const file = fileInput.files[0];
    
    if (!file) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const reader = new FileReader();
    
    reader.onload = async function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const worksheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet);
            
            console.log(`ğŸ“ ì—‘ì…€ íŒŒì¼ ì½ê¸° ì™„ë£Œ: ${jsonData.length}í–‰`);
            console.log('ğŸ“‹ ì²« ë²ˆì§¸ í–‰:', jsonData[0]);
            console.log('ğŸ“… í‰ê°€ì¼ì ì›ë³¸ ê°’:', jsonData[0]['í‰ê°€ì¼ì'], 'íƒ€ì…:', typeof jsonData[0]['í‰ê°€ì¼ì']);
            
            // ë°ì´í„° ë³€í™˜
            const results = jsonData.map((row, index) => {
                // í‰ê°€ì¼ì íŒŒì‹± (ì•ˆì „í•œ íŒŒì‹±)
                let assessmentDate = new Date().toISOString().split('T')[0]; // ê¸°ë³¸ê°’: ì˜¤ëŠ˜
                const dateStr = row['í‰ê°€ì¼ì'];
                
                if (dateStr) {
                    try {
                        // Excelì—ì„œ ë‚ ì§œê°€ ìˆ«ìë¡œ ì˜¬ ê²½ìš° (ì˜ˆ: 45600)
                        if (typeof dateStr === 'number') {
                            console.log(`ğŸ“… ìˆ«ì ë‚ ì§œ ê°ì§€ (í–‰ ${index + 2}):`, dateStr);
                            // Excel ë‚ ì§œ í˜•ì‹ì„ JavaScript Dateë¡œ ë³€í™˜
                            const excelEpoch = new Date(1900, 0, 1);
                            const daysOffset = dateStr - 2;
                            const jsDate = new Date(excelEpoch.getTime() + daysOffset * 24 * 60 * 60 * 1000);
                            
                            // ìœ íš¨ì„± ê²€ì‚¬ í›„ ë³€í™˜
                            if (!isNaN(jsDate.getTime())) {
                                assessmentDate = jsDate.toISOString().split('T')[0];
                                console.log(`âœ… ë³€í™˜ ì™„ë£Œ:`, assessmentDate);
                            } else {
                                console.warn(`âš ï¸ ìˆ«ì ë‚ ì§œ ë³€í™˜ ì‹¤íŒ¨ (í–‰ ${index + 2}):`, dateStr);
                            }
                        } else {
                            // ë¬¸ìì—´ë¡œ ì˜¨ ê²½ìš°
                            console.log(`ğŸ“… ë¬¸ìì—´ ë‚ ì§œ ê°ì§€ (í–‰ ${index + 2}):`, dateStr);
                            let cleanDate = String(dateStr).trim();
                            
                            // "2025. 10. 28." í˜•ì‹ ì²˜ë¦¬
                            cleanDate = cleanDate.replace(/\./g, '-').replace(/\s+/g, '');
                            
                            // ë§ˆì§€ë§‰ í•˜ì´í”ˆ ì œê±°
                            if (cleanDate.endsWith('-')) {
                                cleanDate = cleanDate.slice(0, -1);
                            }
                            
                            console.log(`ğŸ”„ ì •ë¦¬ëœ ë‚ ì§œ ë¬¸ìì—´:`, cleanDate);
                            
                            // ë‚ ì§œ íŒŒì‹±
                            const parsedDate = new Date(cleanDate);
                            
                            if (!isNaN(parsedDate.getTime())) {
                                assessmentDate = parsedDate.toISOString().split('T')[0];
                                console.log(`âœ… ë³€í™˜ ì™„ë£Œ:`, assessmentDate);
                            } else {
                                console.warn(`âš ï¸ ë¬¸ìì—´ ë‚ ì§œ íŒŒì‹± ì‹¤íŒ¨ (í–‰ ${index + 2}): "${dateStr}" â†’ ì˜¤ëŠ˜ ë‚ ì§œ ì‚¬ìš©`);
                            }
                        }
                    } catch (error) {
                        console.warn(`âš ï¸ ë‚ ì§œ íŒŒì‹± ì˜ˆì™¸ (í–‰ ${index + 2}): "${dateStr}" â†’`, error.message);
                    }
                }
                
                return {
                    employee_id: String(row['ì‚¬ë²ˆ']).trim(),
                    process_name: String(row['í”„ë¡œì„¸ìŠ¤']).trim(),
                    category: String(row['Lv ì¹´í…Œê³ ë¦¬']).trim(),
                    item_name: String(row['í‰ê°€í•­ëª©']).trim(),
                    is_satisfied: row['í‰ê°€ ê²°ê³¼'] === 'ë§Œì¡±' ? 1 : 0,
                    assessment_date: assessmentDate
                };
            });
            
            console.log(`ğŸ”„ ë³€í™˜ ì™„ë£Œ: ${results.length}ê±´`);
            console.log('ğŸ“Š ë³€í™˜ëœ ì²« ë°ì´í„°:', results[0]);
            
            // ì„œë²„ì— ì—…ë¡œë“œ
            const response = await axios.post('/api/supervisor-assessment-results/bulk', results);
            
            alert(`âœ… ${response.data.success}ê±´ ì„±ê³µ\nâš ï¸ ${response.data.skipped}ê±´ ê±´ë„ˆëœ€\n\nìƒì„¸:\n${response.data.message || ''}`);
            fileInput.value = '';
            
            // í˜ì´ì§€ ìƒˆë¡œê³ ì¹¨í•˜ì—¬ ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
            if (response.data.success > 0) {
                setTimeout(() => {
                    location.reload();
                }, 1500);
            }
        } catch (error) {
            console.error('âŒ ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            alert(`ê²°ê³¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\nì˜¤ë¥˜: ${error.response?.data?.error || error.message}\n\níŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.`);
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// ==================== ì‹œí—˜ ì‘ì‹œ í˜ì´ì§€ ====================

function getTestPageHTML() {
    return `
        <div class="bg-white rounded-lg shadow-md p-8">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-pencil-alt mr-2"></i>
                Written Test ì‘ì‹œ
            </h2>
            
            <div id="test-selection" class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ë²•ì¸ ì„ íƒ</label>
                    <select id="entity-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500" onchange="filterWorkersByEntity()">
                        <option value="">ë²•ì¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">ì‘ì—…ì ì„ íƒ</label>
                    <select id="worker-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">í”„ë¡œì„¸ìŠ¤ ì„ íƒ</label>
                    <select id="process-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                        <option value="">í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
                    </select>
                </div>
                
                <button onclick="startTest()" 
                        class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition">
                    <i class="fas fa-play mr-2"></i>
                    ì‹œí—˜ ì‹œì‘
                </button>
            </div>
            
            <div id="test-content" class="hidden">
                <div id="quiz-container" class="space-y-6"></div>
                
                <button onclick="submitTest()" 
                        class="mt-6 bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition">
                    <i class="fas fa-check mr-2"></i>
                    ì œì¶œí•˜ê¸°
                </button>
            </div>
        </div>
        
        <!-- Written Test ê²°ê³¼ ë“±ë¡ ì„¹ì…˜ -->
        <div class="bg-white rounded-lg shadow-md p-8 mt-6">
            <h2 class="text-3xl font-bold text-gray-800 mb-6">
                <i class="fas fa-file-excel mr-2"></i>
                Written Test ê²°ê³¼ ë“±ë¡
            </h2>
            
            <div class="mb-6">
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4">
                    <p class="text-sm text-blue-700 mb-2">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>ì—‘ì…€ íŒŒì¼ í˜•ì‹:</strong> No., ì‚¬ë²ˆ, ì´ë¦„, ë²•ì¸, íŒ€, ì§ê¸‰, í”„ë¡œì„¸ìŠ¤, ë¬¸ì œ, ì„ íƒë‹µì•ˆ, ì •ë‹µ, ì •ë‹µì—¬ë¶€, ì‹œí—˜ì¼ì
                    </p>
                    <p class="text-sm text-blue-700">
                        <i class="fas fa-lightbulb mr-2"></i>
                        ê¸°ì¡´ì— ì§„í–‰í•œ Written Test ê²°ê³¼ë¥¼ ì¼ê´„ ë“±ë¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                    </p>
                </div>
                
                <label class="block text-gray-700 font-semibold mb-2">
                    ì—‘ì…€ íŒŒì¼ ì„ íƒ
                </label>
                <input type="file" id="test-result-file" accept=".xlsx,.xls" 
                       class="block w-full text-sm text-gray-500
                              file:mr-4 file:py-2 file:px-4
                              file:rounded-lg file:border-0
                              file:text-sm file:font-semibold
                              file:bg-green-50 file:text-green-700
                              hover:file:bg-green-100
                              cursor-pointer">
            </div>
            
            <button onclick="uploadTestResults()" 
                    class="bg-green-500 hover:bg-green-600 text-white font-semibold py-3 px-8 rounded-lg shadow-md transition">
                <i class="fas fa-upload mr-2"></i>
                ê²°ê³¼ ì—…ë¡œë“œ
            </button>
        </div>
    `;
}

let currentQuizzes = [];
let selectedAnswers = {};

async function loadTestPage() {
    // ë²•ì¸ ëª©ë¡ ë¡œë“œ (ì‘ì—…ì DBì—ì„œ ê³ ìœ í•œ ë²•ì¸ ì¶”ì¶œ)
    const entitySelect = document.getElementById('entity-select');
    if (entitySelect && workers.length > 0) {
        // ê³ ìœ í•œ ë²•ì¸ ëª©ë¡ ì¶”ì¶œ ë° ì •ë ¬
        const uniqueEntities = [...new Set(workers.map(w => w.entity))].sort();
        
        uniqueEntities.forEach(entity => {
            const option = document.createElement('option');
            option.value = entity;
            option.textContent = entity;
            entitySelect.appendChild(option);
        });
    }
    
    // í”„ë¡œì„¸ìŠ¤ ëª©ë¡ ë¡œë“œ (Drilling ì œì™¸, Quizê°€ ìˆëŠ” í”„ë¡œì„¸ìŠ¤ë§Œ)
    const processSelect = document.getElementById('process-select');
    if (processSelect) {
        // Quizê°€ ë“±ë¡ëœ í”„ë¡œì„¸ìŠ¤ í™•ì¸
        const processesWithQuiz = [];
        
        for (const process of processes) {
            // Drilling ì œì™¸
            if (process.name === 'Drilling') continue;
            
            try {
                const response = await axios.get(`/api/quizzes/${process.id}`);
                if (response.data.length > 0) {
                    processesWithQuiz.push(process);
                }
            } catch (error) {
                console.error(`í”„ë¡œì„¸ìŠ¤ ${process.name} Quiz í™•ì¸ ì‹¤íŒ¨:`, error);
            }
        }
        
        processesWithQuiz.forEach(process => {
            const option = document.createElement('option');
            option.value = process.id;
            option.textContent = process.name;
            processSelect.appendChild(option);
        });
        
        if (processesWithQuiz.length === 0) {
            processSelect.innerHTML += '<option value="" disabled>ë“±ë¡ëœ Quizê°€ ì—†ìŠµë‹ˆë‹¤</option>';
        }
    }
}

function filterWorkersByEntity() {
    const entitySelect = document.getElementById('entity-select');
    const workerSelect = document.getElementById('worker-select');
    const selectedEntity = entitySelect.value;
    
    // ì‘ì—…ì ì„ íƒ ì´ˆê¸°í™”
    workerSelect.innerHTML = '<option value="">ì‘ì—…ìë¥¼ ì„ íƒí•˜ì„¸ìš”</option>';
    
    if (!selectedEntity) {
        return;
    }
    
    // ì„ íƒëœ ë²•ì¸ì˜ ì‘ì—…ìë§Œ í•„í„°ë§
    const filteredWorkers = workers.filter(worker => worker.entity === selectedEntity);
    
    filteredWorkers.forEach(worker => {
        const option = document.createElement('option');
        option.value = worker.id;
        option.textContent = `${worker.name} (${worker.employee_id})`;
        workerSelect.appendChild(option);
    });
    
    if (filteredWorkers.length === 0) {
        workerSelect.innerHTML += '<option value="" disabled>í•´ë‹¹ ë²•ì¸ì— ë“±ë¡ëœ ì‘ì—…ìê°€ ì—†ìŠµë‹ˆë‹¤</option>';
    }
}

async function startTest() {
    const entityId = document.getElementById('entity-select').value;
    const workerId = document.getElementById('worker-select').value;
    const processId = document.getElementById('process-select').value;
    
    if (!entityId) {
        alert('ë²•ì¸ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    if (!workerId || !processId) {
        alert('ì‘ì—…ìì™€ í”„ë¡œì„¸ìŠ¤ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    try {
        const response = await axios.get(`/api/quizzes/${processId}`);
        currentQuizzes = response.data;
        
        if (currentQuizzes.length === 0) {
            alert('í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì— ë“±ë¡ëœ í€´ì¦ˆê°€ ì—†ìŠµë‹ˆë‹¤.');
            return;
        }
        
        selectedAnswers = {};
        document.getElementById('test-selection').classList.add('hidden');
        document.getElementById('test-content').classList.remove('hidden');
        
        renderQuizzes();
    } catch (error) {
        console.error('í€´ì¦ˆ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('í€´ì¦ˆë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function renderQuizzes() {
    const container = document.getElementById('quiz-container');
    container.innerHTML = '';
    
    currentQuizzes.forEach((quiz, index) => {
        const quizDiv = document.createElement('div');
        quizDiv.className = 'bg-gray-50 p-6 rounded-lg border border-gray-200';
        quizDiv.innerHTML = `
            <h3 class="font-bold text-lg mb-4">${index + 1}. ${quiz.question}</h3>
            <div class="space-y-2">
                <label class="flex items-center p-3 bg-white rounded-lg hover:bg-blue-50 cursor-pointer">
                    <input type="radio" name="quiz-${quiz.id}" value="A" 
                           onchange="selectAnswer(${quiz.id}, 'A')"
                           class="mr-3 w-4 h-4">
                    <span>A. ${quiz.option_a}</span>
                </label>
                <label class="flex items-center p-3 bg-white rounded-lg hover:bg-blue-50 cursor-pointer">
                    <input type="radio" name="quiz-${quiz.id}" value="B" 
                           onchange="selectAnswer(${quiz.id}, 'B')"
                           class="mr-3 w-4 h-4">
                    <span>B. ${quiz.option_b}</span>
                </label>
                ${quiz.option_c ? `
                    <label class="flex items-center p-3 bg-white rounded-lg hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="quiz-${quiz.id}" value="C" 
                               onchange="selectAnswer(${quiz.id}, 'C')"
                               class="mr-3 w-4 h-4">
                        <span>C. ${quiz.option_c}</span>
                    </label>
                ` : ''}
                ${quiz.option_d ? `
                    <label class="flex items-center p-3 bg-white rounded-lg hover:bg-blue-50 cursor-pointer">
                        <input type="radio" name="quiz-${quiz.id}" value="D" 
                               onchange="selectAnswer(${quiz.id}, 'D')"
                               class="mr-3 w-4 h-4">
                        <span>D. ${quiz.option_d}</span>
                    </label>
                ` : ''}
            </div>
        `;
        container.appendChild(quizDiv);
    });
}

function selectAnswer(quizId, answer) {
    selectedAnswers[quizId] = answer;
}

async function submitTest() {
    const workerId = document.getElementById('worker-select').value;
    const processId = document.getElementById('process-select').value;
    
    // ëª¨ë“  ë¬¸ì œì— ë‹µí–ˆëŠ”ì§€ í™•ì¸
    if (Object.keys(selectedAnswers).length !== currentQuizzes.length) {
        alert('ëª¨ë“  ë¬¸ì œì— ë‹µí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    // ì±„ì  ë° ë‹µì•ˆ ì •ë³´ ìˆ˜ì§‘
    let correctCount = 0;
    const answers = [];
    
    currentQuizzes.forEach(quiz => {
        const isCorrect = selectedAnswers[quiz.id] === quiz.correct_answer;
        if (isCorrect) {
            correctCount++;
        }
        
        answers.push({
            quiz_id: quiz.id,
            selected_answer: selectedAnswers[quiz.id],
            is_correct: isCorrect
        });
    });
    
    const score = (correctCount / currentQuizzes.length) * 100;
    const passed = score >= 60; // 60ì  ì´ìƒ í•©ê²©
    
    try {
        await axios.post('/api/test-results', {
            worker_id: parseInt(workerId),
            process_id: parseInt(processId),
            score: score,
            passed: passed,
            answers: answers
        });
        
        alert(`ì‹œí—˜ ì™„ë£Œ!\nì ìˆ˜: ${score.toFixed(1)}ì \nê²°ê³¼: ${passed ? 'í•©ê²©' : 'ë¶ˆí•©ê²©'}`);
        
        // ì´ˆê¸°í™”
        document.getElementById('test-selection').classList.remove('hidden');
        document.getElementById('test-content').classList.add('hidden');
        document.getElementById('entity-select').value = '';
        document.getElementById('worker-select').value = '';
        document.getElementById('process-select').value = '';
    } catch (error) {
        console.error('ì‹œí—˜ ê²°ê³¼ ì œì¶œ ì‹¤íŒ¨:', error);
        alert('ì‹œí—˜ ê²°ê³¼ ì œì¶œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// Written Test ê²°ê³¼ ì¼ê´„ ì—…ë¡œë“œ
async function uploadTestResults() {
    const fileInput = document.getElementById('test-result-file');
    if (!fileInput.files.length) {
        alert('íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
        return;
    }
    
    const file = fileInput.files[0];
    const reader = new FileReader();
    
    reader.onload = async (e) => {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const rows = XLSX.utils.sheet_to_json(firstSheet);
            
            console.log('ğŸ“Š ì—…ë¡œë“œëœ í–‰ ìˆ˜:', rows.length);
            console.log('ğŸ“„ ì²« ë²ˆì§¸ í–‰:', rows[0]);
            
            if (rows.length === 0) {
                alert('ì—‘ì…€ íŒŒì¼ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }
            
            // í”„ë¡œì„¸ìŠ¤ ë§¤í•‘ (ëŒ€ì†Œë¬¸ì êµ¬ë¶„ ì—†ì´)
            const processesResponse = await axios.get('/api/processes');
            const processMap = {};
            processesResponse.data.forEach(p => {
                processMap[p.name.toUpperCase().trim()] = p.id;
            });
            
            // ì‘ì—…ì ë§¤í•‘ (ë²•ì¸ + ì‚¬ë²ˆ ê¸°ì¤€)
            const workersResponse = await axios.get('/api/workers');
            const workerMap = {};
            workersResponse.data.forEach(w => {
                // ë²•ì¸ + ì‚¬ë²ˆì„ í‚¤ë¡œ ì‚¬ìš©
                const key = `${w.entity}-${w.employee_id.toString()}`;
                workerMap[key] = w.id;
            });
            
            console.log('ğŸ‘¥ ì‘ì—…ì ë§¤í•‘ ìƒ˜í”Œ:', Object.keys(workerMap).slice(0, 5));
            
            // ê²°ê³¼ ë°ì´í„° ë³€í™˜
            const results = rows.map(row => {
                const employeeId = row['ì‚¬ë²ˆ']?.toString();
                const entity = row['ë²•ì¸']?.toString().trim();
                const processName = (row['í”„ë¡œì„¸ìŠ¤'] || '').toString().trim().toUpperCase();
                
                // ë²•ì¸ + ì‚¬ë²ˆìœ¼ë¡œ ì‘ì—…ì ì°¾ê¸°
                const workerKey = `${entity}-${employeeId}`;
                const workerId = workerMap[workerKey];
                const processId = processMap[processName];
                
                if (!workerId) {
                    console.warn(`âŒ ì‘ì—…ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${entity} - ì‚¬ë²ˆ ${employeeId}`);
                }
                if (!processId) {
                    console.warn(`âŒ í”„ë¡œì„¸ìŠ¤ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ: ${row['í”„ë¡œì„¸ìŠ¤']}`);
                }
                
                return {
                    worker_id: workerId,
                    process_id: processId,
                    question: row['ë¬¸ì œ'],
                    selected_answer: row['ì„ íƒë‹µì•ˆ'],
                    correct_answer: row['ì •ë‹µ'],
                    is_correct: row['ì •ë‹µì—¬ë¶€'] === 'O',
                    test_date: row['ì‹œí—˜ì¼ì'] ? new Date(row['ì‹œí—˜ì¼ì']).toISOString() : new Date().toISOString()
                };
            }).filter(r => r.worker_id && r.process_id); // worker_idì™€ process_idê°€ ìˆëŠ” ê²ƒë§Œ
            
            console.log('âœ… ë³€í™˜ëœ ê²°ê³¼ ìˆ˜:', results.length);
            
            if (results.length === 0) {
                alert('ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.\n\nì‘ì—…ì ì‚¬ë²ˆê³¼ í”„ë¡œì„¸ìŠ¤ ì´ë¦„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // ì„œë²„ì— ì—…ë¡œë“œ
            const response = await axios.post('/api/test-results/bulk', results);
            
            alert(`âœ… ${response.data.count}ê±´ì˜ ê²°ê³¼ë¥¼ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤.`);
            fileInput.value = '';
            
        } catch (error) {
            console.error('ì—…ë¡œë“œ ì‹¤íŒ¨:', error);
            let errorMessage = 'ê²°ê³¼ ì—…ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.\n\n';
            
            if (error.response?.data?.error) {
                errorMessage += `ì˜¤ë¥˜: ${error.response.data.error}`;
            } else {
                errorMessage += `ì˜¤ë¥˜: ${error.message}`;
            }
            
            alert(errorMessage);
        }
    };
    
    reader.readAsArrayBuffer(file);
}

// ==================== Analysis Page ====================

let categoryChart = null;
let assessmentChart = null;
let allWorkers = []; // ì „ì—­ ë³€ìˆ˜ë¡œ ì„ ì–¸

async function showAnalysisPage() {
    const html = `
        <div class="bg-white rounded-lg shadow p-6">
            <h2 class="text-2xl font-bold mb-6 flex items-center">
                <i class="fas fa-chart-line mr-2 text-blue-600"></i>
                í‰ê°€ ê²°ê³¼ ë¶„ì„
            </h2>
            
            <!-- ë²•ì¸ ë° ì‘ì—…ì ì„ íƒ -->
            <div class="mb-6 grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-building mr-1"></i>ë²•ì¸ ì„ íƒ
                    </label>
                    <select id="analysis-entity-select" class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none">
                        <option value="">ë²•ì¸ì„ ì„ íƒí•˜ì„¸ìš”</option>
                        <option value="CSVN">CSVN</option>
                        <option value="CSCN">CSCN</option>
                        <option value="CSTW">CSTW</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">
                        <i class="fas fa-user mr-1"></i>ì‘ì—…ì ì„ íƒ (ì‚¬ë²ˆ ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰)
                    </label>
                    <div class="relative">
                        <input 
                            type="text" 
                            id="analysis-worker-search" 
                            placeholder="ë²•ì¸ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”" 
                            class="w-full border-2 border-gray-300 rounded-lg px-4 py-2 focus:border-blue-500 focus:outline-none" 
                            disabled
                            autocomplete="off"
                        />
                        <div 
                            id="analysis-worker-dropdown" 
                            class="hidden absolute z-10 w-full border-2 border-blue-400 rounded-lg mt-1 bg-white shadow-xl max-h-80 overflow-y-auto"
                            style="top: 100%;"
                        >
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- ë¶„ì„ ê²°ê³¼ ì˜ì—­ -->
            <div id="analysis-results" class="hidden">
                <!-- ì‘ì—…ì ì •ë³´ -->
                <div id="worker-info" class="mb-6 p-4 bg-blue-50 rounded-lg border-l-4 border-blue-500"></div>
                
                <!-- í‰ê°€ ìœ í˜• ì„ íƒ íƒ­ -->
                <div class="mb-6 border-b border-gray-200">
                    <nav class="flex space-x-8" aria-label="Tabs">
                        <button id="tab-written-test" onclick="switchAnalysisTab('written-test')" 
                                class="analysis-tab border-b-2 border-blue-500 text-blue-600 py-4 px-1 font-medium">
                            <i class="fas fa-file-alt mr-2"></i>Written Test ê²°ê³¼
                        </button>
                        <button id="tab-assessment" onclick="switchAnalysisTab('assessment')" 
                                class="analysis-tab border-b-2 border-transparent text-gray-500 hover:text-gray-700 hover:border-gray-300 py-4 px-1 font-medium">
                            <i class="fas fa-clipboard-check mr-2"></i>Supervisor Assessment
                        </button>
                    </nav>
                </div>
                
                <!-- Written Test íƒ­ ë‚´ìš© -->
                <div id="content-written-test" class="analysis-tab-content">
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Written Test ê²°ê³¼ ëª©ë¡</h3>
                        </div>
                        <div id="test-results-list" class="space-y-2"></div>
                    </div>
                    
                    <!-- Written Test ìƒì„¸ ë¶„ì„ -->
                    <div id="test-analysis" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Written Test ìƒì„¸ ë¶„ì„</h3>
                            <button onclick="closeTestAnalysis()" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-times mr-1"></i>ë‹«ê¸°
                            </button>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6 space-y-6">
                            <!-- í‰ê·  ë¹„êµ ì°¨íŠ¸ -->
                            <div>
                                <h4 class="text-lg font-semibold mb-3">ë²•ì¸ í‰ê·  ëŒ€ë¹„ ì ìˆ˜</h4>
                                <div class="max-w-2xl">
                                    <canvas id="comparison-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- ì¹´í…Œê³ ë¦¬ë³„ ì˜¤ê°í˜• ì°¨íŠ¸ -->
                            <div>
                                <h4 class="text-lg font-semibold mb-3">ì˜ì—­ë³„ ì„±ì·¨ë„ (ì¹´í…Œê³ ë¦¬ ë¶„ì„)</h4>
                                <div class="max-w-md mx-auto">
                                    <canvas id="category-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨ -->
                            <div id="training-recommendations">
                                <h4 class="text-lg font-semibold mb-3">ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨</h4>
                                <div id="training-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Supervisor Assessment íƒ­ ë‚´ìš© -->
                <div id="content-assessment" class="analysis-tab-content hidden">
                    <div class="mb-6">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Supervisor Assessment ê²°ê³¼ ëª©ë¡</h3>
                        </div>
                        <div id="assessment-results-list" class="space-y-2"></div>
                    </div>
                    
                    <!-- Supervisor Assessment ìƒì„¸ ë¶„ì„ -->
                    <div id="assessment-analysis" class="hidden">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-xl font-bold">Supervisor Assessment ìƒì„¸ ë¶„ì„</h3>
                            <button onclick="closeAssessmentAnalysis()" class="text-gray-600 hover:text-gray-800">
                                <i class="fas fa-times mr-1"></i>ë‹«ê¸°
                            </button>
                        </div>
                        
                        <div class="bg-gray-50 rounded-lg p-6 space-y-6">
                            <!-- ë ˆë²¨ í‰ê°€ ì¹´í…Œê³ ë¦¬ ì°¨íŠ¸ -->
                            <div>
                                <h4 class="text-lg font-semibold mb-3">ì˜ì—­ë³„ í‰ê°€ ìˆ˜ì¤€ (ì¹´í…Œê³ ë¦¬ ë¶„ì„)</h4>
                                <div class="max-w-md mx-auto">
                                    <canvas id="assessment-radar-chart"></canvas>
                                </div>
                            </div>
                            
                            <!-- ì˜í•˜ê³  ìˆëŠ” ë¶€ë¶„ / ì·¨ì•½í•œ ë¶€ë¶„ -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <!-- ì˜í•˜ê³  ìˆëŠ” ë¶€ë¶„ -->
                                <div class="bg-white rounded-lg p-6 border-l-4 border-green-500">
                                    <h4 class="text-lg font-semibold mb-3">
                                        <i class="fas fa-thumbs-up mr-2 text-green-600"></i>ì˜í•˜ê³  ìˆëŠ” ë¶€ë¶„
                                    </h4>
                                    <div id="assessment-strengths" class="space-y-2"></div>
                                </div>
                                
                                <!-- ì·¨ì•½í•œ ë¶€ë¶„ -->
                                <div class="bg-white rounded-lg p-6 border-l-4 border-red-500">
                                    <h4 class="text-lg font-semibold mb-3">
                                        <i class="fas fa-exclamation-triangle mr-2 text-red-600"></i>ì·¨ì•½í•œ ë¶€ë¶„
                                    </h4>
                                    <div id="assessment-weaknesses" class="space-y-2"></div>
                                </div>
                            </div>
                            
                            <!-- ë‹¤ìŒ ë ˆë²¨ ë‹¬ì„±ì„ ìœ„í•œ ê°œì„ ì  -->
                            <div id="assessment-next-level" class="bg-white rounded-lg p-6 border-l-4 border-yellow-500">
                                <h4 class="text-lg font-semibold mb-3">
                                    <i class="fas fa-arrow-up mr-2 text-yellow-600"></i>ë‹¤ìŒ ë ˆë²¨ ë‹¬ì„±ì„ ìœ„í•œ ê°œì„ ì 
                                </h4>
                                <div id="assessment-improvement" class="space-y-3"></div>
                            </div>
                            
                            <!-- ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨ -->
                            <div id="assessment-training">
                                <h4 class="text-lg font-semibold mb-3">ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨</h4>
                                <div id="assessment-training-list" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    document.getElementById('app').innerHTML = html;
    
    // allWorkers ì´ˆê¸°í™”
    allWorkers = [];
    
    // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ë“±ë¡
    document.getElementById('analysis-entity-select').addEventListener('change', loadAnalysisWorkers);
    
    // ì‘ì—…ì ê²€ìƒ‰ ê¸°ëŠ¥ (ì•„ë˜ë¡œ ì—´ë¦¬ëŠ” ë“œë¡­ë‹¤ìš´)
    const searchInput = document.getElementById('analysis-worker-search');
    const dropdown = document.getElementById('analysis-worker-dropdown');
    
    searchInput.addEventListener('focus', () => {
        console.log('Search input focused, allWorkers:', allWorkers.length);
        if (!searchInput.disabled && allWorkers.length > 0) {
            renderWorkerDropdown(allWorkers);
        }
    });
    
    searchInput.addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        console.log('Search term:', searchTerm);
        if (searchTerm === '') {
            if (allWorkers.length > 0) {
                renderWorkerDropdown(allWorkers);
            }
        } else {
            const filtered = allWorkers.filter(w => 
                w.employee_id.toLowerCase().includes(searchTerm) || 
                w.name.toLowerCase().includes(searchTerm)
            );
            console.log('Filtered workers:', filtered.length);
            renderWorkerDropdown(filtered);
        }
    });
    
    // ì™¸ë¶€ í´ë¦­ ì‹œ ë“œë¡­ë‹¤ìš´ ë‹«ê¸°
    const handleOutsideClick = (e) => {
        if (dropdown && !searchInput.contains(e.target) && !dropdown.contains(e.target)) {
            dropdown.classList.add('hidden');
        }
    };
    
    // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€ (ì¤‘ë³µ ë°©ì§€)
    document.removeEventListener('click', handleOutsideClick);
    document.addEventListener('click', handleOutsideClick);
}

function renderWorkerDropdown(workers) {
    const dropdown = document.getElementById('analysis-worker-dropdown');
    
    if (!dropdown) {
        console.error('Dropdown element not found');
        return;
    }
    
    console.log('Rendering worker dropdown with', workers.length, 'workers');
    
    if (workers.length === 0) {
        dropdown.innerHTML = '<div class="px-4 py-2 text-gray-500">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</div>';
        dropdown.classList.remove('hidden');
        return;
    }
    
    const html = workers.map(worker => `
        <div class="px-4 py-2 hover:bg-blue-50 cursor-pointer worker-option" 
             data-worker-id="${worker.id}"
             data-worker-name="[${worker.employee_id}] ${worker.name}">
            <div class="font-medium">[${worker.employee_id}] ${worker.name}</div>
            <div class="text-xs text-gray-500">${worker.team} | ${worker.position}</div>
        </div>
    `).join('');
    
    dropdown.innerHTML = html;
    dropdown.classList.remove('hidden');
    console.log('Dropdown should now be visible');
    
    // ê° ì˜µì…˜ì— í´ë¦­ ì´ë²¤íŠ¸ ì¶”ê°€
    dropdown.querySelectorAll('.worker-option').forEach(option => {
        option.addEventListener('click', () => {
            const workerId = option.dataset.workerId;
            const workerName = option.dataset.workerName;
            console.log('Worker selected:', workerId, workerName);
            document.getElementById('analysis-worker-search').value = workerName;
            dropdown.classList.add('hidden');
            loadWorkerAnalysis(workerId);
        });
    });
}

// íƒ­ ì „í™˜ í•¨ìˆ˜
function switchAnalysisTab(tabName) {
    // ëª¨ë“  íƒ­ ë¹„í™œì„±í™”
    document.querySelectorAll('.analysis-tab').forEach(tab => {
        tab.classList.remove('border-blue-500', 'text-blue-600');
        tab.classList.add('border-transparent', 'text-gray-500');
    });
    
    // ëª¨ë“  ì»¨í…ì¸  ìˆ¨ê¸°ê¸°
    document.querySelectorAll('.analysis-tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // ì„ íƒëœ íƒ­ í™œì„±í™”
    const selectedTab = document.getElementById(`tab-${tabName}`);
    selectedTab.classList.remove('border-transparent', 'text-gray-500');
    selectedTab.classList.add('border-blue-500', 'text-blue-600');
    
    // ì„ íƒëœ ì»¨í…ì¸  í‘œì‹œ
    document.getElementById(`content-${tabName}`).classList.remove('hidden');
}

// ë¶„ì„ ë‹«ê¸° í•¨ìˆ˜ë“¤
function closeTestAnalysis() {
    document.getElementById('test-analysis').classList.add('hidden');
    
    // ì°¨íŠ¸ íŒŒê´´
    if (categoryChart) {
        categoryChart.destroy();
        categoryChart = null;
    }
}

function closeAssessmentAnalysis() {
    document.getElementById('assessment-analysis').classList.add('hidden');
    
    // ì°¨íŠ¸ íŒŒê´´
    if (assessmentChart) {
        assessmentChart.destroy();
        assessmentChart = null;
    }
}

async function loadAnalysisWorkers() {
    const entity = document.getElementById('analysis-entity-select').value;
    const dropdown = document.getElementById('analysis-worker-dropdown');
    const searchInput = document.getElementById('analysis-worker-search');
    
    if (!entity) {
        allWorkers = [];
        dropdown.innerHTML = '';
        dropdown.classList.add('hidden');
        searchInput.value = '';
        searchInput.placeholder = 'ë²•ì¸ì„ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”';
        searchInput.disabled = true;
        document.getElementById('analysis-results').classList.add('hidden');
        return;
    }
    
    try {
        const response = await axios.get(`/api/analysis/workers?entity=${entity}`);
        allWorkers = response.data;
        
        console.log('Loaded workers:', allWorkers.length, 'workers');
        
        searchInput.disabled = false;
        searchInput.value = '';
        searchInput.placeholder = 'ì‚¬ë²ˆ ë˜ëŠ” ì´ë¦„ìœ¼ë¡œ ê²€ìƒ‰í•˜ì„¸ìš” (ì˜ˆ: 4136 ë˜ëŠ” DÆ°Æ¡ng)';
        dropdown.classList.add('hidden');
        document.getElementById('analysis-results').classList.add('hidden');
        
        console.log('Worker search enabled with', allWorkers.length, 'workers');
    } catch (error) {
        console.error('ì‘ì—…ì ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì‘ì—…ì ëª©ë¡ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

// í˜„ì¬ ì„ íƒëœ ì‘ì—…ì ì •ë³´ ì €ì¥
let currentWorkerData = null;

async function loadWorkerAnalysis(workerId) {
    if (!workerId) {
        document.getElementById('analysis-results').classList.add('hidden');
        return;
    }
    
    console.log('Loading analysis for worker ID:', workerId);
    
    try {
        const response = await axios.get(`/api/analysis/worker/${workerId}`);
        const data = response.data;
        
        // ì „ì—­ ë³€ìˆ˜ì— ì €ì¥
        currentWorkerData = data;
        
        // ì‘ì—…ì ì •ë³´ í‘œì‹œ
        displayWorkerInfo(data.worker);
        
        // Written Test ê²°ê³¼ ëª©ë¡ í‘œì‹œ
        displayTestResults(data.test_results);
        
        // Assessment ê²°ê³¼ ëª©ë¡ í‘œì‹œ
        displayAssessmentResultsList(data.assessments, data.process_info);
        
        // ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        document.getElementById('analysis-results').classList.remove('hidden');
        
        // ê¸°ë³¸ì ìœ¼ë¡œ Written Test íƒ­ ì„ íƒ
        switchAnalysisTab('written-test');
    } catch (error) {
        console.error('ì‘ì—…ì ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('ì‘ì—…ì ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function displayWorkerInfo(worker) {
    const html = `
        <div class="flex items-center justify-between">
            <div>
                <h3 class="text-xl font-bold">${worker.name}</h3>
                <p class="text-gray-600">ì‚¬ë²ˆ: ${worker.employee_id} | ë²•ì¸: ${worker.entity} | íŒ€: ${worker.team} | ì§ê¸‰: ${worker.position}</p>
            </div>
        </div>
    `;
    document.getElementById('worker-info').innerHTML = html;
}

function displayTestResults(testResults) {
    const container = document.getElementById('test-results-list');
    
    if (!testResults || testResults.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Written Test ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    const html = testResults.map((result, index) => `
        <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" onclick="showTestAnalysis(${result.id}, '${result.process_name}', ${result.process_id}, ${result.score}, ${result.worker_id})">
            <div class="flex justify-between items-center">
                <div>
                    <span class="font-semibold">${result.process_name}</span>
                    <span class="ml-4 text-gray-600">ì ìˆ˜: ${result.score.toFixed(1)}ì </span>
                    <span class="ml-2 px-2 py-1 rounded text-sm ${result.passed ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'}">
                        ${result.passed ? 'í•©ê²©' : 'ë¶ˆí•©ê²©'}
                    </span>
                </div>
                <button class="text-blue-600 hover:text-blue-800">
                    <i class="fas fa-chart-bar mr-1"></i>ìƒì„¸ ë¶„ì„
                </button>
            </div>
        </div>
    `).join('');
    
    container.innerHTML = html;
}

function displayAssessmentResultsList(assessments, processInfo) {
    const container = document.getElementById('assessment-results-list');
    
    if (!assessments || assessments.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Supervisor Assessment ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    // í”„ë¡œì„¸ìŠ¤ë³„ë¡œ ê·¸ë£¹í™”
    const groupedByProcess = {};
    assessments.forEach(assessment => {
        const processId = assessment.process_id;
        if (!groupedByProcess[processId]) {
            groupedByProcess[processId] = [];
        }
        groupedByProcess[processId].push(assessment);
    });
    
    const html = Object.entries(groupedByProcess).map(([processId, items]) => {
        const processName = items[0].process_name || 'ì¼ë°˜ í‰ê°€';
        const latestDate = new Date(Math.max(...items.map(i => new Date(i.latest_date))));
        const year = latestDate.getFullYear();
        const avgLevel = (items.reduce((sum, i) => sum + i.avg_level, 0) / items.length).toFixed(1);
        
        return `
            <div class="border rounded-lg p-4 hover:bg-gray-50 cursor-pointer" 
                 onclick="showAssessmentAnalysis(${processId}, '${processName}')">
                <div class="flex justify-between items-center">
                    <div>
                        <span class="font-semibold">${processName}</span>
                        <span class="ml-4 text-gray-600">${year}ë…„ í‰ê°€</span>
                        <span class="ml-4 text-gray-600">í‰ê·  ë ˆë²¨: ${avgLevel}</span>
                        <span class="ml-2 px-2 py-1 rounded text-sm bg-purple-100 text-purple-800">
                            ${items.length}ê°œ ì¹´í…Œê³ ë¦¬
                        </span>
                    </div>
                    <button class="text-blue-600 hover:text-blue-800">
                        <i class="fas fa-chart-bar mr-1"></i>ìƒì„¸ ë¶„ì„
                    </button>
                </div>
            </div>
        `;
    }).join('');
    
    container.innerHTML = html;
}

async function showAssessmentAnalysis(processId, processName) {
    const workerId = currentWorkerData.worker.id;
    
    // í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ assessment ë°ì´í„° í•„í„°ë§
    const assessmentData = currentWorkerData.assessments.filter(a => a.process_id === processId);
    
    if (assessmentData.length === 0) {
        alert('í‰ê°€ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
        return;
    }
    
    // ìƒì„¸ ë¶„ì„ ì˜ì—­ í‘œì‹œ
    document.getElementById('assessment-analysis').classList.remove('hidden');
    
    // ë ˆì´ë” ì°¨íŠ¸ ê·¸ë¦¬ê¸°
    drawAssessmentRadarChart(assessmentData, processName);
    
    // ì˜í•˜ëŠ” ë¶€ë¶„ê³¼ ì·¨ì•½í•œ ë¶€ë¶„ ë¶„ì„
    displayStrengthsAndWeaknesses(assessmentData);
    
    // ë‹¤ìŒ ë ˆë²¨ ë‹¬ì„±ì„ ìœ„í•œ ë¶„ì„
    displayNextLevelAnalysis(assessmentData, processId, processName);
    
    // ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨
    await displayAssessmentTraining(assessmentData, processId);
}

function drawAssessmentRadarChart(assessmentData, processName) {
    const ctx = document.getElementById('assessment-radar-chart');
    
    // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
    if (assessmentChart) {
        assessmentChart.destroy();
    }
    
    const labels = assessmentData.map(a => a.category);
    const data = assessmentData.map(a => a.avg_level);
    
    assessmentChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: labels,
            datasets: [{
                label: processName + ' í‰ê°€',
                data: data,
                backgroundColor: 'rgba(139, 92, 246, 0.2)',
                borderColor: 'rgba(139, 92, 246, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(139, 92, 246, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(139, 92, 246, 1)',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.2,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    min: 0,
                    ticks: {
                        stepSize: 1,
                        callback: function(value) {
                            return value.toFixed(1);
                        }
                    },
                    pointLabels: {
                        font: {
                            size: 12,
                            weight: 'bold'
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: true,
                    position: 'top',
                    labels: {
                        font: {
                            size: 13,
                            weight: 'bold'
                        }
                    }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.dataset.label + ': ' + context.parsed.r.toFixed(1) + ' / 5.0';
                        }
                    }
                }
            }
        }
    });
}

function displayStrengthsAndWeaknesses(assessmentData) {
    const strengthsContainer = document.getElementById('assessment-strengths');
    const weaknessesContainer = document.getElementById('assessment-weaknesses');
    
    // í‰ê·  ë ˆë²¨ ê³„ì‚°
    const avgLevel = assessmentData.reduce((sum, a) => sum + a.avg_level, 0) / assessmentData.length;
    
    // ì˜í•˜ëŠ” ë¶€ë¶„ (í‰ê·  ì´ìƒ + ë ˆë²¨ 3.5 ì´ìƒ)
    const strengths = assessmentData
        .filter(a => a.avg_level >= 3.5 && a.avg_level >= avgLevel)
        .sort((a, b) => b.avg_level - a.avg_level)
        .slice(0, 5); // ìƒìœ„ 5ê°œ
    
    // ì·¨ì•½í•œ ë¶€ë¶„ (í‰ê·  ì´í•˜ ë˜ëŠ” ë ˆë²¨ 3.0 ë¯¸ë§Œ)
    const weaknesses = assessmentData
        .filter(a => a.avg_level < avgLevel || a.avg_level < 3.0)
        .sort((a, b) => a.avg_level - b.avg_level)
        .slice(0, 5); // í•˜ìœ„ 5ê°œ
    
    // ì˜í•˜ëŠ” ë¶€ë¶„ í‘œì‹œ
    if (strengths.length === 0) {
        strengthsContainer.innerHTML = `
            <p class="text-gray-500 text-center py-4">
                <i class="fas fa-info-circle mr-2"></i>
                í˜„ì¬ ìš°ìˆ˜í•œ ì¹´í…Œê³ ë¦¬ê°€ ì—†ìŠµë‹ˆë‹¤.<br>
                ì „ë°˜ì ì¸ ì‹¤ë ¥ í–¥ìƒì´ í•„ìš”í•©ë‹ˆë‹¤.
            </p>
        `;
    } else {
        const strengthsHtml = strengths.map((item, index) => `
            <div class="flex items-center gap-3 p-3 bg-green-50 rounded-lg border border-green-200">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-green-500 text-white flex items-center justify-center font-bold">
                    ${index + 1}
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-800">${item.category}</div>
                    <div class="text-sm text-gray-600">${item.item_count}ê°œ í•­ëª© í‰ê°€</div>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold text-green-600">${item.avg_level.toFixed(1)}</div>
                    <div class="text-xs text-gray-500">/ 5.0</div>
                </div>
            </div>
        `).join('');
        
        strengthsContainer.innerHTML = strengthsHtml;
    }
    
    // ì·¨ì•½í•œ ë¶€ë¶„ í‘œì‹œ
    if (weaknesses.length === 0) {
        weaknessesContainer.innerHTML = `
            <p class="text-gray-500 text-center py-4">
                <i class="fas fa-check-circle mr-2 text-green-500"></i>
                ëª¨ë“  ì¹´í…Œê³ ë¦¬ì—ì„œ ìš°ìˆ˜í•œ ì„±ê³¼ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤!
            </p>
        `;
    } else {
        const weaknessesHtml = weaknesses.map((item, index) => `
            <div class="flex items-center gap-3 p-3 bg-red-50 rounded-lg border border-red-200">
                <div class="flex-shrink-0 w-8 h-8 rounded-full bg-red-500 text-white flex items-center justify-center font-bold">
                    ${index + 1}
                </div>
                <div class="flex-1">
                    <div class="font-semibold text-gray-800">${item.category}</div>
                    <div class="text-sm text-gray-600">${item.item_count}ê°œ í•­ëª© í‰ê°€</div>
                </div>
                <div class="text-right">
                    <div class="text-xl font-bold text-red-600">${item.avg_level.toFixed(1)}</div>
                    <div class="text-xs text-gray-500">/ 5.0</div>
                </div>
            </div>
        `).join('');
        
        weaknessesContainer.innerHTML = weaknessesHtml;
    }
}

function displayNextLevelAnalysis(assessmentData, processId, processName) {
    const container = document.getElementById('assessment-improvement');
    
    // í‰ê·  ë ˆë²¨ ê³„ì‚°
    const avgLevel = assessmentData.reduce((sum, a) => sum + a.avg_level, 0) / assessmentData.length;
    const currentLevel = Math.floor(avgLevel);
    const nextLevel = currentLevel + 1;
    
    if (nextLevel > 5) {
        container.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-trophy text-yellow-500 text-4xl mb-2"></i>
                <p class="text-lg font-semibold text-gray-800">ìµœê³  ë ˆë²¨ì— ë„ë‹¬í–ˆìŠµë‹ˆë‹¤!</p>
                <p class="text-gray-600 mt-2">í˜„ì¬ í‰ê·  ë ˆë²¨: ${avgLevel.toFixed(1)} / 5.0</p>
                <p class="text-gray-600">ëª¨ë“  ì˜ì—­ì—ì„œ ìš°ìˆ˜í•œ ì„±ê³¼ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.</p>
            </div>
        `;
        return;
    }
    
    // ì•½í•œ ì¹´í…Œê³ ë¦¬ ì°¾ê¸° (í‰ê· ë³´ë‹¤ ë‚®ì€ í•­ëª©)
    const weakCategories = assessmentData
        .filter(a => a.avg_level < avgLevel)
        .sort((a, b) => a.avg_level - b.avg_level)
        .slice(0, 3);
    
    // ê°œì„ ì´ í•„ìš”í•œ ì¹´í…Œê³ ë¦¬
    const needImprovement = assessmentData
        .filter(a => a.avg_level < nextLevel)
        .sort((a, b) => a.avg_level - b.avg_level);
    
    let html = `
        <div class="mb-4">
            <div class="flex items-center justify-between mb-2">
                <span class="text-gray-700 font-medium">í˜„ì¬ í‰ê·  ë ˆë²¨:</span>
                <span class="text-2xl font-bold text-blue-600">${avgLevel.toFixed(1)} / 5.0</span>
            </div>
            <div class="flex items-center justify-between">
                <span class="text-gray-700 font-medium">ëª©í‘œ ë ˆë²¨:</span>
                <span class="text-2xl font-bold text-green-600">Level ${nextLevel}</span>
            </div>
        </div>
        
        <div class="border-t pt-4">
            <h5 class="font-semibold text-gray-800 mb-3">
                <i class="fas fa-exclamation-triangle text-yellow-500 mr-2"></i>
                ê°œì„ ì´ í•„ìš”í•œ ì˜ì—­ (${needImprovement.length}ê°œ)
            </h5>
            <div class="space-y-2">
    `;
    
    needImprovement.forEach(cat => {
        const gap = nextLevel - cat.avg_level;
        const percentage = (cat.avg_level / nextLevel) * 100;
        
        html += `
            <div class="bg-white p-3 rounded border">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-medium text-gray-800">${cat.category}</span>
                    <span class="text-sm text-gray-600">í˜„ì¬: ${cat.avg_level.toFixed(1)} / ëª©í‘œ: ${nextLevel}.0</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-yellow-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
                <p class="text-xs text-gray-600 mt-1">
                    <i class="fas fa-arrow-up text-green-500 mr-1"></i>
                    ${gap.toFixed(1)}ì  í–¥ìƒ í•„ìš”
                </p>
            </div>
        `;
    });
    
    html += `
            </div>
        </div>
    `;
    
    if (weakCategories.length > 0) {
        html += `
            <div class="border-t pt-4 mt-4">
                <h5 class="font-semibold text-gray-800 mb-3">
                    <i class="fas fa-chart-line text-red-500 mr-2"></i>
                    ìƒëŒ€ì ìœ¼ë¡œ ì•½í•œ ì˜ì—­
                </h5>
                <ul class="space-y-2">
        `;
        
        weakCategories.forEach((cat, index) => {
            html += `
                <li class="flex items-center text-gray-700">
                    <span class="w-6 h-6 rounded-full bg-red-100 text-red-800 text-xs flex items-center justify-center mr-2">${index + 1}</span>
                    <span class="font-medium">${cat.category}</span>
                    <span class="ml-auto text-sm text-gray-600">${cat.avg_level.toFixed(1)} / 5.0</span>
                </li>
            `;
        });
        
        html += `
                </ul>
            </div>
        `;
    }
    
    container.innerHTML = html;
}

async function displayAssessmentTraining(assessmentData, processId) {
    const container = document.getElementById('assessment-training-list');
    
    // ì•½í•œ ì¹´í…Œê³ ë¦¬ë“¤ ì°¾ê¸°
    const avgLevel = assessmentData.reduce((sum, a) => sum + a.avg_level, 0) / assessmentData.length;
    const weakCategories = assessmentData
        .filter(a => a.avg_level < avgLevel)
        .map(a => a.category);
    
    if (weakCategories.length === 0) {
        container.innerHTML = '<p class="text-gray-500 col-span-2">ëª¨ë“  ì˜ì—­ì—ì„œ ìš°ìˆ˜í•œ ì„±ê³¼ë¥¼ ë³´ì´ê³  ìˆìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    try {
        // ì•½í•œ ì¹´í…Œê³ ë¦¬ë“¤ì— ëŒ€í•œ êµìœ¡ í”„ë¡œê·¸ë¨ ì¡°íšŒ
        const promises = weakCategories.map(category => 
            axios.get(`/api/analysis/training-recommendations?processId=${processId}&weakCategory=${encodeURIComponent(category)}`)
        );
        
        const responses = await Promise.all(promises);
        const allTrainings = responses.flatMap(r => r.data);
        
        // ì¤‘ë³µ ì œê±°
        const uniqueTrainings = Array.from(new Map(allTrainings.map(t => [t.id, t])).values());
        
        if (uniqueTrainings.length === 0) {
            container.innerHTML = '<p class="text-gray-500 col-span-2">ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        const html = uniqueTrainings.map(training => `
            <div class="border rounded-lg p-4 bg-white hover:shadow-md transition">
                <div class="flex items-start justify-between mb-2">
                    <h5 class="font-semibold text-gray-800">${training.title}</h5>
                    <span class="px-2 py-1 text-xs rounded-full bg-purple-100 text-purple-800">${training.duration_hours}ì‹œê°„</span>
                </div>
                <p class="text-sm text-gray-600 mb-2">${training.description || 'ì„¤ëª… ì—†ìŒ'}</p>
                <div class="flex items-center justify-between text-xs">
                    <span class="text-gray-500">
                        <i class="fas fa-bullseye mr-1"></i>${training.category}
                    </span>
                    <span class="text-blue-600">
                        <i class="fas fa-arrow-up mr-1"></i>${training.target_weakness}
                    </span>
                </div>
            </div>
        `).join('');
        
        container.innerHTML = html;
    } catch (error) {
        console.error('êµìœ¡ í”„ë¡œê·¸ë¨ ì¡°íšŒ ì‹¤íŒ¨:', error);
        container.innerHTML = '<p class="text-red-500 col-span-2">êµìœ¡ í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
}

async function showTestAnalysis(resultId, processName, processId, score, workerId) {
    // ì‘ì—…ì ì •ë³´ì—ì„œ ë²•ì¸ ê°€ì ¸ì˜¤ê¸°
    const entity = currentWorkerData ? currentWorkerData.worker.entity : document.getElementById('analysis-entity-select').value;
    
    try {
        // í•´ë‹¹ ë²•ì¸, í•´ë‹¹ í”„ë¡œì„¸ìŠ¤ì˜ í‰ê·  ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        const avgResponse = await axios.get(`/api/analysis/entity-average?entity=${entity}&processId=${processId}`);
        const entityAverage = avgResponse.data.average_score;
        
        // í‰ê·  ë¹„êµ ì°¨íŠ¸ ê·¸ë¦¬ê¸° (ë²•ì¸ëª…ê³¼ í”„ë¡œì„¸ìŠ¤ëª… í¬í•¨)
        drawComparisonChart(processName, score, entityAverage, entity);
        
        // ì¹´í…Œê³ ë¦¬ë³„ ì ìˆ˜ ê°€ì ¸ì˜¤ê¸°
        const categoryResponse = await axios.get(`/api/analysis/test-categories/${resultId}`);
        const categoryScores = categoryResponse.data;
        
        // ì˜¤ê°í˜• ì°¨íŠ¸ ê·¸ë¦¬ê¸°
        drawCategoryChart(categoryScores);
        
        // ê°€ì¥ ë‚®ì€ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
        const weakestCategory = categoryScores.reduce((min, item) => 
            parseFloat(item.score) < parseFloat(min.score) ? item : min
        );
        
        // ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨ ê°€ì ¸ì˜¤ê¸°
        const trainingResponse = await axios.get(`/api/analysis/training-recommendations?processId=${processId}&weakCategory=${weakestCategory.category}`);
        const trainings = trainingResponse.data;
        
        // ì¶”ì²œ êµìœ¡ í‘œì‹œ
        displayTrainingRecommendations(trainings, weakestCategory.category);
        
        document.getElementById('test-analysis').classList.remove('hidden');
    } catch (error) {
        console.error('í…ŒìŠ¤íŠ¸ ë¶„ì„ ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
        alert('í…ŒìŠ¤íŠ¸ ë¶„ì„ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
    }
}

function drawComparisonChart(processName, workerScore, entityAverage, entity) {
    const ctx = document.getElementById('comparison-chart');
    
    // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
    if (window.comparisonChartInstance) {
        window.comparisonChartInstance.destroy();
    }
    
    window.comparisonChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['ë‚´ ì ìˆ˜', `${entity} ${processName} í‰ê· `],
            datasets: [{
                label: processName + ' ì ìˆ˜',
                data: [workerScore, entityAverage],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(156, 163, 175, 0.8)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(156, 163, 175, 1)'
                ],
                borderWidth: 1
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 2.5,
            scales: {
                y: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        callback: function(value) {
                            return value + 'ì ';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.y.toFixed(1) + 'ì ';
                        }
                    }
                },
                datalabels: {
                    anchor: 'end',
                    align: 'end',
                    formatter: (value) => parseFloat(value).toFixed(1) + 'ì ',
                    font: {
                        weight: 'bold'
                    }
                }
            }
        }
    });
}

function drawCategoryChart(categoryScores) {
    const ctx = document.getElementById('category-chart');
    
    // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
    if (categoryChart) {
        categoryChart.destroy();
    }
    
    const categories = categoryScores.map(item => item.category);
    const scores = categoryScores.map(item => parseFloat(item.score));
    
    categoryChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: categories,
            datasets: [{
                label: 'ì˜ì—­ë³„ ì ìˆ˜',
                data: scores,
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(59, 130, 246, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.2,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 100,
                    ticks: {
                        stepSize: 20,
                        callback: function(value) {
                            return value + 'ì ';
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return context.parsed.r.toFixed(1) + 'ì ';
                        }
                    }
                }
            }
        }
    });
}

function displayTrainingRecommendations(trainings, weakCategory) {
    const container = document.getElementById('training-list');
    
    if (!trainings || trainings.length === 0) {
        container.innerHTML = '<p class="text-gray-500">ì¶”ì²œ êµìœ¡ í”„ë¡œê·¸ë¨ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    const html = `
        <div class="col-span-full mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500">
            <p class="font-semibold text-yellow-800">
                <i class="fas fa-exclamation-triangle mr-2"></i>
                "${weakCategory}" ì˜ì—­ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤. ë‹¤ìŒ êµìœ¡ì„ ì¶”ì²œí•©ë‹ˆë‹¤:
            </p>
        </div>
        ${trainings.map(training => `
            <div class="border rounded-lg p-4 hover:shadow-md transition">
                <div class="flex items-start justify-between mb-2">
                    <h5 class="font-semibold text-lg">${training.title}</h5>
                    <span class="px-2 py-1 bg-blue-100 text-blue-800 text-sm rounded">${training.category}</span>
                </div>
                <p class="text-gray-600 text-sm mb-2">${training.description || ''}</p>
                <div class="flex items-center text-sm text-gray-500">
                    <i class="fas fa-clock mr-1"></i>
                    ${training.duration_hours}ì‹œê°„
                </div>
            </div>
        `).join('')}
    `;
    
    container.innerHTML = html;
}

function displayAssessmentResults(assessments, processInfo) {
    if (!assessments || assessments.length === 0) {
        document.getElementById('assessment-analysis').classList.add('hidden');
        return;
    }
    
    console.log('Assessment data:', assessments);
    
    // ì¹´í…Œê³ ë¦¬ë³„ í‰ê·  ë ˆë²¨ì„ ì°¨íŠ¸ ë°ì´í„°ë¡œ ë³€í™˜
    drawAssessmentChart(assessments);
    displayAssessmentTraining(assessments, processInfo);
    
    document.getElementById('assessment-analysis').classList.remove('hidden');
}

function drawAssessmentChart(assessments) {
    const ctx = document.getElementById('assessment-chart');
    
    // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´
    if (assessmentChart) {
        assessmentChart.destroy();
    }
    
    // ì¹´í…Œê³ ë¦¬ë³„ í‰ê·  ë ˆë²¨ ë°ì´í„°ë¡œ ì°¨íŠ¸ ìƒì„±
    // assessmentsëŠ” [{category, avg_level, ...}, ...] í˜•ì‹
    const categories = assessments.map(item => item.category);
    const scores = assessments.map(item => item.avg_level);
    
    assessmentChart = new Chart(ctx, {
        type: 'radar',
        data: {
            labels: categories,
            datasets: [{
                label: 'Assessment ë ˆë²¨',
                data: scores,
                backgroundColor: 'rgba(34, 197, 94, 0.2)',
                borderColor: 'rgba(34, 197, 94, 1)',
                borderWidth: 2,
                pointBackgroundColor: 'rgba(34, 197, 94, 1)',
                pointBorderColor: '#fff',
                pointHoverBackgroundColor: '#fff',
                pointHoverBorderColor: 'rgba(34, 197, 94, 1)'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            aspectRatio: 1.2,
            scales: {
                r: {
                    beginAtZero: true,
                    max: 5,
                    ticks: {
                        stepSize: 1
                    }
                }
            },
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return 'Level ' + context.parsed.r.toFixed(1);
                        }
                    }
                }
            }
        }
    });
}

async function displayAssessmentTraining(assessments, processInfo) {
    const container = document.getElementById('assessment-training-list');
    
    if (!assessments || assessments.length === 0) {
        container.innerHTML = '<p class="text-gray-500">Assessment ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
        return;
    }
    
    // ê°€ì¥ ë‚®ì€ í‰ê·  ë ˆë²¨ì˜ ì¹´í…Œê³ ë¦¬ ì°¾ê¸°
    const weakest = assessments.reduce((min, item) => 
        item.avg_level < min.avg_level ? item : min
    );
    
    try {
        const processId = weakest.process_id || (processInfo ? processInfo.id : null);
        
        if (!processId) {
            container.innerHTML = '<p class="text-gray-500">í”„ë¡œì„¸ìŠ¤ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
            return;
        }
        
        // ì¹´í…Œê³ ë¦¬ë¥¼ êµìœ¡ í”„ë¡œê·¸ë¨ ì¹´í…Œê³ ë¦¬ë¡œ ë§¤í•‘
        let trainingCategory = weakest.category;
        if (weakest.category.includes('Level')) {
            // Level2, Level3, Level4 -> ê¸°ìˆ ë¡œ ë§¤í•‘
            trainingCategory = 'ê¸°ìˆ ';
        }
        
        const response = await axios.get(`/api/analysis/training-recommendations?processId=${processId}&weakCategory=${trainingCategory}`);
        const trainings = response.data;
        
        const html = `
            <div class="col-span-full mb-4 p-4 bg-yellow-50 border-l-4 border-yellow-500">
                <p class="font-semibold text-yellow-800">
                    <i class="fas fa-exclamation-triangle mr-2"></i>
                    "${weakest.category}" ì˜ì—­ì´ ê°€ì¥ ë‚®ìŠµë‹ˆë‹¤ (í‰ê·  ë ˆë²¨ ${weakest.avg_level.toFixed(1)}). ë‹¤ìŒ êµìœ¡ì„ ì¶”ì²œí•©ë‹ˆë‹¤:
                </p>
            </div>
            ${trainings.map(training => `
                <div class="border rounded-lg p-4 hover:shadow-md transition">
                    <div class="flex items-start justify-between mb-2">
                        <h5 class="font-semibold text-lg">${training.title}</h5>
                        <span class="px-2 py-1 bg-green-100 text-green-800 text-sm rounded">${training.category}</span>
                    </div>
                    <p class="text-gray-600 text-sm mb-2">${training.description || ''}</p>
                    <div class="flex items-center text-sm text-gray-500">
                        <i class="fas fa-clock mr-1"></i>
                        ${training.duration_hours}ì‹œê°„
                    </div>
                </div>
            `).join('')}
        `;
        
        container.innerHTML = html;
    } catch (error) {
        console.error('Assessment êµìœ¡ ì¶”ì²œ ë¡œë“œ ì‹¤íŒ¨:', error);
        container.innerHTML = '<p class="text-gray-500">êµìœ¡ í”„ë¡œê·¸ë¨ì„ ë¶ˆëŸ¬ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>';
    }
}
